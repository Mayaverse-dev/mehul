<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Pledge - MAYA</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto:wght@700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            min-height: 100vh;
        }

        /* Navbar */
        #navbar {
            background: #1a1a1a;
            padding: 10px 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        .logo-container {
            height: 30px;
            width: auto;
        }

        .logo-container img {
            height: 100%;
            width: auto;
            object-fit: contain;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 20px;
            color: #ffffff;
            font-size: 14px;
        }

        .nav-right a {
            color: #ffffff;
            text-decoration: none;
            font-weight: 500;
        }

        .nav-right a:hover {
            opacity: 0.7;
        }

        .cart-button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 19px;
            padding: 5px;
            position: relative;
        }

        .cart-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #059669;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 11px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Main Content */
        .main-content {
            padding: 100px 20px 60px;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Pledge Card */
        .pledge-card {
            background: #1e1e1e;
            border-radius: 16px;
            padding: 40px;
            margin-bottom: 30px;
        }

        .pledge-title {
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            font-size: 32px;
            color: #ffffff;
            margin-bottom: 30px;
            letter-spacing: -0.96px;
        }

        .pledge-hero {
            width: 100%;
            height: 500px;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #0a0a0a;
        }

        .pledge-hero img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .pledge-badge {
            display: inline-block;
            background: #059669;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .section-label {
            color: #ffffff;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .items-text {
            color: #ffffff;
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 30px;
        }

        .divider {
            border: none;
            border-top: 2px solid #d9d9d9;
            margin: 30px 0;
        }

        /* Product Thumbnails */
        .product-thumbnails {
            display: flex;
            gap: 30px;
            justify-content: center;
            margin: 40px 0;
        }

        .thumbnail-item {
            flex: 0 0 140px;
            text-align: center;
        }

        .thumbnail-item img {
            width: 100%;
            height: 140px;
            object-fit: contain;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .thumbnail-label {
            font-size: 14px;
            color: #ffffff;
            font-weight: 500;
        }

        /* View Cart Button */
        .btn-cart {
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 11px;
            padding: 18px 50px;
            font-size: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
            display: block;
            margin: 0 auto;
            text-decoration: none;
            text-align: center;
        }

        .btn-cart:hover {
            opacity: 0.9;
        }

        /* Progress Info */
        .progress-info {
            text-align: center;
            margin-top: 40px;
            padding: 30px;
            background: #1e1e1e;
            border-radius: 12px;
        }

        .progress-info h3 {
            color: #ffffff;
            margin-bottom: 10px;
            font-size: 20px;
        }

        .progress-info p {
            color: #ffffff;
            margin-bottom: 20px;
        }

        .btn-secondary {
            background: #059669;
            color: #ffffff;
            border: 2px solid #059669;
            border-radius: 10px;
            padding: 14px 40px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-secondary:hover {
            background: #047857;
            border-color: #047857;
            color: white;
        }

        @media (max-width: 768px) {
            #navbar {
                padding: 10px 20px;
            }

            .main-content {
                padding: 80px 15px 40px;
            }

            .pledge-card {
                padding: 24px;
            }

            .pledge-title {
                font-size: 24px;
            }

            .product-thumbnails {
                flex-wrap: wrap;
                gap: 20px;
            }

            .thumbnail-item {
                flex: 0 0 120px;
            }
        }
    </style>
</head>
<body style="background: #0a0a0a !important; color: #ffffff !important;">
    <!-- Navbar -->
    <div id="navbar">
        <div class="logo-container">
            <a href="/dashboard">
                <img src="/images/maya-logo.png" alt="MAYA">
            </a>
            </div>
        <div class="nav-right">
            <button onclick="window.location.href='/addons'" class="cart-button" title="Cart" style="display: flex; align-items: center; position: relative;">
                <img src="/images/icons/cart-01.svg" alt="Cart" style="height: 24px; width: 24px;">
                <span id="cart-badge" class="cart-badge" style="display: none;">0</span>
            </button>
            <span id="user-email"></span>
            <span>|</span>
            <a href="/logout">Logout</a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Pledge Card -->
        <div class="pledge-card">
            <!-- Hero Image -->
            <div class="pledge-hero">
                <img src="https://www.figma.com/api/mcp/asset/985bdfee-d9bd-4b65-8a3a-e4e2ae217dac" alt="Your Pledge" id="pledge-image">
            </div>

            <!-- Badge -->
            <div class="pledge-badge">$<span id="pledge-amount-badge">0</span> PAID</div>

            <!-- Items Section -->
            <div class="section-label">ITEMS INCLUDED</div>
            <div class="items-text" id="items-list">
                Loading your pledge items...
            </div>

        </div>

        <!-- Upgrade Pledge Section -->
        <div id="upgrade-pledges-section" style="margin-top: 60px; display: none;">
            <h2 style="font-family: 'Roboto', sans-serif; font-weight: 700; font-size: 40px; text-align: center; margin-bottom: 16px; color: #ffffff;">Upgrade Your Pledge</h2>
            <p style="text-align: center; color: #ffffff; font-size: 18px; margin-bottom: 50px;">Unlock more exclusive items by upgrading</p>

            <!-- Upgrade Pledges Accordion -->
            <div id="upgrade-pledges-grid" style="display: flex; flex-direction: column; gap: 20px; margin-bottom: 60px; max-width: 1200px; margin-left: auto; margin-right: auto;">
                <!-- Upgrade pledges will be loaded here -->
            </div>
        </div>

        <!-- Add-ons Section -->
        <div style="margin-top: 60px;">
            <h2 style="font-family: 'Roboto', sans-serif; font-weight: 700; font-size: 40px; text-align: center; margin-bottom: 16px; color: #ffffff;">Free and Paid Add-ons</h2>
            <p style="text-align: center; color: #ffffff; font-size: 18px; margin-bottom: 50px;">All items ship together</p>

            <!-- Products Grid -->
            <div id="products-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 40px; margin-bottom: 60px;">
                <!-- Products will be loaded here -->
            </div>
        </div>

        <!-- Sticky Checkout Button -->
        <button id="sticky-checkout-btn" onclick="window.location.href='/addons'" style="display: none; position: fixed; bottom: 30px; right: 30px; background: #059669; color: white; border: none; padding: 18px 35px; border-radius: 12px; font-size: 18px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3); z-index: 999; transition: all 0.3s ease;">
            Proceed to Checkout
        </button>

        <!-- Progress Info -->
        <div class="progress-info">
            <h3>Review Your Cart</h3>
            <p>View your selected items and proceed to checkout when ready</p>
            <a href="/addons" class="btn-secondary">Go to Cart â†’</a>
        </div>
    </div>


    <script>
        // Cart functionality
        let cart = JSON.parse(sessionStorage.getItem('cart')) || [];
        let products = [];


        // Update cart display
        function updateCart() {
            const stickyBtn = document.getElementById('sticky-checkout-btn');
            const cartBadge = document.getElementById('cart-badge');
            
            // Calculate addon items in cart
            const addonItems = cart.reduce((sum, item) => sum + (item.quantity || 1), 0);
            
            // For logged-in backers, always show at least 1 (representing their Kickstarter pledge)
            // Plus any addons they've added
            const totalItems = addonItems + 1; // 1 for pledge + addons
            
            // Always show badge for logged-in backers (they have their pledge)
            cartBadge.style.display = 'flex';
            cartBadge.textContent = totalItems;
            
            // Show sticky checkout button if there are addons in cart
            if (cart.length > 0) {
                stickyBtn.style.display = 'block';
            } else {
                stickyBtn.style.display = 'none';
            }
        }

        // Add product to cart
        function addProductToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            const existingItem = cart.find(item => item.id === productId);
            if (existingItem) {
                return; // Already in cart
            }

            cart.push({
                id: product.id,
                name: product.name,
                price: product.price,
                weight: product.weight,
                quantity: 1
            });

            sessionStorage.setItem('cart', JSON.stringify(cart));
            
            // Update button
            const btn = document.getElementById(`add-btn-${productId}`);
            if (btn) {
                btn.textContent = 'âœ“ Added';
                btn.style.background = '#059669';
                btn.style.borderColor = '#059669';
                btn.style.cursor = 'default';
                btn.disabled = true;
                btn.onclick = null;
            }

            updateCart();
        }

        // Go to cart page
        function goToCart() {
            window.location.href = '/addons';
        }

        // Map pledge names to image filenames
        const pledgeImageMap = {
            'the humble vaanar': 'humble-vaanar.png',
            'humble vaanar': 'humble-vaanar.png',
            'the industrious manushya': 'industrious-manushya.png',
            'industrious manushya': 'industrious-manushya.png',
            'the resplendent garuda': 'resplendant-garuda.png',
            'resplendent garuda': 'resplendant-garuda.png',
            'resplendant garuda': 'resplendant-garuda.png',
            'the benevolent divya': 'benevolent-divya.png',
            'benevolent divya': 'benevolent-divya.png',
            'founders of neh': 'founders-of-neh.png',
            'founder of neh': 'founders-of-neh.png'
        };

        // Load pledge image based on reward title
        async function loadPledgeImage(rewardTitle) {
            try {
                if (!rewardTitle) {
                    console.log('No reward title provided');
                    return;
                }

                const pledgeImage = document.getElementById('pledge-image');
                if (!pledgeImage) {
                    console.error('Pledge image element not found');
                    return;
                }

                // First, try direct mapping
                const rewardTitleLower = rewardTitle.toLowerCase().trim();
                let imageFilename = pledgeImageMap[rewardTitleLower];

                // If not found in direct map, try fetching from API
                if (!imageFilename) {
                    console.log('Checking API for pledge:', rewardTitle);
                    try {
                        const response = await fetch('/api/products');
                const allProducts = await response.json();
                
                        // Find the pledge tier matching the reward title (fuzzy match)
                        const matchingPledge = allProducts.find(p => {
                            const productName = (p.name || '').toLowerCase();
                            const productType = (p.type || '').toLowerCase();
                            
                            // Must be a pledge type
                            if (productType !== 'pledge') return false;
                            
                            // Exact match
                            if (productName === rewardTitleLower) return true;
                            
                            // Contains match
                            if (productName.includes(rewardTitleLower) || rewardTitleLower.includes(productName)) {
                                return true;
                            }
                            
                            // Check if reward title contains key words from product name
                            const productWords = productName.split(/\s+/);
                            const rewardWords = rewardTitleLower.split(/\s+/);
                            const matchingWords = productWords.filter(word => 
                                rewardWords.some(rw => rw.includes(word) || word.includes(rw))
                            );
                            
                            return matchingWords.length >= 2; // At least 2 words match
                        });

                if (matchingPledge && matchingPledge.image) {
                            imageFilename = matchingPledge.image;
                            console.log('âœ“ Found matching pledge in API:', matchingPledge.name);
                        }
                    } catch (apiError) {
                        console.warn('Error fetching from API, using fallback:', apiError);
                    }
                } else {
                    console.log('âœ“ Found pledge image in map:', imageFilename);
                }

                // Set the image
                if (imageFilename) {
                    pledgeImage.src = `/images/pledges/${imageFilename}`;
                    pledgeImage.alt = rewardTitle;
                    console.log('âœ“ Pledge image loaded:', imageFilename);
                } else {
                    // Fallback: try to guess from reward title keywords
                    if (rewardTitleLower.includes('vaanar')) {
                        imageFilename = 'humble-vaanar.png';
                    } else if (rewardTitleLower.includes('manushya')) {
                        imageFilename = 'industrious-manushya.png';
                    } else if (rewardTitleLower.includes('garuda')) {
                        imageFilename = 'resplendant-garuda.png';
                    } else if (rewardTitleLower.includes('divya') || rewardTitleLower.includes('benevolent')) {
                        imageFilename = 'benevolent-divya.png';
                    } else if (rewardTitleLower.includes('founder') || rewardTitleLower.includes('neh')) {
                        imageFilename = 'founders-of-neh.png';
                    }
                    
                    if (imageFilename) {
                        pledgeImage.src = `/images/pledges/${imageFilename}`;
                        pledgeImage.alt = rewardTitle;
                        console.log('âœ“ Pledge image loaded via fallback:', imageFilename);
                    } else {
                        console.warn('âš  No matching pledge image found for:', rewardTitle);
                        // Keep default image or show placeholder
                    }
                }
            } catch (error) {
                console.error('Error loading pledge image:', error);
            }
        }

        // Load products
        async function loadProducts() {
            try {
                // Fetch from /api/products to get both pledges and addons
                const response = await fetch('/api/products');
                products = await response.json();
                
                console.log(`Loaded ${products.length} total products from API`);
                
                // List of pledge tier names to identify pledges
                const pledgeNames = ['humble vaanar', 'industrious manushya', 'resplendent garuda', 'benevolent divya', 'founders of neh'];
                
                // Separate pledges and add-ons
                const pledgeTiers = products.filter(p => {
                    const name = (p.name || '').toLowerCase();
                    const type = (p.type || '').toLowerCase();
                    // Check by type first, then by name
                    return type === 'pledge' || pledgeNames.some(pledge => name.includes(pledge));
                });
                
                console.log(`Found ${pledgeTiers.length} pledge tiers:`, pledgeTiers.map(p => p.name));
                
                const addOnsOnly = products.filter(p => {
                    const name = (p.name || '').toLowerCase();
                    const type = (p.type || '').toLowerCase();
                    // Exclude pledges
                    if (type === 'pledge' || pledgeNames.some(pledge => name.includes(pledge))) {
                        return false;
                    }
                    return true;
                });
                
                console.log(`Found ${addOnsOnly.length} add-ons`);
                
                // Load upgrade pledges for backer (after user data is loaded)
                // Wait a bit to ensure currentPledgeAmount is set
                setTimeout(() => {
                loadUpgradePledges(pledgeTiers);
                }, 100);
                
                displayProducts(addOnsOnly);
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }

        // Store current pledge amount globally
        let currentPledgeAmount = 0;

        // Load upgrade pledge options
        async function loadUpgradePledges(pledgeTiers) {
            try {
                console.log('loadUpgradePledges called with', pledgeTiers?.length || 0, 'pledge tiers');
                
                // Ensure we have the current pledge amount
                if (currentPledgeAmount === 0) {
                    try {
                        const response = await fetch('/api/user/data');
                        const userData = await response.json();
                        currentPledgeAmount = parseFloat(userData.pledgeAmount) || 0;
                        console.log('Fetched current pledge amount from API:', currentPledgeAmount);
                    } catch (err) {
                        console.warn('Could not fetch user data, using 0 as default:', err);
                        currentPledgeAmount = 0;
                    }
                }
                
                if (!pledgeTiers || pledgeTiers.length === 0) {
                    console.warn('No pledge tiers provided to loadUpgradePledges');
                    document.getElementById('upgrade-pledges-section').style.display = 'none';
                    return;
                }
                
                // Filter pledges that are STRICTLY more expensive than current (no downgrades)
                // Using > (not >=) ensures only upgrades are shown
                const upgradePledges = pledgeTiers.filter(p => {
                    const pledgePrice = parseFloat(p.price) || 0;
                    const isUpgrade = pledgePrice > currentPledgeAmount;
                    console.log(`  Checking ${p.name}: $${pledgePrice} vs current $${currentPledgeAmount} -> ${isUpgrade ? 'UPGRADE' : 'skip'}`);
                    return isUpgrade;
                }).sort((a, b) => {
                    // Sort by price ascending (cheapest upgrade first)
                    return (parseFloat(a.price) || 0) - (parseFloat(b.price) || 0);
                });
                
                console.log(`Current pledge amount: $${currentPledgeAmount}`);
                console.log(`Found ${upgradePledges.length} upgrade options:`, upgradePledges.map(p => `${p.name} ($${p.price})`));
                
                if (upgradePledges.length > 0) {
                    const upgradeSection = document.getElementById('upgrade-pledges-section');
                    if (upgradeSection) {
                        upgradeSection.style.display = 'block';
                    displayUpgradePledges(upgradePledges);
                        console.log('âœ“ Upgrade section displayed');
                    } else {
                        console.error('Upgrade section element not found!');
                    }
                } else {
                    // Hide upgrade section if no upgrades available
                    const upgradeSection = document.getElementById('upgrade-pledges-section');
                    if (upgradeSection) {
                        upgradeSection.style.display = 'none';
                    }
                    console.log('No upgrade options available (user has highest tier or no pledges found)');
                }
            } catch (error) {
                console.error('Error loading upgrade pledges:', error);
                // Hide upgrade section on error
                const upgradeSection = document.getElementById('upgrade-pledges-section');
                if (upgradeSection) {
                    upgradeSection.style.display = 'none';
                }
            }
        }

        // Map pledge image names to upgrade pledge image names
        function getUpgradePledgeImage(pledgeImage) {
            const imageMap = {
                'benevolent-divya.png': 'divya.png',
                'founders-of-neh.png': 'founders.png',
                'resplendant-garuda.png': 'garuda.png',
                'resplendent-garuda.png': 'garuda.png',
                'industrious-manushya.png': 'manushya.png',
                'humble-vaanar.png': 'vaanar.png'
            };
            
            // Try to find mapped name, fallback to original
            const imageName = pledgeImage || '';
            const mappedName = imageMap[imageName.toLowerCase()] || imageName;
            return `/images/upgrade pledges/${mappedName}`;
        }

        // Get pledge description text
        function getPledgeDescription(pledgeName) {
            const descriptions = {
                'the humble vaanar': 'Begin your journey into MAYA with the first part in a planned trilogy. Get the paperback Edition Zero of MAYA: Seed Take Root. -381 pages -Beautiful debossed gold and silver foil cover -A detailed appendix of the world + Maya : Seed Takes Root ebook (DRM free) + All Unlocked Paperback stretch goals',
                'humble vaanar': 'Begin your journey into MAYA with the first part in a planned trilogy. Get the paperback Edition Zero of MAYA: Seed Take Root. -381 pages -Beautiful debossed gold and silver foil cover -A detailed appendix of the world + Maya : Seed Takes Root ebook (DRM free) + All Unlocked Paperback stretch goals',
                'the industrious manushya': 'Experience the true authorial vision of MAYA. Get the definitive hardcover Edition Zero of MAYA: Seed Takes Root. -342 pages -A cover with a magical art reveal -A detailed appendix of the world -A magical character reveal effect on the cover + Maya : Seed Takes Root ebook (DRM free) + All Unlocked Hardcover stretch goals',
                'industrious manushya': 'Experience the true authorial vision of MAYA. Get the definitive hardcover Edition Zero of MAYA: Seed Takes Root. -342 pages -A cover with a magical art reveal -A detailed appendix of the world -A magical character reveal effect on the cover + Maya : Seed Takes Root ebook (DRM free) + All Unlocked Hardcover stretch goals',
                'the resplendent garuda': 'Sign up for the entire trilogy! Book 1 will ship after this campaign ends, and you will get live access to Books 2 and 3. Both these books have been fully plotted and outlined, but you will be the first people in the world to read them as they evolve (including incomplete drafts), and be part of the authors\' inner circle. This pledge includes: 1. MAYA: Seed Takes Root | Book 1 Edition Zero Hardcover 2. MAYA: Whispers In The Soil | Book 2 Live Access 3. MAYA: It Becomes The Forest | Book 3 Live Access 4. MAYA : Seed Takes Root ebook (DRM free) Bonus : Book 2 Edition Zero Hardcover, Book 3 Edition Zero Hardcover',
                'resplendent garuda': 'Sign up for the entire trilogy! Book 1 will ship after this campaign ends, and you will get live access to Books 2 and 3. Both these books have been fully plotted and outlined, but you will be the first people in the world to read them as they evolve (including incomplete drafts), and be part of the authors\' inner circle. This pledge includes: 1. MAYA: Seed Takes Root | Book 1 Edition Zero Hardcover 2. MAYA: Whispers In The Soil | Book 2 Live Access 3. MAYA: It Becomes The Forest | Book 3 Live Access 4. MAYA : Seed Takes Root ebook (DRM free) Bonus : Book 2 Edition Zero Hardcover, Book 3 Edition Zero Hardcover',
                'resplendant garuda': 'Sign up for the entire trilogy! Book 1 will ship after this campaign ends, and you will get live access to Books 2 and 3. Both these books have been fully plotted and outlined, but you will be the first people in the world to read them as they evolve (including incomplete drafts), and be part of the authors\' inner circle. This pledge includes: 1. MAYA: Seed Takes Root | Book 1 Edition Zero Hardcover 2. MAYA: Whispers In The Soil | Book 2 Live Access 3. MAYA: It Becomes The Forest | Book 3 Live Access 4. MAYA : Seed Takes Root ebook (DRM free) Bonus : Book 2 Edition Zero Hardcover, Book 3 Edition Zero Hardcover',
                'the benevolent divya': 'The complete, expansive MAYA experience. Get everything - in its most glorious form. Includes everything from the previous pledge + 1. MAYA: Seed Takes Root Audiobook (Narrated by Hugo Weaving) 2. MAYA Lore Hardcover 3. Built Environments of MAYA Hardcover 4. MAYA : Seed Takes Root ebook (DRM free) + ALL Unlocked Stretch Goals!',
                'benevolent divya': 'The complete, expansive MAYA experience. Get everything - in its most glorious form. Includes everything from the previous pledge + 1. MAYA: Seed Takes Root Audiobook (Narrated by Hugo Weaving) 2. MAYA Lore Hardcover 3. Built Environments of MAYA Hardcover 4. MAYA : Seed Takes Root ebook (DRM free) + ALL Unlocked Stretch Goals!',
                'founders of neh': 'Everything in the "Benevolent Divya" reward tier + Limited Edition Signed Artbook documenting the Process + A character in the MAYA universe named after you (adapted to fit the grammar of Neh eg. We already have a character named "Waaz Nayak" named after a certain real-world innovator.',
                'founder of neh': 'Everything in the "Benevolent Divya" reward tier + Limited Edition Signed Artbook documenting the Process + A character in the MAYA universe named after you (adapted to fit the grammar of Neh eg. We already have a character named "Waaz Nayak" named after a certain real-world innovator.'
            };
            
            const nameKey = (pledgeName || '').toLowerCase().trim();
            return descriptions[nameKey] || pledgeName || 'Premium pledge tier';
        }

        // Display upgrade pledges
        function displayUpgradePledges(pledges) {
            const grid = document.getElementById('upgrade-pledges-grid');
            
            grid.innerHTML = pledges.map((pledge, index) => {
                const imagePath = getUpgradePledgeImage(pledge.image);
                // Ensure price is a number
                const pledgePrice = parseFloat(pledge.price) || 0;
                const priceDisplay = pledgePrice.toFixed(2);
                // Escape pledge name for use in onclick
                const pledgeNameEscaped = (pledge.name || '').replace(/'/g, "\\'");
                
                return `
                    <div style="background: #1e1e1e; border-radius: 16px; overflow: hidden;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; cursor: pointer; border-bottom: 1px solid #2c2c2c;" onclick="toggleUpgradePledge(${index})">
                            <div style="flex: 1;">
                                <h3 style="font-size: 20px; font-weight: 700; color: #ffffff; margin: 0 0 4px 0;">${pledge.name}</h3>
                                <div style="font-size: 22px; font-weight: 700; color: #dc2626; margin: 0;">$${priceDisplay}</div>
                            </div>
                            <button style="background: none; border: none; cursor: pointer; padding: 0; font-size: 20px; color: #ffffff; transform-origin: center; transition: transform 0.3s;" id="upgrade-pledge-arrow-${index}">
                                â–¼
                            </button>
                        </div>
                        <div id="upgrade-pledge-content-${index}" style="display: none; padding: 24px; background: #0f0f0f;">
                            <div style="display: flex; gap: 24px; align-items: flex-start; flex-wrap: wrap;">
                                <div style="flex: 0 0 auto; background: #d9d9d9; border-radius: 12px; padding: 8px; height: 280px; width: 280px; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                                    <img src="${imagePath}" alt="${pledge.name}" style="width: 120%; height: 120%; object-fit: contain; object-position: center;" loading="lazy" onerror="this.parentElement.innerHTML='<div style=\\'font-size: 64px;\\'>ðŸ“¦</div>'">
                                </div>
                                <div style="flex: 1; min-width: 250px;">
                                    <p style="font-size: 15px; color: #a0a0a0; margin: 0 0 20px 0; line-height: 1.6;">${getPledgeDescription(pledge.name)}</p>
                                    <button onclick="upgradeToPledge(${pledge.id}, '${pledgeNameEscaped}', ${pledgePrice})" style="background: #dc2626; color: white; border: none; padding: 14px 24px; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; width: auto; min-width: 200px;">
                                        Upgrade to This Tier
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Toggle upgrade pledge dropdown
        function toggleUpgradePledge(index) {
            const content = document.getElementById(`upgrade-pledge-content-${index}`);
            const arrow = document.getElementById(`upgrade-pledge-arrow-${index}`);
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.style.transform = 'rotate(180deg)';
            } else {
                content.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        // Upgrade to a higher pledge tier
        function upgradeToPledge(pledgeId, pledgeName, pledgePrice) {
            // Ensure pledgePrice is a number
            const newPledgePrice = parseFloat(pledgePrice) || 0;
            const currentPledge = currentPledgeAmount || 0;
            
            // Calculate the difference (only charge the difference)
            const difference = newPledgePrice - currentPledge;
            
            if (difference <= 0) {
                alert('This pledge tier is not higher than your current pledge. Please select a higher tier.');
                return;
            }
            
            // Add to cart (will replace current pledge) - no confirmation needed for backers
                const cart = JSON.parse(sessionStorage.getItem('cart') || '[]');
                
                // Remove any existing pledges from cart
                const pledgeNames = ['humble vaanar', 'industrious manushya', 'resplendent garuda', 'benevolent divya', 'founders of neh'];
                const cartWithoutPledges = cart.filter(item => {
                    const name = item.name.toLowerCase();
                return !pledgeNames.some(pledge => name.includes(pledge)) && !item.isPledgeUpgrade;
                });
                
            // Add new pledge upgrade with only the difference as price
                cartWithoutPledges.push({
                    id: pledgeId,
                name: `${pledgeName} (Upgrade)`,
                price: difference, // Only charge the difference
                originalPrice: newPledgePrice, // Store original price for display
                currentPledgeAmount: currentPledge, // Store current pledge for reference
                isPledgeUpgrade: true, // Flag to identify pledge upgrades
                    quantity: 1
                });
                
                sessionStorage.setItem('cart', JSON.stringify(cartWithoutPledges));
                
                // Update button to show "Upgraded" state
                const upgradeButton = document.querySelector(`button[onclick*="upgradeToPledge(${pledgeId}"]`);
                if (upgradeButton) {
                    upgradeButton.style.background = '#059669';
                    upgradeButton.style.borderColor = '#059669';
                    upgradeButton.innerHTML = 'âœ“ Pledge Upgraded';
                    upgradeButton.disabled = true;
                    upgradeButton.style.cursor = 'default';
                }
                
                // Update cart badge
                updateCart();
        }

        // Display products
        function displayProducts(addOnsOnly) {
            const grid = document.getElementById('products-grid');
            
            if (addOnsOnly.length === 0) {
                grid.innerHTML = `<div style="text-align: center; padding: 40px; grid-column: 1 / -1;"><p style="color: #ffffff;">No products available at this time.</p></div>`;
                return;
            }

            grid.innerHTML = '';
            
            addOnsOnly.forEach(product => {
                const card = document.createElement('div');
                card.id = `product-card-${product.id}`;
                card.style.cssText = 'display: flex; flex-direction: column; background: #1e1e1e; border-radius: 16px; min-height: 550px; position: relative; transition: all 0.3s ease;';
                
                const isInCart = cart.find(item => item.id === product.id);
                
                card.innerHTML = `
                    <!-- Product Image -->
                    <div style="background: #d9d9d9; border-radius: 12px; margin: 24px; height: 280px; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                        ${product.image ? `<img src="/images/addons/${product.image}" alt="${product.name}" loading="lazy" style="max-width: 100%; max-height: 100%; object-fit: contain;">` : '<div style="display: flex; align-items: center; justify-content: center; font-size: 64px;">ðŸ“¦</div>'}
                    </div>
                    
                    <!-- Product Info -->
                    <div style="padding: 0 24px; flex: 1; display: flex; flex-direction: column;">
                        <h3 style="font-family: 'Inter', sans-serif; font-weight: 600; font-size: 20px; margin-bottom: 12px; color: #ffffff;">${product.name}</h3>
                        <p style="color: #ffffff; font-size: 14px; line-height: 1.5; margin-bottom: 16px; flex: 1;">${product.description || ''}</p>
                        
                        <!-- Price -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <span style="font-size: 28px; font-weight: 700; color: #ffffff;">$${product.price}</span>
                        </div>
                    </div>
                    
                    <!-- Add to Cart Button -->
                    <button id="add-btn-${product.id}" onclick="${isInCart ? '' : 'addProductToCart(' + product.id + ')'}" style="background: ${isInCart ? '#059669' : '#dc2626'}; border: 1px solid ${isInCart ? '#059669' : '#dc2626'}; color: white; border-radius: 10px; padding: 14px; margin: 0 24px 24px 24px; font-family: 'Inter', sans-serif; font-weight: 600; font-size: 16px; cursor: ${isInCart ? 'default' : 'pointer'}; white-space: nowrap; transition: all 0.3s ease;" ${isInCart ? 'disabled' : ''}>
                        ${isInCart ? 'âœ“ Added' : 'Add to Cart'}
                    </button>
                `;
                grid.appendChild(card);
            });
        }

        // Load user data
        async function loadUserData() {
            try {
                // Clear any guest cart when backer logs in
                sessionStorage.removeItem('cart');
                
                const response = await fetch('/api/user/data');
                const userData = await response.json();

                // Display user info
                document.getElementById('user-email').textContent = userData.email;
                const pledgeAmount = parseFloat(userData.pledgeAmount) || 0;
                document.getElementById('pledge-amount-badge').textContent = pledgeAmount.toFixed(0);
                
                // Store current pledge amount for upgrade filtering
                currentPledgeAmount = pledgeAmount;

                // Load pledge image based on reward title
                loadPledgeImage(userData.rewardTitle);

                // Build items list
                const items = userData.kickstarterItems || {};
                const addons = userData.kickstarterAddons || {};
                
                const itemNames = {
                    ebook: 'MAYA : Seed Takes Root e-book (Edition Zero)',
                    paperback: 'MAYA : Seed Takes Root Paperback (Edition Zero)',
                    audiobook: 'MAYA : Seed Takes Root Audiobook (Narrated by Hugo Weaving)',
                    hardcover: 'MAYA : Seed Takes Root Hardcover (Edition Zero)',
                    book2_hardcover: 'MAYA : Whispers In The Soil | Book 2 Hardcover',
                    book3_hardcover: 'MAYA : It Becomes The Forest | Book 3 Hardcover',
                    book2_live: 'MAYA : Whispers In The Soil | Book 2 Live Access',
                    book3_live: 'MAYA : It Becomes The Forest | Book 3 Live Access',
                    lorebook: 'MAYA Lore : It\'s Species And Their Cultures (Edition Zero)',
                    built_env: 'Built Environments of MAYA Hardcover (Phase 1 & 2)',
                    pendant: 'Flitt Locust Pendant',
                    art_book: 'Limited Edition MAYA Art Book'
                };
                
                const addonNames = {
                    pendant: 'Flitt Locust Pendant',
                    audiobook_addon: 'MAYA: Seed Takes Root Audiobook',
                    built_env_addon: 'Built Environments of MAYA Hardcover',
                    lorebook_addon: 'MAYA Lorebook'
                };

                let itemsArray = [];

                // Add main items
                for (const [key, name] of Object.entries(itemNames)) {
                    const quantity = items[key] || 0;
                    if (quantity > 0) {
                        itemsArray.push(name);
                    }
                }

                // Add Kickstarter add-ons
                for (const [key, name] of Object.entries(addonNames)) {
                    const quantity = addons[key] || 0;
                    if (quantity > 0) {
                        itemsArray.push(name);
                    }
                }

                // Display items as comma-separated text
                const itemsListEl = document.getElementById('items-list');
                if (itemsArray.length > 0) {
                    itemsListEl.textContent = itemsArray.join(', ');
                } else {
                    itemsListEl.textContent = 'No items included in this pledge tier.';
                }

            } catch (error) {
                console.error('Error loading user data:', error);
                document.getElementById('items-list').textContent = 'Error loading pledge information. Please refresh the page.';
            }
        }

        // Initialize
        loadUserData();
        loadProducts();
        updateCart();
    </script>
</body>
</html>
