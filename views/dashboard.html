<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Pledge - MAYA</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto:wght@700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            min-height: 100vh;
        }

        /* Navbar */
        #navbar {
            background: #1a1a1a;
            padding: 10px 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        .logo-container {
            height: 30px;
            width: auto;
        }

        .logo-container img {
            height: 100%;
            width: auto;
            object-fit: contain;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 20px;
            color: #ffffff;
            font-size: 14px;
        }

        .nav-right a {
            color: #ffffff;
            text-decoration: none;
            font-weight: 500;
        }

        .nav-right a:hover {
            opacity: 0.7;
        }

        .cart-button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 19px;
            padding: 5px;
            position: relative;
        }

        .cart-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #059669;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 11px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Main Content */
        .main-content {
            padding: 100px 20px 60px;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Pledge Card */
        .pledge-card {
            background: #1e1e1e;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .pledge-title {
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            font-size: 32px;
            color: #ffffff;
            margin-bottom: 30px;
            letter-spacing: -0.96px;
        }

        .pledge-hero {
            width: 100%;
            height: 700px;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #0a0a0a;
        }

        .pledge-hero img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            object-position: center;
        }

        .pledge-badge {
            display: inline-block;
            background: #059669;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .section-label {
            color: #ffffff;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .items-text {
            color: #ffffff;
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 30px;
        }

        .divider {
            border: none;
            border-top: 2px solid #d9d9d9;
            margin: 30px 0;
        }

        /* Product Thumbnails */
        .product-thumbnails {
            display: flex;
            gap: 30px;
            justify-content: center;
            margin: 40px 0;
        }

        .thumbnail-item {
            flex: 0 0 140px;
            text-align: center;
        }

        .thumbnail-item img {
            width: 100%;
            height: 140px;
            object-fit: contain;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .thumbnail-label {
            font-size: 14px;
            color: #ffffff;
            font-weight: 500;
        }

        /* View Cart Button */
        .btn-cart {
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 11px;
            padding: 18px 50px;
            font-size: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
            display: block;
            margin: 0 auto;
            text-decoration: none;
            text-align: center;
        }

        .btn-cart:hover {
            opacity: 0.9;
        }

        /* Progress Info */
        .progress-info {
            text-align: center;
            margin-top: 40px;
            padding: 30px;
            background: #1e1e1e;
            border-radius: 12px;
        }

        .progress-info h3 {
            color: #ffffff;
            margin-bottom: 10px;
            font-size: 20px;
        }

        .progress-info p {
            color: #ffffff;
            margin-bottom: 20px;
        }

        .btn-secondary {
            background: #059669;
            color: #ffffff;
            border: 2px solid #059669;
            border-radius: 10px;
            padding: 14px 40px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-secondary:hover {
            background: #047857;
            border-color: #047857;
            color: white;
        }

        @media (max-width: 768px) {
            #navbar {
                padding: 10px 20px;
            }

            .main-content {
                padding: 80px 15px 40px;
            }

            .pledge-card {
                padding: 10px;
            }

            .pledge-title {
                font-size: 24px;
            }
            
            .pledge-hero {
                height: 600px;
                border-radius: 8px;
                margin-bottom: 15px;
            }

            .product-thumbnails {
                flex-wrap: wrap;
                gap: 20px;
            }

            .thumbnail-item {
                flex: 0 0 120px;
            }
        }
    </style>
</head>
<body style="background: #0a0a0a !important; color: #ffffff !important;">
    <!-- Navbar -->
    <div id="navbar">
        <div class="logo-container">
            <a href="/dashboard">
                <img src="/images/maya-logo.png" alt="MAYA">
            </a>
            </div>
        <div class="nav-right">
            <a id="ebook-link" href="/ebook" style="display: none;">eBook</a>
            <button onclick="window.location.href='/addons'" class="cart-button" title="Cart" style="display: flex; align-items: center; position: relative;">
                <img src="/images/icons/cart-01.svg" alt="Cart" style="height: 24px; width: 24px;">
                <span id="cart-badge" class="cart-badge" style="display: none;">0</span>
            </button>
            <a href="#" onclick="handleLogout(); return false;">Logout</a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Order Completed View (shown when user has already checked out) -->
        <div id="order-completed-view" style="display: none;">
            <div style="background: #1e1e1e; border-radius: 16px; padding: 40px; margin-bottom: 30px;">
                <div style="text-align: center; margin-bottom: 40px;">
                    <div style="font-size: 64px; margin-bottom: 20px;">‚úÖ</div>
                    <h1 style="font-family: 'Roboto', sans-serif; font-weight: 700; font-size: 36px; color: #059669; margin-bottom: 12px;">Order Confirmed</h1>
                    <p style="color: #a0a0a0; font-size: 18px;">Your order has been placed. We'll charge your saved card when we ship.</p>
                </div>
                
                <!-- Order Summary -->
                <div style="background: #0f0f0f; border-radius: 12px; padding: 24px; margin-bottom: 24px;">
                    <h2 style="font-size: 20px; font-weight: 700; color: #ffffff; margin-bottom: 20px; border-bottom: 1px solid #2c2c2c; padding-bottom: 12px;">Order Summary</h2>
                    <div id="completed-order-items" style="margin-bottom: 20px;">
                        <!-- Items will be populated here -->
                    </div>
                    <div style="border-top: 1px solid #2c2c2c; padding-top: 16px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #a0a0a0;">Subtotal</span>
                            <span id="completed-subtotal" style="color: #ffffff;">$0.00</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #a0a0a0;">Shipping</span>
                            <span id="completed-shipping" style="color: #ffffff;">$0.00</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 20px; font-weight: 700; margin-top: 12px; padding-top: 12px; border-top: 1px solid #2c2c2c;">
                            <span style="color: #ffffff;">Total</span>
                            <span id="completed-total" style="color: #059669;">$0.00</span>
                        </div>
                    </div>
                </div>
                
                <!-- Shipping Address -->
                <div style="background: #0f0f0f; border-radius: 12px; padding: 24px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #2c2c2c; padding-bottom: 12px; margin-bottom: 20px;">
                        <h2 style="font-size: 20px; font-weight: 700; color: #ffffff; margin: 0;">Shipping Address</h2>
                        <button id="edit-address-btn" onclick="toggleAddressEdit(true)" style="background: transparent; border: 1px solid #3b82f6; color: #3b82f6; padding: 8px 16px; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer;">
                            Edit
                        </button>
                    </div>
                    
                    <!-- Display Mode -->
                    <div id="completed-shipping-address" style="color: #a0a0a0; line-height: 1.8;">
                        <!-- Address will be populated here -->
                    </div>
                    
                    <!-- Edit Mode (hidden by default) -->
                    <div id="edit-address-form" style="display: none;">
                        <div style="display: grid; gap: 16px;">
                            <div>
                                <label style="display: block; color: #a0a0a0; font-size: 14px; margin-bottom: 6px;">Full Name *</label>
                                <input type="text" id="edit-fullName" style="width: 100%; padding: 12px; background: #1e1e1e; border: 1px solid #2c2c2c; border-radius: 8px; color: #ffffff; font-size: 16px;" required>
                            </div>
                            <div>
                                <label style="display: block; color: #a0a0a0; font-size: 14px; margin-bottom: 6px;">Email</label>
                                <input type="email" id="edit-email" style="width: 100%; padding: 12px; background: #1e1e1e; border: 1px solid #2c2c2c; border-radius: 8px; color: #ffffff; font-size: 16px;">
                            </div>
                            <div>
                                <label style="display: block; color: #a0a0a0; font-size: 14px; margin-bottom: 6px;">Address Line 1 *</label>
                                <input type="text" id="edit-addressLine1" style="width: 100%; padding: 12px; background: #1e1e1e; border: 1px solid #2c2c2c; border-radius: 8px; color: #ffffff; font-size: 16px;" required>
                            </div>
                            <div>
                                <label style="display: block; color: #a0a0a0; font-size: 14px; margin-bottom: 6px;">Address Line 2</label>
                                <input type="text" id="edit-addressLine2" style="width: 100%; padding: 12px; background: #1e1e1e; border: 1px solid #2c2c2c; border-radius: 8px; color: #ffffff; font-size: 16px;">
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div>
                                    <label style="display: block; color: #a0a0a0; font-size: 14px; margin-bottom: 6px;">City *</label>
                                    <input type="text" id="edit-city" style="width: 100%; padding: 12px; background: #1e1e1e; border: 1px solid #2c2c2c; border-radius: 8px; color: #ffffff; font-size: 16px;" required>
                                </div>
                                <div>
                                    <label style="display: block; color: #a0a0a0; font-size: 14px; margin-bottom: 6px;">State/Province</label>
                                    <input type="text" id="edit-state" style="width: 100%; padding: 12px; background: #1e1e1e; border: 1px solid #2c2c2c; border-radius: 8px; color: #ffffff; font-size: 16px;">
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div>
                                    <label style="display: block; color: #a0a0a0; font-size: 14px; margin-bottom: 6px;">Postal Code *</label>
                                    <input type="text" id="edit-postalCode" style="width: 100%; padding: 12px; background: #1e1e1e; border: 1px solid #2c2c2c; border-radius: 8px; color: #ffffff; font-size: 16px;" required>
                                </div>
                                <div>
                                    <label style="display: block; color: #a0a0a0; font-size: 14px; margin-bottom: 6px;">Country</label>
                                    <input type="text" id="edit-country" style="width: 100%; padding: 12px; background: #2a2a2a; border: 1px solid #2c2c2c; border-radius: 8px; color: #6b7280; font-size: 16px; cursor: not-allowed;" readonly>
                                    <p style="font-size: 12px; color: #6b7280; margin-top: 4px;">Country cannot be changed</p>
                                </div>
                            </div>
                            <div>
                                <label style="display: block; color: #a0a0a0; font-size: 14px; margin-bottom: 6px;">Phone</label>
                                <input type="tel" id="edit-phone" style="width: 100%; padding: 12px; background: #1e1e1e; border: 1px solid #2c2c2c; border-radius: 8px; color: #ffffff; font-size: 16px;">
                            </div>
                        </div>
                        <div id="edit-address-error" style="display: none; color: #ef4444; margin-top: 16px; padding: 12px; background: rgba(239, 68, 68, 0.1); border-radius: 8px;"></div>
                        <div style="display: flex; gap: 12px; margin-top: 24px;">
                            <button onclick="saveAddressEdit()" id="save-address-btn" style="flex: 1; background: #059669; border: none; color: white; padding: 14px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
                                Save Changes
                            </button>
                            <button onclick="toggleAddressEdit(false)" style="flex: 1; background: transparent; border: 1px solid #6b7280; color: #a0a0a0; padding: 14px; border-radius: 8px; font-size: 16px; font-weight: 500; cursor: pointer;">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Payment Status -->
                <div style="background: #0f0f0f; border-radius: 12px; padding: 24px; margin-top: 24px;">
                    <h2 style="font-size: 20px; font-weight: 700; color: #ffffff; margin-bottom: 16px; border-bottom: 1px solid #2c2c2c; padding-bottom: 12px;">Payment Status</h2>
                    <div id="completed-payment-status" style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 24px;">üí≥</span>
                        <span style="color: #a0a0a0;">Card saved - will be charged when order ships</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Shopping View (normal dashboard, hidden when order is completed) -->
        <div id="shopping-view">
        <!-- Pledge Card -->
        <div class="pledge-card">
            <!-- Hero Image -->
            <div class="pledge-hero">
                <img src="" alt="Your Pledge" id="pledge-image" style="display: none;">
            </div>

            <!-- Badge -->
            <div class="pledge-badge" id="pledge-status-badge">$<span id="pledge-amount-badge">0</span> <span id="pledge-status-text">PAID</span></div>

            <!-- Items Section -->
            <div class="section-label">ITEMS INCLUDED</div>
            <div class="items-text" id="items-list">
                Loading your pledge items...
            </div>

        </div>

        <!-- Upgrade Pledge Section -->
        <div id="upgrade-pledges-section" style="margin-top: 60px; display: none;">
            <h2 style="font-family: 'Roboto', sans-serif; font-weight: 700; font-size: 40px; text-align: center; margin-bottom: 16px; color: #ffffff;">Upgrade Your Pledge</h2>
            <p style="text-align: center; color: #ffffff; font-size: 18px; margin-bottom: 50px;">Unlock more exclusive items by upgrading</p>

            <!-- Upgrade Pledges Accordion -->
            <div id="upgrade-pledges-grid" style="display: flex; flex-direction: column; gap: 20px; margin-bottom: 60px; max-width: 1200px; margin-left: auto; margin-right: auto;">
                <!-- Upgrade pledges will be loaded here -->
            </div>
        </div>

        <!-- Add-ons Section -->
        <div style="margin-top: 60px;">
            <h2 style="font-family: 'Roboto', sans-serif; font-weight: 700; font-size: 40px; text-align: center; margin-bottom: 16px; color: #ffffff;">Free and Paid Add-ons</h2>
            <p style="text-align: center; color: #ffffff; font-size: 18px; margin-bottom: 20px;">All items ship together</p>
            
            <!-- Warning for users without pledge -->
            <div id="no-pledge-warning" style="display: none; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 12px; padding: 24px; margin: 0 auto 40px; max-width: 800px; text-align: center;">
                <div style="font-size: 32px; margin-bottom: 12px;">‚ö†Ô∏è</div>
                <h3 style="font-family: 'Inter', sans-serif; font-weight: 700; font-size: 24px; color: #92400e; margin-bottom: 12px;">Select a Pledge First</h3>
                <p style="font-family: 'Inter', sans-serif; font-size: 16px; color: #92400e; line-height: 1.6; margin-bottom: 16px;">
                    To add paid add-ons to your order, please select one of our pledge tiers using the "Upgrade Pledge" section above.
                </p>
                <p style="font-family: 'Inter', sans-serif; font-size: 14px; color: #b45309; font-weight: 600;">
                    Scroll up to browse pledge options ‚Üí
                </p>
            </div>

            <!-- Products Grid -->
            <div id="products-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 40px; margin-bottom: 60px;">
                <!-- Products will be loaded here -->
            </div>
        </div>

        <!-- Sticky Checkout Button -->
        <button id="sticky-checkout-btn" onclick="window.location.href='/addons'" style="display: none; position: fixed; bottom: 30px; right: 30px; background: #059669; color: white; border: none; padding: 18px 35px; border-radius: 12px; font-size: 18px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3); z-index: 999; transition: all 0.3s ease;">
            Proceed to Checkout
        </button>

        <!-- Progress Info -->
        <div class="progress-info">
            <h3>Review Your Cart</h3>
            <p>View your selected items and proceed to checkout when ready</p>
            <a href="/addons" class="btn-secondary">Go to Cart ‚Üí</a>
        </div>
        </div><!-- End shopping-view -->
    </div>


    <script>
        // Cart functionality
        let cart = JSON.parse(sessionStorage.getItem('cart')) || [];
        let products = [];

        async function setupEbookNav() {
            const ebookLink = document.getElementById('ebook-link');
            if (!ebookLink) return;
            try {
                const response = await fetch('/api/user/session');
                const data = await response.json();
                if (data && data.isEligibleBacker) {
                    ebookLink.style.display = 'inline';
                }
            } catch (e) {
                // Non-critical: leave hidden
            }
        }


        // Handle logout with cart clearing
        function handleLogout() {
            sessionStorage.removeItem('cart');
            localStorage.removeItem('originalPledgeInfo'); // Clear dropped backer pledge info
            window.location.href = '/logout';
        }

        // Update cart display
        function updateCart() {
            const stickyBtn = document.getElementById('sticky-checkout-btn');
            const cartBadge = document.getElementById('cart-badge');
            
            // Calculate addon items in cart
            const addonItems = cart.reduce((sum, item) => sum + (item.quantity || 1), 0);
            
            // For logged-in backers, always show at least 1 (representing their Kickstarter pledge)
            // Plus any addons they've added
            const totalItems = addonItems + 1; // 1 for pledge + addons
            
            // Always show badge for logged-in backers (they have their pledge)
            cartBadge.style.display = 'flex';
            cartBadge.textContent = totalItems;
            
            // Show sticky checkout button if there are addons in cart
            if (cart.length > 0) {
                stickyBtn.style.display = 'block';
            } else {
                stickyBtn.style.display = 'none';
            }
        }

        // Add product to cart
        // Note: Dashboard is for Kickstarter backers who already have pledges, so no pledge check needed
        function addProductToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            // Reload cart from sessionStorage to ensure we have the latest state
            cart = JSON.parse(sessionStorage.getItem('cart')) || [];

            const existingItem = cart.find(item => item.id === productId);
            if (existingItem) {
                return; // Already in cart
            }

            cart.push({
                id: product.id,
                name: product.name,
                price: product.price,
                weight: product.weight,
                quantity: 1
            });

            sessionStorage.setItem('cart', JSON.stringify(cart));
            
            // Update button
            const btn = document.getElementById(`add-btn-${productId}`);
            if (btn) {
                btn.textContent = '‚úì Added';
                btn.style.background = '#059669';
                btn.style.borderColor = '#059669';
                btn.style.cursor = 'default';
                btn.disabled = true;
                btn.onclick = null;
            }

            updateCart();
        }

        // Go to cart page
        function goToCart() {
            window.location.href = '/addons';
        }

        setupEbookNav();

        // Map pledge names to image filenames
        const pledgeImageMap = {
            'the humble vaanar': 'humble-vaanar.png',
            'humble vaanar': 'humble-vaanar.png',
            'the industrious manushya': 'industrious-manushya.png',
            'industrious manushya': 'industrious-manushya.png',
            'the resplendent garuda': 'resplendant-garuda.png',
            'resplendent garuda': 'resplendant-garuda.png',
            'resplendant garuda': 'resplendant-garuda.png',
            'the benevolent divya': 'benevolent-divya.png',
            'benevolent divya': 'benevolent-divya.png',
            'founders of neh': 'founders-of-neh.png',
            'founder of neh': 'founders-of-neh.png'
        };

        // Load pledge image based on reward title
        async function loadPledgeImage(rewardTitle) {
            try {
                const pledgeImage = document.getElementById('pledge-image');
                if (!pledgeImage) {
                    console.error('Pledge image element not found');
                    return;
                }
                
                // Show the image element
                pledgeImage.style.display = 'block';
                
                // Detect if mobile screen (phone)
                const isMobile = window.innerWidth <= 768;
                
                // If no reward title, show upgrade pledge message
                if (!rewardTitle || rewardTitle.trim().length === 0) {
                    console.log('No pledge tier - showing upgrade message');
                    const upgradeImage = isMobile 
                        ? '/images/pledges/upgrade-pledge-mobile.webp' 
                        : '/images/pledges/upgrade-pledge-desktop.webp';
                    pledgeImage.src = upgradeImage;
                    pledgeImage.alt = 'Upgrade Your Pledge at Kickstarter Rates';
                    console.log('‚úì Loaded upgrade pledge image:', upgradeImage);
                    return;
                }

                // First, try direct mapping
                const rewardTitleLower = rewardTitle.toLowerCase().trim();
                let imageFilename = pledgeImageMap[rewardTitleLower];

                // If not found in direct map, try fetching from API
                if (!imageFilename) {
                    console.log('Checking API for pledge:', rewardTitle);
                    try {
                        const response = await fetch('/api/products');
                const allProducts = await response.json();
                
                        // Find the pledge tier matching the reward title (fuzzy match)
                        const matchingPledge = allProducts.find(p => {
                            const productName = (p.name || '').toLowerCase();
                            const productType = (p.type || '').toLowerCase();
                            
                            // Must be a pledge type
                            if (productType !== 'pledge') return false;
                            
                            // Exact match
                            if (productName === rewardTitleLower) return true;
                            
                            // Contains match
                            if (productName.includes(rewardTitleLower) || rewardTitleLower.includes(productName)) {
                                return true;
                            }
                            
                            // Check if reward title contains key words from product name
                            const productWords = productName.split(/\s+/);
                            const rewardWords = rewardTitleLower.split(/\s+/);
                            const matchingWords = productWords.filter(word => 
                                rewardWords.some(rw => rw.includes(word) || word.includes(rw))
                            );
                            
                            return matchingWords.length >= 2; // At least 2 words match
                        });

                if (matchingPledge && matchingPledge.image) {
                            imageFilename = matchingPledge.image;
                            console.log('‚úì Found matching pledge in API:', matchingPledge.name);
                        }
                    } catch (apiError) {
                        console.warn('Error fetching from API, using fallback:', apiError);
                    }
                } else {
                    console.log('‚úì Found pledge image in map:', imageFilename);
                }

                // Set the image
                if (imageFilename) {
                    // Use mobile-friendly images on phone screens from upgrade pledges folder
                    if (isMobile) {
                        const mobileImageMap = {
                            'humble-vaanar.png': 'vaanar.png',
                            'industrious-manushya.png': 'manushya.png',
                            'resplendant-garuda.png': 'garuda.png',
                            'resplendent-garuda.png': 'garuda.png',
                            'benevolent-divya.png': 'divya.png',
                            'founders-of-neh.png': 'founders.png'
                        };
                        const mobileImage = mobileImageMap[imageFilename] || imageFilename;
                        // URL-encode the space in folder name
                        pledgeImage.src = `/images/upgrade%20pledges/${mobileImage}`;
                        pledgeImage.alt = rewardTitle;
                        pledgeImage.style.display = 'block';
                        console.log('‚úì Mobile pledge image loaded:', mobileImage);
                    } else {
                        pledgeImage.src = `/images/pledges/${imageFilename}`;
                        pledgeImage.alt = rewardTitle;
                        pledgeImage.style.display = 'block';
                        console.log('‚úì Desktop pledge image loaded:', imageFilename);
                    }
                } else {
                    // Fallback: try to guess from reward title keywords
                    let fallbackImageFilename = null;
                    if (rewardTitleLower.includes('vaanar')) {
                        fallbackImageFilename = isMobile ? 'vaanar.png' : 'humble-vaanar.png';
                    } else if (rewardTitleLower.includes('manushya')) {
                        fallbackImageFilename = isMobile ? 'manushya.png' : 'industrious-manushya.png';
                    } else if (rewardTitleLower.includes('garuda')) {
                        fallbackImageFilename = isMobile ? 'garuda.png' : 'resplendant-garuda.png';
                    } else if (rewardTitleLower.includes('divya') || rewardTitleLower.includes('benevolent')) {
                        fallbackImageFilename = isMobile ? 'divya.png' : 'benevolent-divya.png';
                    } else if (rewardTitleLower.includes('founder') || rewardTitleLower.includes('neh')) {
                        fallbackImageFilename = isMobile ? 'founders.png' : 'founders-of-neh.png';
                    }
                    
                    if (fallbackImageFilename) {
                        // URL-encode the space in folder name for mobile
                        const imageFolder = isMobile ? '/images/upgrade%20pledges/' : '/images/pledges/';
                        pledgeImage.src = `${imageFolder}${fallbackImageFilename}`;
                        pledgeImage.alt = rewardTitle;
                        pledgeImage.style.display = 'block';
                        console.log(`‚úì Pledge image loaded via fallback (${isMobile ? 'mobile' : 'desktop'}):`, fallbackImageFilename);
                    } else {
                        console.warn('‚ö† No matching pledge image found for:', rewardTitle);
                        // Use upgrade message as final fallback
                        const upgradeImage = isMobile 
                            ? '/images/pledges/upgrade-pledge-mobile.webp' 
                            : '/images/pledges/upgrade-pledge-desktop.webp';
                        pledgeImage.src = upgradeImage;
                        pledgeImage.alt = 'Your Pledge';
                        pledgeImage.style.display = 'block';
                    }
                }
                
                // Add error handler in case image fails to load
                pledgeImage.onerror = function() {
                    console.error('Failed to load pledge image:', this.src);
                    // Try fallback upgrade image
                    const upgradeImage = isMobile 
                        ? '/images/pledges/upgrade-pledge-mobile.webp' 
                        : '/images/pledges/upgrade-pledge-desktop.webp';
                    this.src = upgradeImage;
                    this.alt = 'Your Pledge';
                };
            } catch (error) {
                console.error('Error loading pledge image:', error);
            }
        }

        // Sync pledge button states with cart
        function syncPledgeButtonsWithCart() {
            // Reset all pledge buttons to normal state first
            document.querySelectorAll('button[onclick*="upgradeToPledge"]').forEach(btn => {
                btn.style.background = '#dc2626';
                btn.style.borderColor = '#dc2626';
                btn.innerHTML = 'Upgrade to This Tier';
                btn.disabled = false;
                btn.style.cursor = 'pointer';
            });
            
            // Check cart for upgraded pledges
            const currentCart = JSON.parse(sessionStorage.getItem('cart')) || [];
            
            // Find upgraded pledge in cart (for dropped backers: isDroppedBackerPledge, for paid: isPledgeUpgrade)
            const upgradedPledge = currentCart.find(item => 
                item.isDroppedBackerPledge || item.isPledgeUpgrade
            );
            
            if (upgradedPledge) {
                // Extract pledge ID from cart item
                const upgradedPledgeId = upgradedPledge.id;
                
                // Find the matching button and mark it as upgraded
                const upgradeButton = document.querySelector(`button[onclick*="upgradeToPledge('${upgradedPledgeId}'"]`);
                if (upgradeButton) {
                    upgradeButton.style.background = '#059669';
                    upgradeButton.style.borderColor = '#059669';
                    upgradeButton.innerHTML = '‚úì Pledge Upgraded';
                    upgradeButton.disabled = true;
                    upgradeButton.style.cursor = 'default';
                    console.log('‚úì Synced pledge button state: upgraded pledge found in cart');
                }
            } else {
                console.log('‚úì Synced pledge button state: no upgraded pledge in cart, all buttons reset');
            }
        }

        // Load products
        async function loadProducts() {
            try {
                // Fetch from /api/products to get both pledges and addons
                const response = await fetch('/api/products');
                products = await response.json();
                
                console.log(`Loaded ${products.length} total products from API`);
                
                // List of pledge tier names to identify pledges
                const pledgeNames = ['humble vaanar', 'industrious manushya', 'resplendent garuda', 'benevolent divya', 'founders of neh'];
                
                // Separate pledges and add-ons
                const pledgeTiers = products.filter(p => {
                    const name = (p.name || '').toLowerCase();
                    const type = (p.type || '').toLowerCase();
                    // Check by type first, then by name
                    return type === 'pledge' || pledgeNames.some(pledge => name.includes(pledge));
                });
                
                console.log(`Found ${pledgeTiers.length} pledge tiers:`, pledgeTiers.map(p => p.name));
                
                const addOnsOnly = products.filter(p => {
                    const name = (p.name || '').toLowerCase();
                    const type = (p.type || '').toLowerCase();
                    // Exclude pledges
                    if (type === 'pledge' || pledgeNames.some(pledge => name.includes(pledge))) {
                        return false;
                    }
                    return true;
                });
                
                console.log(`Found ${addOnsOnly.length} add-ons`);
                
                // Load upgrade pledges for backer (after user data is loaded)
                // Wait a bit to ensure currentPledgeAmount is set
                setTimeout(() => {
                loadUpgradePledges(pledgeTiers);
                }, 100);
                
                displayProducts(addOnsOnly);
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }

        // Store current pledge amount globally
        let currentPledgeAmount = 0;
        let hasValidPledge = false; // Track if user has a pledge tier
        let isDroppedBacker = false; // Track if payment failed on Kickstarter
        let originalPledgeInfo = null; // Store original pledge info for dropped backers

        // Load upgrade pledge options
        async function loadUpgradePledges(pledgeTiers) {
            try {
                console.log('loadUpgradePledges called with', pledgeTiers?.length || 0, 'pledge tiers');
                
                // Ensure we have the current pledge amount
                if (currentPledgeAmount === 0) {
                    try {
                        const response = await fetch('/api/user/data');
                        const userData = await response.json();
                        currentPledgeAmount = parseFloat(userData.pledgeAmount) || 0;
                        console.log('Fetched current pledge amount from API:', currentPledgeAmount);
                    } catch (err) {
                        console.warn('Could not fetch user data, using 0 as default:', err);
                        currentPledgeAmount = 0;
                    }
                }
                
                if (!pledgeTiers || pledgeTiers.length === 0) {
                    console.warn('No pledge tiers provided to loadUpgradePledges');
                    document.getElementById('upgrade-pledges-section').style.display = 'none';
                    return;
                }
                
                // Tier hierarchy ranking (higher = better tier)
                // Use this instead of price to determine upgrades, since late pledgers may have paid more
                const tierRanking = {
                    'the humble vaanar': 1,
                    'humble vaanar': 1,
                    'the industrious manushya': 2,
                    'industrious manushya': 2,
                    'the resplendent garuda': 3,
                    'resplendent garuda': 3,
                    'the benevolent divya': 4,
                    'benevolent divya': 4,
                    'founders of neh': 5
                };
                
                // Get user's current tier rank from their reward title
                const userTierName = (currentRewardTitle || '').toLowerCase().trim();
                const userTierRank = tierRanking[userTierName] || 0;
                console.log(`User tier: "${currentRewardTitle}" (rank: ${userTierRank}), pledge amount: $${currentPledgeAmount}`);
                
                // Filter pledges that are HIGHER tier than current (by hierarchy, not price)
                // This fixes the issue where late pledgers paid more than the next tier costs
                const upgradePledges = pledgeTiers.filter(p => {
                    const pledgeName = (p.name || '').toLowerCase().trim();
                    const pledgeTierRank = tierRanking[pledgeName] || 0;
                    const isUpgrade = pledgeTierRank > userTierRank;
                    console.log(`  Checking ${p.name}: tier rank ${pledgeTierRank} vs user rank ${userTierRank} -> ${isUpgrade ? 'UPGRADE' : 'skip'}`);
                    return isUpgrade;
                }).sort((a, b) => {
                    // Sort by tier rank ascending (next tier first)
                    const rankA = tierRanking[(a.name || '').toLowerCase().trim()] || 0;
                    const rankB = tierRanking[(b.name || '').toLowerCase().trim()] || 0;
                    return rankA - rankB;
                });
                
                console.log(`Found ${upgradePledges.length} upgrade options:`, upgradePledges.map(p => `${p.name} ($${p.price})`));
                
                if (upgradePledges.length > 0) {
                    const upgradeSection = document.getElementById('upgrade-pledges-section');
                    if (upgradeSection) {
                        upgradeSection.style.display = 'block';
                    displayUpgradePledges(upgradePledges);
                        console.log('‚úì Upgrade section displayed');
                        // Sync pledge button states with cart after buttons are rendered
                        setTimeout(() => syncPledgeButtonsWithCart(), 100);
                    } else {
                        console.error('Upgrade section element not found!');
                    }
                } else {
                    // Hide upgrade section if no upgrades available
                    const upgradeSection = document.getElementById('upgrade-pledges-section');
                    if (upgradeSection) {
                        upgradeSection.style.display = 'none';
                    }
                    console.log('No upgrade options available (user has highest tier or no pledges found)');
                }
            } catch (error) {
                console.error('Error loading upgrade pledges:', error);
                // Hide upgrade section on error
                const upgradeSection = document.getElementById('upgrade-pledges-section');
                if (upgradeSection) {
                    upgradeSection.style.display = 'none';
                }
            }
        }

        // Map pledge image names to upgrade pledge image names
        function getUpgradePledgeImage(pledgeImage) {
            const imageMap = {
                'benevolent-divya.png': 'divya.png',
                'founders-of-neh.png': 'founders.png',
                'resplendant-garuda.png': 'garuda.png',
                'resplendent-garuda.png': 'garuda.png',
                'industrious-manushya.png': 'manushya.png',
                'humble-vaanar.png': 'vaanar.png'
            };

            // Try to find mapped name, fallback to original
            const imageName = pledgeImage || '';
            const mappedName = imageMap[imageName.toLowerCase()] || imageName;
            // URL-encode the space in folder name
            return `/images/upgrade%20pledges/${mappedName}`;
        }

        // Get pledge description text
        function getPledgeDescription(pledgeName) {
            const descriptions = {
                'the humble vaanar': 'Begin your journey into MAYA with the first part in a planned trilogy. Get the paperback Edition Zero of MAYA: Seed Take Root. -381 pages -Beautiful debossed gold and silver foil cover -A detailed appendix of the world + Maya : Seed Takes Root ebook (DRM free) + All Unlocked Paperback stretch goals',
                'humble vaanar': 'Begin your journey into MAYA with the first part in a planned trilogy. Get the paperback Edition Zero of MAYA: Seed Take Root. -381 pages -Beautiful debossed gold and silver foil cover -A detailed appendix of the world + Maya : Seed Takes Root ebook (DRM free) + All Unlocked Paperback stretch goals',
                'the industrious manushya': 'Experience the true authorial vision of MAYA. Get the definitive hardcover Edition Zero of MAYA: Seed Takes Root. -342 pages -A cover with a magical art reveal -A detailed appendix of the world -A magical character reveal effect on the cover + Maya : Seed Takes Root ebook (DRM free) + All Unlocked Hardcover stretch goals',
                'industrious manushya': 'Experience the true authorial vision of MAYA. Get the definitive hardcover Edition Zero of MAYA: Seed Takes Root. -342 pages -A cover with a magical art reveal -A detailed appendix of the world -A magical character reveal effect on the cover + Maya : Seed Takes Root ebook (DRM free) + All Unlocked Hardcover stretch goals',
                'the resplendent garuda': 'Sign up for the entire trilogy! Book 1 will ship after this campaign ends, and you will get live access to Books 2 and 3. Both these books have been fully plotted and outlined, but you will be the first people in the world to read them as they evolve (including incomplete drafts), and be part of the authors\' inner circle. This pledge includes: 1. MAYA: Seed Takes Root | Book 1 Edition Zero Hardcover 2. MAYA: Whispers In The Soil | Book 2 Live Access 3. MAYA: It Becomes The Forest | Book 3 Live Access 4. MAYA : Seed Takes Root ebook (DRM free) Bonus : Book 2 Edition Zero Hardcover, Book 3 Edition Zero Hardcover',
                'resplendent garuda': 'Sign up for the entire trilogy! Book 1 will ship after this campaign ends, and you will get live access to Books 2 and 3. Both these books have been fully plotted and outlined, but you will be the first people in the world to read them as they evolve (including incomplete drafts), and be part of the authors\' inner circle. This pledge includes: 1. MAYA: Seed Takes Root | Book 1 Edition Zero Hardcover 2. MAYA: Whispers In The Soil | Book 2 Live Access 3. MAYA: It Becomes The Forest | Book 3 Live Access 4. MAYA : Seed Takes Root ebook (DRM free) Bonus : Book 2 Edition Zero Hardcover, Book 3 Edition Zero Hardcover',
                'resplendant garuda': 'Sign up for the entire trilogy! Book 1 will ship after this campaign ends, and you will get live access to Books 2 and 3. Both these books have been fully plotted and outlined, but you will be the first people in the world to read them as they evolve (including incomplete drafts), and be part of the authors\' inner circle. This pledge includes: 1. MAYA: Seed Takes Root | Book 1 Edition Zero Hardcover 2. MAYA: Whispers In The Soil | Book 2 Live Access 3. MAYA: It Becomes The Forest | Book 3 Live Access 4. MAYA : Seed Takes Root ebook (DRM free) Bonus : Book 2 Edition Zero Hardcover, Book 3 Edition Zero Hardcover',
                'the benevolent divya': 'The complete, expansive MAYA experience. Get everything - in its most glorious form. Includes everything from the previous pledge + 1. MAYA: Seed Takes Root Audiobook (Narrated by Hugo Weaving) 2. MAYA Lore Hardcover 3. Built Environments of MAYA Hardcover 4. MAYA : Seed Takes Root ebook (DRM free) + ALL Unlocked Stretch Goals!',
                'benevolent divya': 'The complete, expansive MAYA experience. Get everything - in its most glorious form. Includes everything from the previous pledge + 1. MAYA: Seed Takes Root Audiobook (Narrated by Hugo Weaving) 2. MAYA Lore Hardcover 3. Built Environments of MAYA Hardcover 4. MAYA : Seed Takes Root ebook (DRM free) + ALL Unlocked Stretch Goals!',
                'founders of neh': 'Everything in the "Benevolent Divya" reward tier + Limited Edition Signed Artbook documenting the Process + A character in the MAYA universe named after you (adapted to fit the grammar of Neh eg. We already have a character named "Waaz Nayak" named after a certain real-world innovator.',
                'founder of neh': 'Everything in the "Benevolent Divya" reward tier + Limited Edition Signed Artbook documenting the Process + A character in the MAYA universe named after you (adapted to fit the grammar of Neh eg. We already have a character named "Waaz Nayak" named after a certain real-world innovator.'
            };
            
            const nameKey = (pledgeName || '').toLowerCase().trim();
            return descriptions[nameKey] || pledgeName || 'Premium pledge tier';
        }

        // Display upgrade pledges
        function displayUpgradePledges(pledges) {
            const grid = document.getElementById('upgrade-pledges-grid');
            
            grid.innerHTML = pledges.map((pledge, index) => {
                const imagePath = getUpgradePledgeImage(pledge.image);
                // Ensure price is a number
                const pledgePrice = parseFloat(pledge.price) || 0;
                const priceDisplay = pledgePrice.toFixed(2);
                // Escape pledge name for use in onclick
                const pledgeNameEscaped = (pledge.name || '').replace(/'/g, "\\'");
                
                return `
                    <div style="background: #1e1e1e; border-radius: 16px; overflow: hidden;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; cursor: pointer; border-bottom: 1px solid #2c2c2c;" onclick="toggleUpgradePledge(${index})">
                            <div style="flex: 1;">
                                <h3 style="font-size: 20px; font-weight: 700; color: #ffffff; margin: 0 0 4px 0;">${pledge.name}</h3>
                                <div style="font-size: 22px; font-weight: 700; color: #dc2626; margin: 0;">$${priceDisplay}</div>
                            </div>
                            <button style="background: none; border: none; cursor: pointer; padding: 0; font-size: 20px; color: #ffffff; transform-origin: center; transition: transform 0.3s;" id="upgrade-pledge-arrow-${index}">
                                ‚ñº
                            </button>
                        </div>
                        <div id="upgrade-pledge-content-${index}" style="display: none; padding: 24px; background: #0f0f0f;">
                            <div style="display: flex; gap: 24px; align-items: flex-start; flex-wrap: wrap;">
                                <div style="flex: 0 0 auto; background: #d9d9d9; border-radius: 12px; padding: 8px; height: 280px; width: 280px; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                                    <img src="${imagePath}" alt="${pledge.name}" style="width: 120%; height: 120%; object-fit: contain; object-position: center;" loading="lazy" onerror="this.parentElement.innerHTML='<div style=\\'font-size: 64px;\\'>üì¶</div>'">
                                </div>
                                <div style="flex: 1; min-width: 250px;">
                                    <p style="font-size: 15px; color: #a0a0a0; margin: 0 0 20px 0; line-height: 1.6;">${getPledgeDescription(pledge.name)}</p>
                                    <button onclick="upgradeToPledge('${pledge.id}', '${pledgeNameEscaped}', ${pledgePrice})" style="background: #dc2626; color: white; border: none; padding: 14px 24px; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; width: auto; min-width: 200px;">
                                        Upgrade to This Tier
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Toggle upgrade pledge dropdown
        function toggleUpgradePledge(index) {
            const content = document.getElementById(`upgrade-pledge-content-${index}`);
            const arrow = document.getElementById(`upgrade-pledge-arrow-${index}`);
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.style.transform = 'rotate(180deg)';
            } else {
                content.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        // Upgrade to a higher pledge tier
        function upgradeToPledge(pledgeId, pledgeName, pledgePrice) {
            // Ensure pledgePrice is a number
            const newPledgePrice = parseFloat(pledgePrice) || 0;
            const currentPledge = currentPledgeAmount || 0;
            
            // For dropped backers, charge full amount. For paid backers, charge difference.
            let amountToCharge;
            let upgradeDescription;
            
            if (isDroppedBacker) {
                // Dropped backer: charge full amount (they haven't paid yet)
                amountToCharge = newPledgePrice;
                upgradeDescription = `Full pledge amount: $${newPledgePrice.toFixed(2)}`;
                console.log('Dropped backer upgrade: charging full amount');
            } else {
                // Paid backer: charge only the difference
                const difference = newPledgePrice - currentPledge;
                
                if (difference <= 0) {
                    alert('This pledge tier is not higher than your current pledge. Please select a higher tier.');
                    return;
                }
                
                amountToCharge = difference;
                upgradeDescription = `Upgrade: $${currentPledge.toFixed(2)} ‚Üí $${newPledgePrice.toFixed(2)} (Pay difference)`;
                console.log('Paid backer upgrade: charging difference');
            }
            
            // Add to cart (will replace current pledge) - no confirmation needed for backers
                const tempCart = JSON.parse(sessionStorage.getItem('cart') || '[]');
                
                // Remove any existing pledges from cart (including original pledge for dropped backers)
                const pledgeNames = ['humble vaanar', 'industrious manushya', 'resplendent garuda', 'benevolent divya', 'founders of neh'];
                const cartWithoutPledges = tempCart.filter(item => {
                    const name = item.name.toLowerCase();
                    return !pledgeNames.some(pledge => name.includes(pledge)) 
                        && !item.isPledgeUpgrade 
                        && !item.isOriginalPledge; // Also remove original pledge for dropped backers
                });
                
            // For dropped backers: add as regular pledge (they need to pay full amount)
            // For paid backers: add as upgrade (they only pay difference)
            if (isDroppedBacker) {
                // Dropped backer: replace original pledge with new pledge (full amount)
                cartWithoutPledges.push({
                    id: pledgeId,
                    name: pledgeName, // No "(Upgrade)" suffix for dropped backers
                    price: amountToCharge,
                    isOriginalPledge: true, // Mark as unremovable pledge
                    isDroppedBackerPledge: true, // Flag for dropped backer pledge
                    quantity: 1
                });
            } else {
                // Paid backer: add as pledge upgrade (only pay difference)
                cartWithoutPledges.push({
                    id: pledgeId,
                    name: `${pledgeName} (Upgrade)`,
                    price: amountToCharge,
                    originalPrice: newPledgePrice, // Store original price for display
                    currentPledgeAmount: currentPledge, // Store current pledge for reference
                    isPledgeUpgrade: true, // Flag to identify pledge upgrades
                    quantity: 1
                });
            }
                
                sessionStorage.setItem('cart', JSON.stringify(cartWithoutPledges));
                
                // CRITICAL: Update the global cart variable to match sessionStorage
                cart = cartWithoutPledges;
                
                // Reset ALL pledge upgrade buttons to normal state first
                document.querySelectorAll('button[onclick*="upgradeToPledge"]').forEach(btn => {
                    btn.style.background = '#dc2626';
                    btn.style.borderColor = '#dc2626';
                    btn.innerHTML = 'Upgrade Pledge';
                    btn.disabled = false;
                    btn.style.cursor = 'pointer';
                });
                
                // Update only the current button to show "Upgraded" state
                const upgradeButton = document.querySelector(`button[onclick*="upgradeToPledge('${pledgeId}'"]`);
                if (upgradeButton) {
                    upgradeButton.style.background = '#059669';
                    upgradeButton.style.borderColor = '#059669';
                    upgradeButton.innerHTML = '‚úì Pledge Upgraded';
                    upgradeButton.disabled = true;
                    upgradeButton.style.cursor = 'default';
                }
                
                // Enable add-ons now that user has upgraded to a pledge
                hasValidPledge = true;
                const warningEl = document.getElementById('no-pledge-warning');
                if (warningEl) {
                    warningEl.style.display = 'none';
                }
                
                // Refresh products display to enable "Add to Cart" buttons
                if (products.length > 0) {
                    const pledgeNames = ['humble vaanar', 'industrious manushya', 'resplendent garuda', 'benevolent divya', 'founders of neh'];
                    const addOnsOnly = products.filter(p => {
                        const name = (p.name || '').toLowerCase();
                        const type = (p.type || '').toLowerCase();
                        if (type === 'pledge' || pledgeNames.some(pledge => name.includes(pledge))) {
                            return false;
                        }
                        return true;
                    });
                    displayProducts(addOnsOnly);
                }
                
                // Update cart badge
                updateCart();
        }

        // Display products
        function displayProducts(addOnsOnly) {
            const grid = document.getElementById('products-grid');
            
            // Re-read cart from sessionStorage to ensure it's fresh (in case user removed items)
            cart = JSON.parse(sessionStorage.getItem('cart')) || [];
            
            if (addOnsOnly.length === 0) {
                grid.innerHTML = `<div style="text-align: center; padding: 40px; grid-column: 1 / -1;"><p style="color: #ffffff;">No products available at this time.</p></div>`;
                return;
            }

            grid.innerHTML = '';
            
            addOnsOnly.forEach(product => {
                const card = document.createElement('div');
                card.id = `product-card-${product.id}`;
                card.style.cssText = 'display: flex; flex-direction: column; background: #1e1e1e; border-radius: 16px; min-height: 550px; position: relative; transition: all 0.3s ease;';
                
                const isInCart = cart.find(item => item.id === product.id);
                
                card.innerHTML = `
                    <!-- Product Image -->
                    <div style="background: #d9d9d9; border-radius: 12px; margin: 24px; height: 280px; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                        ${product.image ? `<img src="/images/addons/${product.image}" alt="${product.name}" loading="lazy" style="max-width: 100%; max-height: 100%; object-fit: contain;">` : '<div style="display: flex; align-items: center; justify-content: center; font-size: 64px;">üì¶</div>'}
                    </div>
                    
                    <!-- Product Info -->
                    <div style="padding: 0 24px; flex: 1; display: flex; flex-direction: column;">
                        <h3 style="font-family: 'Inter', sans-serif; font-weight: 600; font-size: 20px; margin-bottom: 12px; color: #ffffff;">${product.name}</h3>
                        <p style="color: #ffffff; font-size: 14px; line-height: 1.5; margin-bottom: 16px; flex: 1;">${product.description || ''}</p>
                        
                        <!-- Price -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <span style="font-size: 28px; font-weight: 700; color: #ffffff;">$${product.price}</span>
                        </div>
                    </div>
                    
                    <!-- Add to Cart Button -->
                    <button id="add-btn-${product.id}" onclick="${isInCart ? '' : (hasValidPledge ? "addProductToCart('" + product.id + "')" : '')}" style="background: ${isInCart ? '#059669' : (hasValidPledge ? '#dc2626' : '#6b7280')}; border: 1px solid ${isInCart ? '#059669' : (hasValidPledge ? '#dc2626' : '#6b7280')}; color: white; border-radius: 10px; padding: 14px; margin: 0 24px 24px 24px; font-family: 'Inter', sans-serif; font-weight: 600; font-size: 16px; cursor: ${isInCart || !hasValidPledge ? 'default' : 'pointer'}; white-space: nowrap; transition: all 0.3s ease; opacity: ${hasValidPledge ? '1' : '0.6'};" ${isInCart || !hasValidPledge ? 'disabled' : ''}>
                        ${isInCart ? '‚úì Added' : (hasValidPledge ? 'Add to Cart' : 'üîí Upgrade Pledge First')}
                    </button>
                `;
                grid.appendChild(card);
            });
        }

        // Load user data
        async function loadUserData() {
            try {
                const response = await fetch('/api/user/data');
                if (!response.ok) {
                    throw new Error(`API error: ${response.status} ${response.statusText}`);
                }
                const userData = await response.json();

                // Display user info
                const pledgeAmount = parseFloat(userData.pledgeAmount) || 0;
                document.getElementById('pledge-amount-badge').textContent = pledgeAmount.toFixed(0);
                
                // Check if payment failed (dropped backer)
                isDroppedBacker = userData.pledgedStatus === 'dropped';
                const badgeElement = document.getElementById('pledge-status-badge');
                const statusText = document.getElementById('pledge-status-text');
                
                if (isDroppedBacker) {
                    badgeElement.style.background = '#dc2626'; // Red
                    statusText.textContent = 'PAYMENT FAILED';
                } else {
                    badgeElement.style.background = '#059669'; // Green
                    statusText.textContent = 'PAID';
                }
                
                // Store current pledge amount for upgrade filtering
                currentPledgeAmount = pledgeAmount;
                
                // Check if user has a valid pledge tier (not just a random backing amount)
                const rewardTitle = userData.rewardTitle || '';
                hasValidPledge = rewardTitle.trim().length > 0 && pledgeAmount >= 18;

                // For dropped backers, they have a valid pledge (even if payment failed)
                // So they should be able to add addons
                if (isDroppedBacker && pledgeAmount > 0 && rewardTitle) {
                    hasValidPledge = true; // Dropped backers have a valid pledge tier
                    console.log('‚úì Dropped backer detected - addons unlocked. Pledge:', rewardTitle, 'Amount:', pledgeAmount);
                    
                    // Payment Over Time handling - check if backer has already made partial payment
                    // Uses amount_paid and amount_due fields from database instead of hardcoded values
                    let adjustedPrice = pledgeAmount;
                    let originalPledgeAmount = null;
                    let partialPaymentAmount = null;
                    
                    // Check if this backer has a partial payment (Payment Over Time)
                    const amountPaid = userData.amountPaid || 0;
                    const amountDue = userData.amountDue || 0;
                    
                    if (amountPaid > 0 && amountDue > 0) {
                        // Backer has made partial payment - adjust price to only charge remaining amount
                        originalPledgeAmount = pledgeAmount;
                        partialPaymentAmount = amountPaid;
                        adjustedPrice = amountDue; // Use amount_due as the remaining amount to charge
                        console.log(`‚úì Payment Over Time backer #${userData.backerNumber}: Original: $${originalPledgeAmount}, Paid: $${partialPaymentAmount}, Due: $${adjustedPrice}`);
                    }
                    
                    // Store original pledge info globally and in localStorage for restoration
                    originalPledgeInfo = {
                        id: 'original-pledge-' + userData.backerNumber,
                        name: rewardTitle,
                        price: adjustedPrice, // Use adjusted price for partial payment backers
                        isOriginalPledge: true,
                        quantity: 1
                    };
                    
                    // Store partial payment info for display purposes
                    if (originalPledgeAmount !== null) {
                        originalPledgeInfo.originalPledgeAmount = originalPledgeAmount;
                        originalPledgeInfo.partialPaymentAmount = partialPaymentAmount;
                    }
                    
                    localStorage.setItem('originalPledgeInfo', JSON.stringify(originalPledgeInfo));
                    
                    // Check if pledge is already in cart
                    let cart = JSON.parse(sessionStorage.getItem('cart')) || [];
                    const pledgeInCart = cart.find(item => item.isOriginalPledge);
                    
                    if (!pledgeInCart) {
                        // Add the original pledge to cart (full amount, not difference)
                        cart.push(originalPledgeInfo);
                        sessionStorage.setItem('cart', JSON.stringify(cart));
                        console.log('‚úì Added original pledge to cart for dropped backer:', pledgeAmount);
                    }
                    
                    // Add Kickstarter addons to cart for dropped backers (unremovable)
                    const addons = userData.kickstarterAddons || {};
                    const addonNameMap = {
                        'pendant': { name: 'Flitt Locust Pendant', price: 15 },
                        'audiobook_addon': { name: 'MAYA: Seed Takes Root Audiobook', price: 20 },
                        'built_env_addon': { name: 'Built Environments of MAYA Hardcover', price: 25 },
                        'lorebook_addon': { name: 'MAYA Lorebook', price: 25 }
                    };
                    
                    for (const [key, addonInfo] of Object.entries(addonNameMap)) {
                        const quantity = addons[key] || 0;
                        if (quantity > 0) {
                            const addonId = 'original-addon-' + userData.backerNumber + '-' + key;
                            const addonInCart = cart.find(item => item.id === addonId);
                            
                            if (!addonInCart) {
                                cart.push({
                                    id: addonId,
                                    name: addonInfo.name,
                                    price: addonInfo.price,
                                    quantity: quantity,
                                    isOriginalAddon: true, // Mark as unremovable
                                    kickstarterAddonKey: key // Store original key for reference
                                });
                                console.log(`‚úì Added Kickstarter addon to cart: ${addonInfo.name} (x${quantity})`);
                            }
                        }
                    }
                    
                    sessionStorage.setItem('cart', JSON.stringify(cart));
                }

                // Store reward title for responsive image switching
                currentRewardTitle = userData.rewardTitle || '';
                
                // Load pledge image based on reward title (handle undefined/null)
                loadPledgeImage(userData.rewardTitle || '');

                // Build items list
                const items = userData.kickstarterItems || {};
                const addons = userData.kickstarterAddons || {};
                
                const itemNames = {
                    ebook: 'MAYA : Seed Takes Root e-book (Edition Zero)',
                    paperback: 'MAYA : Seed Takes Root Paperback (Edition Zero)',
                    audiobook: 'MAYA : Seed Takes Root Audiobook (Narrated by Hugo Weaving)',
                    hardcover: 'MAYA : Seed Takes Root Hardcover (Edition Zero)',
                    book2_hardcover: 'MAYA : Whispers In The Soil | Book 2 Hardcover',
                    book3_hardcover: 'MAYA : It Becomes The Forest | Book 3 Hardcover',
                    book2_live: 'MAYA : Whispers In The Soil | Book 2 Live Access',
                    book3_live: 'MAYA : It Becomes The Forest | Book 3 Live Access',
                    lorebook: 'MAYA Lore : It\'s Species And Their Cultures (Edition Zero)',
                    built_env: 'Built Environments of MAYA Hardcover (Phase 1 & 2)',
                    pendant: 'Flitt Locust Pendant',
                    art_book: 'Limited Edition MAYA Art Book'
                };
                
                const addonNames = {
                    pendant: 'Flitt Locust Pendant',
                    audiobook_addon: 'MAYA: Seed Takes Root Audiobook',
                    built_env_addon: 'Built Environments of MAYA Hardcover',
                    lorebook_addon: 'MAYA Lorebook'
                };

                let itemsArray = [];

                // Add main items
                for (const [key, name] of Object.entries(itemNames)) {
                    const quantity = items[key] || 0;
                    if (quantity > 0) {
                        itemsArray.push(name);
                    }
                }

                // Add Kickstarter add-ons
                for (const [key, name] of Object.entries(addonNames)) {
                    const quantity = addons[key] || 0;
                    if (quantity > 0) {
                        itemsArray.push(name);
                    }
                }

                // Display items as comma-separated text
                const itemsListEl = document.getElementById('items-list');
                if (itemsListEl) {
                    if (itemsArray.length > 0) {
                        itemsListEl.textContent = itemsArray.join(', ');
                    } else if (rewardTitle && rewardTitle.trim().length > 0) {
                        itemsListEl.textContent = 'No items listed for this pledge tier.';
                    } else {
                        itemsListEl.textContent = 'Upgrade to a pledge tier to see included items.';
                    }
                }
                
                // Show/hide warning message for backers without pledge
                const warningEl = document.getElementById('no-pledge-warning');
                if (warningEl) {
                    warningEl.style.display = hasValidPledge ? 'none' : 'block';
                }
                
                // Sync pledge button states with cart after user data loads
                // Use setTimeout to ensure buttons are rendered first
                setTimeout(() => syncPledgeButtonsWithCart(), 200);

            } catch (error) {
                console.error('Error loading user data:', error);
                const itemsListEl = document.getElementById('items-list');
                if (itemsListEl) {
                    itemsListEl.textContent = 'Unable to load pledge information. Please refresh the page.';
                }
                // Try to load a default image even on error
                const pledgeImage = document.getElementById('pledge-image');
                if (pledgeImage) {
                    const isMobile = window.innerWidth <= 768;
                    const defaultImage = isMobile 
                        ? '/images/pledges/upgrade-pledge-mobile.webp' 
                        : '/images/pledges/upgrade-pledge-desktop.webp';
                    pledgeImage.src = defaultImage;
                    pledgeImage.alt = 'Your Pledge';
                    pledgeImage.style.display = 'block';
                }
            }
        }

        // Store current reward title globally for responsive image switching
        let currentRewardTitle = '';

        // Handle window resize to switch between mobile and desktop images
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                // Reload image (works for both pledge tiers and no-pledge upgrade message)
                loadPledgeImage(currentRewardTitle);
            }, 250); // Debounce resize events
        });

        // Check for completed order and show locked view if exists
        async function checkCompletedOrder() {
            try {
                console.log('Checking for completed order...');
                const response = await fetch('/api/user/completed-order');
                if (!response.ok) {
                    console.log('No completed order check - continuing with shopping view');
                    return false;
                }
                
                const data = await response.json();
                
                if (data.hasCompletedOrder && data.order) {
                    console.log('‚úì User has completed order:', data.order.id);
                    showCompletedOrderView(data.order);
                    return true;
                }
                
                console.log('No completed order found - showing shopping view');
                return false;
            } catch (error) {
                console.error('Error checking completed order:', error);
                return false;
            }
        }
        
        // Display the completed order view
        function showCompletedOrderView(order) {
            // Store order data for edit functionality
            currentOrderData = order;
            
            // Hide shopping view
            document.getElementById('shopping-view').style.display = 'none';

            // Show completed order view
            const completedView = document.getElementById('order-completed-view');
            completedView.style.display = 'block';
            
            // Populate order items
            const itemsContainer = document.getElementById('completed-order-items');
            if (order.items && order.items.length > 0) {
                itemsContainer.innerHTML = order.items.map(item => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #1e1e1e;">
                        <div>
                            <span style="color: #ffffff; font-weight: 500;">${item.name}</span>
                            ${item.quantity > 1 ? `<span style="color: #a0a0a0; margin-left: 8px;">x${item.quantity}</span>` : ''}
                        </div>
                        <span style="color: #ffffff;">$${parseFloat(item.price || 0).toFixed(2)}</span>
                    </div>
                `).join('');
            } else {
                itemsContainer.innerHTML = '<p style="color: #a0a0a0;">No items in order</p>';
            }
            
            // Populate totals
            document.getElementById('completed-subtotal').textContent = '$' + parseFloat(order.addonsSubtotal || 0).toFixed(2);
            document.getElementById('completed-shipping').textContent = '$' + parseFloat(order.shippingCost || 0).toFixed(2);
            document.getElementById('completed-total').textContent = '$' + parseFloat(order.total || 0).toFixed(2);
            
            // Populate shipping address
            const addressContainer = document.getElementById('completed-shipping-address');
            const addr = order.shippingAddress || {};
            addressContainer.innerHTML = `
                <div style="font-weight: 600; color: #ffffff; margin-bottom: 8px;">${addr.fullName || 'N/A'}</div>
                <div>${addr.addressLine1 || ''}</div>
                ${addr.addressLine2 ? `<div>${addr.addressLine2}</div>` : ''}
                <div>${addr.city || ''}, ${addr.state || ''} ${addr.postalCode || ''}</div>
                <div>${addr.country || ''}</div>
                ${addr.phone ? `<div style="margin-top: 8px;">Phone: ${addr.phone}</div>` : ''}
                ${addr.email ? `<div>Email: ${addr.email}</div>` : ''}
            `;
            
            // Update payment status display
            const paymentStatusContainer = document.getElementById('completed-payment-status');
            if (order.paid) {
                paymentStatusContainer.innerHTML = `
                    <span style="font-size: 24px;">‚úÖ</span>
                    <span style="color: #059669; font-weight: 600;">Payment completed</span>
                `;
            } else if (order.paymentStatus === 'card_saved') {
                paymentStatusContainer.innerHTML = `
                    <span style="font-size: 24px;">üí≥</span>
                    <span style="color: #a0a0a0;">Card saved - will be charged when order ships</span>
                `;
            } else {
                paymentStatusContainer.innerHTML = `
                    <span style="font-size: 24px;">‚è≥</span>
                    <span style="color: #f59e0b;">Payment pending</span>
                `;
            }
            
            console.log('‚úì Completed order view displayed');
        }
        
        // Store current order data for edit functionality
        let currentOrderData = null;
        
        // Toggle address edit mode
        function toggleAddressEdit(showEdit) {
            const displayMode = document.getElementById('completed-shipping-address');
            const editForm = document.getElementById('edit-address-form');
            const editBtn = document.getElementById('edit-address-btn');
            const errorDiv = document.getElementById('edit-address-error');
            
            if (showEdit) {
                // Populate form with current values
                if (currentOrderData && currentOrderData.shippingAddress) {
                    const addr = currentOrderData.shippingAddress;
                    document.getElementById('edit-fullName').value = addr.fullName || '';
                    document.getElementById('edit-email').value = addr.email || '';
                    document.getElementById('edit-addressLine1').value = addr.addressLine1 || '';
                    document.getElementById('edit-addressLine2').value = addr.addressLine2 || '';
                    document.getElementById('edit-city').value = addr.city || '';
                    document.getElementById('edit-state').value = addr.state || '';
                    document.getElementById('edit-postalCode').value = addr.postalCode || '';
                    document.getElementById('edit-country').value = addr.country || '';
                    document.getElementById('edit-phone').value = addr.phone || '';
                }
                
                displayMode.style.display = 'none';
                editForm.style.display = 'block';
                editBtn.style.display = 'none';
                errorDiv.style.display = 'none';
            } else {
                displayMode.style.display = 'block';
                editForm.style.display = 'none';
                editBtn.style.display = 'inline-block';
                errorDiv.style.display = 'none';
            }
        }
        
        // Save address edit
        async function saveAddressEdit() {
            const saveBtn = document.getElementById('save-address-btn');
            const errorDiv = document.getElementById('edit-address-error');
            
            // Gather form data
            const newAddress = {
                fullName: document.getElementById('edit-fullName').value.trim(),
                email: document.getElementById('edit-email').value.trim(),
                addressLine1: document.getElementById('edit-addressLine1').value.trim(),
                addressLine2: document.getElementById('edit-addressLine2').value.trim(),
                city: document.getElementById('edit-city').value.trim(),
                state: document.getElementById('edit-state').value.trim(),
                postalCode: document.getElementById('edit-postalCode').value.trim(),
                country: document.getElementById('edit-country').value.trim(),
                phone: document.getElementById('edit-phone').value.trim()
            };
            
            // Basic validation
            if (!newAddress.fullName || !newAddress.addressLine1 || !newAddress.city || !newAddress.country || !newAddress.postalCode) {
                errorDiv.textContent = 'Please fill in all required fields (marked with *)';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Disable button while saving
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';
            errorDiv.style.display = 'none';
            
            try {
                const response = await fetch('/api/order/update-shipping-address', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        orderId: currentOrderData.id,
                        shippingAddress: newAddress
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to update address');
                }
                
                console.log('‚úì Address updated successfully');
                
                // Update local data
                currentOrderData.shippingAddress = newAddress;
                
                // Update the display
                const addressContainer = document.getElementById('completed-shipping-address');
                addressContainer.innerHTML = `
                    <div style="font-weight: 600; color: #ffffff; margin-bottom: 8px;">${newAddress.fullName}</div>
                    <div>${newAddress.addressLine1}</div>
                    ${newAddress.addressLine2 ? `<div>${newAddress.addressLine2}</div>` : ''}
                    <div>${newAddress.city}, ${newAddress.state || ''} ${newAddress.postalCode}</div>
                    <div>${newAddress.country}</div>
                    ${newAddress.phone ? `<div style="margin-top: 8px;">Phone: ${newAddress.phone}</div>` : ''}
                    ${newAddress.email ? `<div>Email: ${newAddress.email}</div>` : ''}
                `;
                
                // Switch back to display mode
                toggleAddressEdit(false);
                
            } catch (error) {
                console.error('Error saving address:', error);
                errorDiv.textContent = error.message || 'Failed to save address. Please try again.';
                errorDiv.style.display = 'block';
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Changes';
            }
        }

        // Initialize - loadUserData must complete before loadProducts
        // so that hasValidPledge is set correctly before rendering add-on buttons
        async function init() {
            // First check if user has a completed order
            const hasCompletedOrder = await checkCompletedOrder();
            
            if (hasCompletedOrder) {
                // User has completed checkout - show locked view only
                // No need to load products or user data for shopping
                return;
            }
            
            // No completed order - show shopping view
            await loadUserData();
            await loadProducts();
            updateCart();
        }
        init();
        
        // Re-sync cart when page is shown (handles browser back/forward cache)
        window.addEventListener('pageshow', function(event) {
            // If page is loaded from cache, refresh the cart state
            if (event.persisted) {
                console.log('Page loaded from cache, refreshing cart state...');
                cart = JSON.parse(sessionStorage.getItem('cart')) || [];
                updateCart();
                // Re-render products to update "Added" buttons
                if (typeof products !== 'undefined' && products.length > 0) {
                    const pledgeNames = ['humble vaanar', 'industrious manushya', 'resplendent garuda', 'benevolent divya', 'founders of neh'];
                    const addOnsOnly = products.filter(p => 
                        !pledgeNames.some(pledge => p.name.toLowerCase().includes(pledge))
                    );
                    displayProducts(addOnsOnly);
                }
            }
        });
    </script>
</body>
</html>
