<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shipping - MAYA Pledge Manager</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div>
                <h1>MAYA Pledge Manager</h1>
                <p>Shipping Information</p>
            </div>
            <div class="user-info">
                <a href="/logout" style="color: white;">Logout</a>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Progress Bar -->
        <div class="progress-bar">
            <div class="progress-step completed clickable" onclick="window.location.href='/dashboard'">
                <div class="progress-circle">✓</div>
                <div class="progress-label">Your Order</div>
            </div>
            <div class="progress-step completed clickable" onclick="window.location.href='/addons'">
                <div class="progress-circle">✓</div>
                <div class="progress-label">Add-ons</div>
            </div>
            <div class="progress-step active">
                <div class="progress-circle">3</div>
                <div class="progress-label">Shipping</div>
            </div>
            <div class="progress-step clickable" onclick="window.location.href='/checkout'">
                <div class="progress-circle">4</div>
                <div class="progress-label">Payment</div>
            </div>
        </div>

        <div class="shipping-layout" style="display: grid; grid-template-columns: 1fr 400px; gap: 30px;">
            <!-- Shipping Form -->
            <div>
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Shipping Address</h2>
                        <p class="card-subtitle">Where should we send your items?</p>
                    </div>

                    <form id="shipping-form">
                        <div class="form-group">
                            <label class="form-label" for="fullName">Full Name *</label>
                            <input type="text" id="fullName" name="fullName" class="form-input" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="addressLine1">Address Line 1 *</label>
                            <input type="text" id="addressLine1" name="addressLine1" class="form-input" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="addressLine2">Address Line 2</label>
                            <input type="text" id="addressLine2" name="addressLine2" class="form-input">
                        </div>

                        <div class="form-grid-2" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label class="form-label" for="city">City *</label>
                                <input type="text" id="city" name="city" class="form-input" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="state">State/Province *</label>
                                <input type="text" id="state" name="state" class="form-input" required>
                            </div>
                        </div>

                        <div class="form-grid-2" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label class="form-label" for="postalCode">Postal/Zip Code *</label>
                                <input type="text" id="postalCode" name="postalCode" class="form-input" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="country">Country *</label>
                                <select id="country" name="country" class="form-select" required onchange="calculateShipping()">
                                    <option value="">Select Country</option>
                                    <option value="US">United States</option>
                                    <option value="CA">Canada</option>
                                    <option value="GB">United Kingdom</option>
                                    <option value="AU">Australia</option>
                                    <option value="DE">Germany</option>
                                    <option value="FR">France</option>
                                    <option value="IT">Italy</option>
                                    <option value="ES">Spain</option>
                                    <option value="IN">India</option>
                                    <option value="JP">Japan</option>
                                    <option value="MX">Mexico</option>
                                    <option value="BR">Brazil</option>
                                    <option value="NL">Netherlands</option>
                                    <option value="SE">Sweden</option>
                                    <option value="CH">Switzerland</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="phone">Phone Number *</label>
                            <input type="tel" id="phone" name="phone" class="form-input" required>
                        </div>

                        <button type="button" class="btn btn-secondary" onclick="window.location.href='/addons'">
                            ← Back to Add-ons
                        </button>
                    </form>
                </div>
            </div>

            <!-- Order Summary -->
            <div>
                <div class="cart-summary">
                    <h3 style="margin-bottom: 20px; color: var(--primary-red);">Order Summary</h3>
                    
                    <div id="order-items">
                        <!-- Items will be loaded here -->
                    </div>

                    <div class="cart-item">
                        <strong>Add-ons Subtotal:</strong>
                        <strong>$<span id="addons-subtotal">0.00</span></strong>
                    </div>

                    <div class="cart-item">
                        <strong>Shipping:</strong>
                        <strong id="shipping-cost-display">-</strong>
                    </div>

                    <div class="cart-total">
                        <span>Total to Pay:</span>
                        <span>$<span id="grand-total">0.00</span></span>
                    </div>

                    <div class="alert alert-info" style="margin-top: 15px; font-size: 14px;">
                        ℹ️ You already paid for your Kickstarter pledge. This is only for add-ons and shipping.
                    </div>

                    <button 
                        id="proceed-checkout-btn" 
                        class="btn btn-primary btn-block mt-20"
                        onclick="proceedToCheckout()"
                        disabled>
                        Proceed to Payment →
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let cart = JSON.parse(sessionStorage.getItem('cart')) || [];
        let shippingCost = 0;

        function loadOrderSummary() {
            const itemsDiv = document.getElementById('order-items');
            let subtotal = 0;

            if (cart.length === 0) {
                itemsDiv.innerHTML = `
                    <div class="cart-item" style="color: var(--text-muted); font-style: italic;">
                        No add-ons selected
                    </div>
                `;
                document.getElementById('addons-subtotal').textContent = '0.00';
                updateGrandTotal();
                return;
            }

            let html = '';
            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;
                html += `
                    <div class="cart-item">
                        <div>
                            <strong>${item.name}</strong><br>
                            <small style="color: var(--text-muted);">Qty: ${item.quantity}</small>
                        </div>
                        <div>$${itemTotal.toFixed(2)}</div>
                    </div>
                `;
            });

            itemsDiv.innerHTML = html;
            document.getElementById('addons-subtotal').textContent = subtotal.toFixed(2);
            updateGrandTotal();
        }

        function loadShippingData() {
            // Load saved shipping data from sessionStorage
            const savedAddress = sessionStorage.getItem('shippingAddress');
            if (savedAddress) {
                const address = JSON.parse(savedAddress);
                document.getElementById('fullName').value = address.fullName || '';
                document.getElementById('addressLine1').value = address.addressLine1 || '';
                document.getElementById('addressLine2').value = address.addressLine2 || '';
                document.getElementById('city').value = address.city || '';
                document.getElementById('state').value = address.state || '';
                document.getElementById('postalCode').value = address.postalCode || '';
                document.getElementById('country').value = address.country || '';
                document.getElementById('phone').value = address.phone || '';
                
                // Recalculate shipping if country is set
                if (address.country) {
                    calculateShipping();
                }
            }
        }

        function saveShippingData() {
            // Save form data to sessionStorage as user types
            const address = {
                fullName: document.getElementById('fullName').value,
                addressLine1: document.getElementById('addressLine1').value,
                addressLine2: document.getElementById('addressLine2').value,
                city: document.getElementById('city').value,
                state: document.getElementById('state').value,
                postalCode: document.getElementById('postalCode').value,
                country: document.getElementById('country').value,
                phone: document.getElementById('phone').value
            };
            sessionStorage.setItem('shippingAddress', JSON.stringify(address));
        }

        async function calculateShipping() {
            const country = document.getElementById('country').value;
            
            if (!country || country === '') {
                document.getElementById('shipping-cost-display').textContent = '-';
                document.getElementById('proceed-checkout-btn').disabled = true;
                return;
            }

            try {
                const response = await fetch('/api/calculate-shipping', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        country: country,
                        cartItems: cart
                    })
                });

                const data = await response.json();
                shippingCost = data.shippingCost;
                
                document.getElementById('shipping-cost-display').textContent = '$' + shippingCost.toFixed(2);
                updateGrandTotal();
                
                // Enable checkout button if form is valid
                validateForm();
            } catch (error) {
                console.error('Error calculating shipping:', error);
            }
        }

        function updateGrandTotal() {
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const total = subtotal + shippingCost;
            document.getElementById('grand-total').textContent = total.toFixed(2);
        }

        function validateForm() {
            const form = document.getElementById('shipping-form');
            const proceedBtn = document.getElementById('proceed-checkout-btn');
            
            const isValid = form.checkValidity() && shippingCost >= 0;
            proceedBtn.disabled = !isValid;
        }

        function proceedToCheckout() {
            const form = document.getElementById('shipping-form');
            
            if (!form.checkValidity()) {
                alert('Please fill in all required fields.');
                return;
            }

            if (!document.getElementById('country').value) {
                alert('Please select a country to calculate shipping.');
                return;
            }

            // Save shipping address
            const shippingAddress = {
                fullName: document.getElementById('fullName').value,
                addressLine1: document.getElementById('addressLine1').value,
                addressLine2: document.getElementById('addressLine2').value,
                city: document.getElementById('city').value,
                state: document.getElementById('state').value,
                postalCode: document.getElementById('postalCode').value,
                country: document.getElementById('country').value,
                phone: document.getElementById('phone').value
            };

            sessionStorage.setItem('shippingAddress', JSON.stringify(shippingAddress));
            sessionStorage.setItem('shippingCost', shippingCost.toString());

            window.location.href = '/checkout';
        }

        // Add event listeners to form inputs
        document.getElementById('shipping-form').addEventListener('input', function() {
            validateForm();
            saveShippingData(); // Save data as user types
        });
        document.getElementById('country').addEventListener('change', calculateShipping);

        loadOrderSummary();
        loadShippingData(); // Load saved data when page loads
    </script>
</body>
</html>

