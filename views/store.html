<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAYA Store - Pre-Order Now</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.4); display:flex; align-items:center; justify-content:center; z-index:1000; }
        .modal { background:#1e1e1e; border-radius:8px; width:90%; max-width:700px; box-shadow:0 10px 30px rgba(0,0,0,0.2); }
        .modal-header { display:flex; align-items:center; justify-content:space-between; padding:16px 20px; border-bottom:2px solid var(--border-color); }
        .modal-body { padding:16px 20px; max-height:60vh; overflow:auto; }
        .modal-footer { padding:12px 20px; border-top:2px solid var(--border-color); }
        .modal-close { background:none; border:none; font-size:22px; cursor:pointer; color: #ffffff; }
        .modal-close:hover { color: var(--primary-red); }

        /* Cart button hover effects */
        .quantity-selector button:hover {
            background: #1a1a1a !important;
        }
        
        .quantity-selector button:active {
            background: #e5e5e5 !important;
        }
        
        button[onclick^="removeFromCart"]:hover {
            background: #dc2626 !important;
        }

        /* Button transition effects */
        .btn {
            transition: all 0.3s ease;
        }

        /* Product card hover effects */
        #products-grid > div {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        #products-grid > div:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        /* Button hover effects */
        button:not(.modal-close):not([onclick*="toggle"]):hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        button:not(.modal-close):not([onclick*="toggle"]):active {
            transform: translateY(0);
        }

        /* Add to cart success animation */
        @keyframes buttonSuccess {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes pulseGreen {
            0% { box-shadow: 0 0 0 0 rgba(5, 150, 105, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(5, 150, 105, 0); }
            100% { box-shadow: 0 0 0 0 rgba(5, 150, 105, 0); }
        }

        .button-added {
            animation: buttonSuccess 0.4s ease, pulseGreen 0.6s ease;
        }

        /* Desktop: What You Get comes first, Price/Button second */
        @media (min-width: 769px) {
            .hero-price-button {
                order: 2 !important;
            }

            .hero-what-you-get {
                order: 1 !important;
            }
        }

        /* Green checkout button hover */
        .btn-checkout-green,
        .btn-checkout-green.btn-primary,
        button.btn-checkout-green {
            background: #059669 !important;
            border-color: #059669 !important;
            background-color: #059669 !important;
        }

        .btn-checkout-green:hover,
        .btn-checkout-green.btn-primary:hover,
        button.btn-checkout-green:hover {
            background: #047857 !important;
            border-color: #047857 !important;
            background-color: #047857 !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
        }
        
        @media (max-width: 1400px) {
            .container {
                padding: 40px 40px !important;
            }
        }

        @media (max-width: 1100px) {
            .container {
                padding: 30px 30px !important;
            }

            /* Hero Section */
            .container > div:first-of-type {
                flex-direction: column !important;
                gap: 40px !important;
            }

            .container > div:first-of-type > div:first-child {
                flex: 1 !important;
                width: 100% !important;
                min-height: 500px !important;
            }

            /* Stats Section */
            .container > div:nth-of-type(2) {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 20px !important;
            }

            .container > div:nth-of-type(2) > div:first-child {
                grid-column: 1 / -1 !important;
            }

            .addons-grid {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)) !important;
            }
        }

        @media (max-width: 768px) {
            /* Mobile Navbar - Smaller and Optimized */
            #navbar {
                padding: 8px 20px !important;
            }

            #navbar > div:first-child {
                height: 24px !important;
            }

            #navbar img {
                height: 24px !important;
            }

            #navbar .nav-right {
                gap: 15px !important;
            }

            #navbar .nav-right img {
                height: 20px !important;
                width: 20px !important;
            }

            .container {
                padding: 20px !important;
            }

            /* Hero Section Mobile - Smaller Image */
            .container > div:first-of-type {
                margin-bottom: 40px !important;
            }

            .container > div:first-of-type > div:first-child {
                min-height: 300px !important;
                max-height: 350px !important;
                padding: 20px !important;
            }

            /* Ensure parent maintains flexbox for order to work */
            .container > div:first-of-type > div:last-child {
                display: flex !important;
                flex-direction: column !important;
            }

            .container > div:first-of-type > div:last-child h1 {
                font-size: 28px !important;
            }

            .container > div:first-of-type > div:last-child p {
                font-size: 14px !important;
            }

            /* Mobile spacing adjustments */
            .hero-price-button {
                margin-bottom: 20px !important;
            }

            .hero-what-you-get {
                margin-bottom: 0 !important;
            }

            .container > div:first-of-type > div:last-child > div:first-child {
                font-size: 36px !important;
            }

            .container > div:first-of-type > div:last-child button {
                width: 100% !important;
                font-size: 18px !important;
            }

            /* Stats Section Mobile */
            .container > div:nth-of-type(2) {
                grid-template-columns: 1fr !important;
                gap: 15px !important;
                margin-bottom: 40px !important;
            }

            /* Product Details Section Mobile */
            .container > div:nth-of-type(3) {
                margin-bottom: 40px !important;
            }

            /* All major sections mobile spacing */
            .container > div[style*="margin-bottom: 60px"] {
                margin-bottom: 40px !important;
            }

            .container > div:nth-of-type(2) > div {
                padding: 20px !important;
            }

            .container > div:nth-of-type(2) > div:first-child p {
                font-size: 18px !important;
            }

            /* Pledge Tiers Section Mobile */
            #pledge-tiers-grid {
                gap: 16px !important;
            }

            .pledge-dropdown-content img {
                max-height: 300px !important;
            }

            /* Section Headers Mobile - Reduced spacing */
            div[style*="margin-bottom: 40px"][style*="text-align: center"] {
                margin-bottom: 30px !important;
                padding: 20px !important;
            }

            /* Add-ons Grid Mobile */
            .addons-grid {
                grid-template-columns: 1fr !important;
                gap: 24px !important;
            }
        }
    </style>
</head>
<body style="background: #0a0a0a !important; color: #ffffff !important;">
    <!-- Header with Logo -->
    <div id="navbar" style="background: #1a1a1a; padding: 10px 60px; display: flex; align-items: center; justify-content: space-between; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; transition: transform 0.3s ease;">
        <a href="/" style="height: 30px; width: auto; display: block;">
            <img src="/images/maya-logo.png" alt="MAYA" style="height: 100%; width: auto; object-fit: contain; cursor: pointer;">
        </a>
        <div class="nav-right" style="display: flex; align-items: center; gap: 20px;">
            <a id="ebook-link" href="/ebook" style="display: none; background: #dc2626; color: #ffffff; padding: 8px 18px; border-radius: 6px; text-decoration: none; font-weight: 700; font-size: 14px; letter-spacing: 0.3px; transition: background 0.2s;">Download E-Book</a>
            <a id="profile-link" href="/login" style="background: none; border: none; cursor: pointer; position: relative; padding: 5px; text-decoration: none; color: inherit; display: flex; align-items: center;" title="Login">
                <img src="/images/icons/Profile.svg" alt="Profile" style="height: 24px; width: 24px;">
            </a>
            <button onclick="scrollToCart()" style="background: none; border: none; cursor: pointer; position: relative; padding: 5px; display: flex; align-items: center;">
                <img src="/images/icons/cart-01.svg" alt="Cart" style="height: 24px; width: 24px;">
                <span id="cart-count-badge" style="background: var(--primary-red); color: white; border-radius: 50%; padding: 2px 6px; font-size: 11px; font-weight: bold; position: absolute; top: 0; right: 0; display: none;">0</span>
            </button>
        </div>
    </div>
    
    <!-- Spacer for fixed navbar -->
    <div style="height: 50px;"></div>

    <div class="container" style="max-width: 1400px; margin: 0 auto; padding: 60px 80px;">
        <!-- Hero Section -->
        <div style="display: flex; gap: 80px; margin-bottom: 60px; align-items: center; max-width: 1200px; margin-left: auto; margin-right: auto;">
            <!-- Left: Pledge Image -->
            <div style="flex: 0 0 550px; background: #1e1e1e; border-radius: 16px; display: flex; align-items: center; justify-content: center; min-height: 600px; padding: 20px;">
                <img src="/images/hero/divya.png" alt="The Benevolent Divya" style="max-width: 100%; max-height: 100%; width: auto; height: auto; object-fit: contain;">
            </div>

            <!-- Right: Pledge Details -->
            <div style="flex: 1; display: flex; flex-direction: column; justify-content: center;">
                <h1 style="font-family: 'Inter', sans-serif; font-weight: 800; font-size: 42px; line-height: 1.2; margin: 0 0 24px 0; color: #ffffff;">
                    The Benevolent Divya
                </h1>
                <p style="font-family: 'Inter', sans-serif; font-weight: 400; font-size: 18px; line-height: 1.6; margin: 0 0 30px 0; color: #ffffff;">
                    Deluxe pledge tier with rare collectibles. An epic sci-fiction fantasy with intricate worldbuilding. Six species, one planet, zero privacy. Enter the age of narrative warfare.
                </p>

                <!-- Price and Button (Mobile: order 1, Desktop: order 2) -->
                <div class="hero-price-button" style="display: flex; align-items: center; gap: 20px; order: 1; margin-bottom: 24px;">
                    <!-- Price with backer badge -->
                    <div id="hero-price-container" style="display: flex; flex-direction: column; gap: 4px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-family: 'Inter', sans-serif; font-weight: 700; color: #ffffff; font-size: 36px; line-height: 1;">$<span id="hero-book-price">190</span></span>
                            <span id="hero-backer-badge" style="display: none; background: #059669; color: white; padding: 4px 8px; border-radius: 4px; font-family: 'Inter', sans-serif; font-weight: 600; font-size: 11px; text-transform: uppercase;">BACKER</span>
                        </div>
                        <span id="hero-original-price" style="display: none; font-family: 'Inter', sans-serif; font-weight: 500; font-size: 18px; color: #999; text-decoration: line-through;"></span>
                    </div>

                    <!-- Add to Cart Button -->
                    <button id="hero-add-btn" onclick="addHeroBookToCart()" style="background: #dc2626; border: 1px solid #dc2626; color: #ffffff; padding: 12px 28px; border-radius: 10px; font-family: 'Inter', sans-serif; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                        Add to Cart
                    </button>
                </div>

                <!-- What You Get List (Mobile: order 2, Desktop: order 1) -->
                <div class="hero-what-you-get" style="background: #1e1e1e; border-radius: 8px; padding: 20px; margin-bottom: 24px; order: 2;">
                    <p style="font-family: 'Inter', sans-serif; font-weight: 700; font-size: 14px; color: #dc2626; margin: 0 0 12px 0; text-transform: uppercase; letter-spacing: 0.5px;">What You Get:</p>
                    <ul style="list-style: none; padding: 0; margin: 0; font-size: 13px; line-height: 1.8; color: #ffffff;">
                        <li>â€¢ MAYA: Seed Takes Root (eBook + Hardcover)</li>
                        <li>â€¢ MAYA: Whispers in the Soil (Live Access + Hardcover)</li>
                        <li>â€¢ MAYA: It Becomes the Forest (Live Access + Hardcover)</li>
                        <li>â€¢ Built Environments of MAYA Hardcover</li>
                        <li>â€¢ MAYA Lorebook</li>
                        <li>â€¢ Flitt Locust Pendant</li>
                        <li>â€¢ Audiobook narrated by Hugo Weaving</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Kickstarter Stats Section -->
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 30px; margin-bottom: 60px; max-width: 1200px; margin-left: auto; margin-right: auto;">
            <!-- Message -->
            <div style="display: flex; align-items: center; background: #1e1e1e; padding: 30px; border-radius: 16px;">
                <p style="font-family: 'Roboto', sans-serif; font-weight: 700; font-size: 22px; line-height: 1.4; margin: 0; color: #ffffff;">
                    This project was successfully funded on Kickstarter.
                </p>
            </div>

            <!-- Raised Amount -->
            <div style="background: #0f0f0f; padding: 30px; border-radius: 16px;">
                <p style="font-family: 'Inter', sans-serif; font-weight: 600; font-size: 14px; line-height: 1.4; margin: 0 0 12px 0; color: #ffffff; text-transform: uppercase; letter-spacing: 0.5px;">Raised on Kickstarter</p>
                <p style="font-family: 'Inter', sans-serif; font-weight: 700; font-size: 28px; line-height: 1.2; margin: 0 0 8px 0; color: #ffffff;">US$ 423,621</p>
                <p style="font-family: 'Inter', sans-serif; font-weight: 400; font-size: 14px; line-height: 1.4; margin: 0; color: #ffffff;">pledged of US$ 10,000 goal</p>
            </div>

            <!-- Backers -->
            <div style="background: #0f0f0f; padding: 30px; border-radius: 16px;">
                <p style="font-family: 'Inter', sans-serif; font-weight: 600; font-size: 14px; line-height: 1.4; margin: 0 0 12px 0; color: #ffffff; text-transform: uppercase; letter-spacing: 0.5px;">Backers</p>
                <p style="font-family: 'Inter', sans-serif; font-weight: 700; font-size: 28px; line-height: 1.2; margin: 0 0 8px 0; color: #ffffff;">4,157</p>
                <p style="font-family: 'Inter', sans-serif; font-weight: 400; font-size: 14px; line-height: 1.4; margin: 0; color: #ffffff;">Backers love this project</p>
            </div>

            <!-- Funded Date -->
            <div style="background: #0f0f0f; padding: 30px; border-radius: 16px;">
                <p style="font-family: 'Inter', sans-serif; font-weight: 600; font-size: 14px; line-height: 1.4; margin: 0 0 12px 0; color: #ffffff; text-transform: uppercase; letter-spacing: 0.5px;">Funded On</p>
                <p style="font-family: 'Inter', sans-serif; font-weight: 700; font-size: 28px; line-height: 1.2; margin: 0; color: #ffffff;">14.10.2025</p>
            </div>
        </div>

        <!-- Product Details (Collapsible) -->
        <div style="background: #0f0f0f; border-radius: 16px; padding: 30px; margin-bottom: 60px; max-width: 1200px; margin-left: auto; margin-right: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <button onclick="toggleProductDetails()" style="background: none; border: none; cursor: pointer; padding: 0; font-family: 'Inter', sans-serif; font-weight: 700; font-size: 22px; line-height: 1.4; color: #ffffff;">
                    Product Details
                </button>
                <button onclick="toggleProductDetails()" style="background: none; border: none; cursor: pointer; padding: 0; font-size: 24px; color: #ffffff; transform-origin: center; transition: transform 0.3s;" id="details-arrow">
                    â–¼
                </button>
            </div>
            <div id="product-details-content" style="display: none; padding: 24px 0 0 0;">
                <ul style="font-family: 'Inter', sans-serif; font-weight: 400; font-size: 16px; line-height: 1.8; margin: 0; padding-left: 20px; color: #ffffff; list-style-type: disc;">
                    <li>342 pages</li>
                    <li>Magical anaglyph art reveal on cover</li>
                    <li>Free flitt locust bookmark</li>
                    <li>A detailed appendix of the world</li>
                    <li>2 full-spread colored illustrations</li>
                    <li>Munken 80GSM paper</li>
                    <li>Premium size of 9 Ã— 6 inches</li>
                </ul>
            </div>
        </div>

        <!-- Other Pledge Tiers Section -->
        <div style="margin-bottom: 60px;">
            <div style="background: #1a1a1a; border-radius: 16px; padding: 30px; margin-bottom: 40px; max-width: 1200px; margin-left: auto; margin-right: auto; text-align: center;">
                <h2 style="font-family: 'Inter', sans-serif; font-weight: 700; font-size: 28px; line-height: 1.4; margin: 0 0 8px 0; color: #ffffff;">
                    Other Pledge Tiers
                </h2>
                <p style="font-family: 'Inter', sans-serif; font-weight: 400; font-size: 16px; line-height: 1.5; margin: 0; color: #ffffff;">
                    Choose from our complete collection of pledge tiers
                </p>
            </div>

            <!-- Pledge Tiers Accordion -->
            <div id="pledge-tiers-grid" style="display: flex; flex-direction: column; gap: 20px; margin-bottom: 0; max-width: 1200px; margin-left: auto; margin-right: auto;">
                <!-- Pledge tiers will be loaded here -->
            </div>
        </div>

        <!-- Add-ons Section Header -->
        <div style="background: #1a1a1a; border-radius: 16px; padding: 30px; margin-bottom: 40px; max-width: 1200px; margin-left: auto; margin-right: auto; text-align: center;">
            <h2 style="font-family: 'Inter', sans-serif; font-weight: 700; font-size: 28px; line-height: 1.4; margin: 0 0 8px 0; color: #ffffff;">
                Enhance Your Pledge
            </h2>
            <p style="font-family: 'Inter', sans-serif; font-weight: 400; font-size: 16px; line-height: 1.5; margin: 0; color: #ffffff;">
                Add exclusive items to your order
            </p>
        </div>

        <!-- Products Grid -->
        <div class="addons-grid" id="products-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 40px; margin-bottom: 60px; max-width: 1200px; margin-left: auto; margin-right: auto;">
            <!-- Products will be loaded here -->
            <div style="text-align: center; padding: 40px; grid-column: 1 / -1;">
                <div class="spinner"></div>
                <p style="color: var(--text-muted); margin-top: 20px;">Loading products...</p>
            </div>
        </div>

        <!-- Floating Checkout Button (shown when cart has items) -->
        <div id="floating-checkout" style="position: fixed; bottom: 30px; right: 30px; display: none; z-index: 999;">
            <button class="btn btn-large" onclick="window.location.href='/addons'" style="background: #059669; border-color: #059669; color: white; box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);" onmouseover="this.style.background='#047857'; this.style.borderColor='#047857'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(5, 150, 105, 0.4)';" onmouseout="this.style.background='#059669'; this.style.borderColor='#059669'; this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(5, 150, 105, 0.3)';">
                Proceed to Checkout â†’ <span id="floating-total"></span>
            </button>
        </div>

    </div>

    <script>
        let cart = JSON.parse(sessionStorage.getItem('cart')) || [];
        let products = [];
        let heroBook = null; // Will hold the main book product
        let isBacker = false; // Track if user is a Kickstarter backer

        // Check if user is a backer
        async function checkIfBacker() {
            try {
                const response = await fetch('/api/user/session');
                const data = await response.json();
                // Use the server's isBacker flag which checks backer_number, pledge_amount, or reward_title
                isBacker = data.isBacker === true;
                console.log('User backer status:', isBacker ? 'Kickstarter backer' : 'Non-backer/Guest');
                
                // Show eBook link only for eligible backers (excludes dropped backers)
                const ebookLink = document.getElementById('ebook-link');
                if (ebookLink) {
                    ebookLink.style.display = (data.isLoggedIn && data.isCustomer) ? 'inline' : 'none';
                }

                // Update profile link based on login/backer status
                const profileLink = document.getElementById('profile-link');
                if (profileLink) {
                    if (data.isBacker) {
                        profileLink.href = '/dashboard';
                        profileLink.title = 'Dashboard';
                    } else if (data.isLoggedIn) {
                        profileLink.href = '/';
                        profileLink.title = 'Store';
                    } else {
                        profileLink.href = '/login';
                        profileLink.title = 'Login';
                    }
                }
            } catch (error) {
                console.error('Error checking user status:', error);
                isBacker = false;
            }
        }

        // Check if cart has a pledge OR user is a paid Kickstarter backer (who already has a pledge)
        function hasPledgeInCart() {
            // Paid Kickstarter backers already have a pledge from their KS backing
            if (isBacker) {
                return true;
            }
            
            const pledgeNames = ['humble vaanar', 'industrious manushya', 'resplendent garuda', 'benevolent divya', 'founders of neh'];
            return cart.some(item => {
                // Check item name directly first (most reliable)
                if (item.name) {
                    const nameLower = item.name.toLowerCase();
                    if (pledgeNames.some(pledge => nameLower.includes(pledge))) {
                        return true;
                    }
                }
                
                // Check by item flags
                if (item.isPledgeUpgrade || item.isOriginalPledge || item.isDroppedBackerPledge) {
                    return true;
                }
                
                // Fallback: check via product lookup
                const cartProduct = products.find(p => p.id === item.id);
                if (!cartProduct) return false;
                const isPledgeByName = pledgeNames.some(pledge => cartProduct.name.toLowerCase().includes(pledge));
                const isPledgeByType = cartProduct.type === 'pledge';
                return isPledgeByName || isPledgeByType;
            });
        }

        // Check if product is an add-on
        function isAddon(product) {
            if (!product) return false;
            const pledgeNames = ['humble vaanar', 'industrious manushya', 'resplendent garuda', 'benevolent divya', 'founders of neh'];
            const isPledgeByName = pledgeNames.some(pledge => product.name.toLowerCase().includes(pledge));
            const isPledgeByType = product.type === 'pledge';
            return !isPledgeByName && !isPledgeByType;
        }

        // Load products
        async function loadProducts() {
            try {
                console.log('Loading products from API...');
                const response = await fetch('/api/products');
                
                if (!response.ok) {
                    throw new Error(`API returned ${response.status}: ${response.statusText}`);
                }
                
                products = await response.json();
                console.log(`âœ“ Loaded ${products.length} products from API`);
                
                // Ensure all prices are numbers
                products = products.map(p => ({
                    ...p,
                    price: typeof p.price === 'string' ? parseFloat(p.price) : p.price,
                    weight: p.weight || 0
                }));
                
                // Find the hero pledge (The Benevolent Divya)
                heroBook = products.find(p => 
                    p.name.toLowerCase().includes('benevolent divya')
                );
                
                if (heroBook) {
                    console.log('âœ“ Hero book found:', heroBook.name, `($${heroBook.price})`);
                    // If hero book found, update price in hero section
                    const priceEl = document.getElementById('hero-book-price');
                    if (priceEl) {
                        priceEl.textContent = Math.round(heroBook.price);
                        
                        // Show backer badge and original price if applicable
                        if (heroBook.is_backer_price && heroBook.original_price) {
                            const badge = document.getElementById('hero-backer-badge');
                            const originalPrice = document.getElementById('hero-original-price');
                            const priceContainer = priceEl.parentElement;
                            
                            if (badge) {
                                badge.style.display = 'inline-block';
                            }
                            if (originalPrice) {
                                originalPrice.textContent = `$${Math.round(heroBook.original_price)}`;
                                originalPrice.style.display = 'block';
                            }
                            if (priceContainer) {
                                priceContainer.style.color = '#059669'; // Green for backer price
                            }
                        }
                    }
                } else {
                    console.warn('âš  Hero book "Benevolent Divya" not found in products');
                    console.warn('  Available products:', products.map(p => p.name).join(', '));
                    // Create a fallback hero book with hardcoded values
                    heroBook = {
                        id: 'hero-benevolent-divya',
                        name: 'The Benevolent Divya',
                        price: 190,
                        weight: 0,
                        type: 'pledge'
                    };
                    console.log('  Created fallback hero book for display');
                }
                
                // Load and display pledge tiers
                displayPledgeTiers();
                
                displayProducts();
                updateCart();
            } catch (error) {
                console.error('âœ— Error loading products:', error);
                console.error('  - Error message:', error.message);
                console.error('  - Error stack:', error.stack);
                
                // Create fallback hero book
                heroBook = {
                    id: 'hero-benevolent-divya',
                    name: 'The Benevolent Divya',
                    price: 190,
                    weight: 0,
                    type: 'pledge'
                };
                
                document.getElementById('products-grid').innerHTML = `
                    <div style="text-align: center; padding: 40px; grid-column: 1 / -1;">
                        <p style="color: var(--error-red);">Failed to load products. Please refresh the page.</p>
                        <p style="color: #666; font-size: 14px; margin-top: 10px;">${error.message}</p>
                    </div>
                `;
                // At least show pledge tiers if available
                if (products && products.length > 0) {
                    displayPledgeTiers();
                }
            }
        }

        // Map pledge image names to upgrade pledge image names
        function getUpgradePledgeImage(pledgeImage) {
            const imageMap = {
                'benevolent-divya.png': 'divya.png',
                'founders-of-neh.png': 'founders.png',
                'resplendant-garuda.png': 'garuda.png',
                'resplendent-garuda.png': 'garuda.png',
                'industrious-manushya.png': 'manushya.png',
                'humble-vaanar.png': 'vaanar.png'
            };

            // Try to find mapped name, fallback to original
            const imageName = pledgeImage || '';
            const mappedName = imageMap[imageName.toLowerCase()] || imageName;
            // URL-encode the space in folder name
            return `/images/upgrade%20pledges/${mappedName}`;
        }

        // Get pledge description text
        function getPledgeDescription(pledgeName) {
            const descriptions = {
                'the humble vaanar': 'Begin your journey into MAYA with the first part in a planned trilogy. Get the paperback Edition Zero of MAYA: Seed Take Root. -381 pages -Beautiful debossed gold and silver foil cover -A detailed appendix of the world + Maya : Seed Takes Root ebook (DRM free) + All Unlocked Paperback stretch goals',
                'humble vaanar': 'Begin your journey into MAYA with the first part in a planned trilogy. Get the paperback Edition Zero of MAYA: Seed Take Root. -381 pages -Beautiful debossed gold and silver foil cover -A detailed appendix of the world + Maya : Seed Takes Root ebook (DRM free) + All Unlocked Paperback stretch goals',
                'the industrious manushya': 'Experience the true authorial vision of MAYA. Get the definitive hardcover Edition Zero of MAYA: Seed Takes Root. -342 pages -A cover with a magical art reveal -A detailed appendix of the world -A magical character reveal effect on the cover + Maya : Seed Takes Root ebook (DRM free) + All Unlocked Hardcover stretch goals',
                'industrious manushya': 'Experience the true authorial vision of MAYA. Get the definitive hardcover Edition Zero of MAYA: Seed Takes Root. -342 pages -A cover with a magical art reveal -A detailed appendix of the world -A magical character reveal effect on the cover + Maya : Seed Takes Root ebook (DRM free) + All Unlocked Hardcover stretch goals',
                'the resplendent garuda': 'Sign up for the entire trilogy! Book 1 will ship after this campaign ends, and you will get live access to Books 2 and 3. Both these books have been fully plotted and outlined, but you will be the first people in the world to read them as they evolve (including incomplete drafts), and be part of the authors\' inner circle. This pledge includes: 1. MAYA: Seed Takes Root | Book 1 Edition Zero Hardcover 2. MAYA: Whispers In The Soil | Book 2 Live Access 3. MAYA: It Becomes The Forest | Book 3 Live Access 4. MAYA : Seed Takes Root ebook (DRM free) Bonus : Book 2 Edition Zero Hardcover, Book 3 Edition Zero Hardcover',
                'resplendent garuda': 'Sign up for the entire trilogy! Book 1 will ship after this campaign ends, and you will get live access to Books 2 and 3. Both these books have been fully plotted and outlined, but you will be the first people in the world to read them as they evolve (including incomplete drafts), and be part of the authors\' inner circle. This pledge includes: 1. MAYA: Seed Takes Root | Book 1 Edition Zero Hardcover 2. MAYA: Whispers In The Soil | Book 2 Live Access 3. MAYA: It Becomes The Forest | Book 3 Live Access 4. MAYA : Seed Takes Root ebook (DRM free) Bonus : Book 2 Edition Zero Hardcover, Book 3 Edition Zero Hardcover',
                'resplendant garuda': 'Sign up for the entire trilogy! Book 1 will ship after this campaign ends, and you will get live access to Books 2 and 3. Both these books have been fully plotted and outlined, but you will be the first people in the world to read them as they evolve (including incomplete drafts), and be part of the authors\' inner circle. This pledge includes: 1. MAYA: Seed Takes Root | Book 1 Edition Zero Hardcover 2. MAYA: Whispers In The Soil | Book 2 Live Access 3. MAYA: It Becomes The Forest | Book 3 Live Access 4. MAYA : Seed Takes Root ebook (DRM free) Bonus : Book 2 Edition Zero Hardcover, Book 3 Edition Zero Hardcover',
                'the benevolent divya': 'The complete, expansive MAYA experience. Get everything - in its most glorious form. Includes everything from the previous pledge + 1. MAYA: Seed Takes Root Audiobook (Narrated by Hugo Weaving) 2. MAYA Lore Hardcover 3. Built Environments of MAYA Hardcover 4. MAYA : Seed Takes Root ebook (DRM free) + ALL Unlocked Stretch Goals!',
                'benevolent divya': 'The complete, expansive MAYA experience. Get everything - in its most glorious form. Includes everything from the previous pledge + 1. MAYA: Seed Takes Root Audiobook (Narrated by Hugo Weaving) 2. MAYA Lore Hardcover 3. Built Environments of MAYA Hardcover 4. MAYA : Seed Takes Root ebook (DRM free) + ALL Unlocked Stretch Goals!',
                'founders of neh': 'Everything in the "Benevolent Divya" reward tier + Limited Edition Signed Artbook documenting the Process + A character in the MAYA universe named after you (adapted to fit the grammar of Neh eg. We already have a character named "Waaz Nayak" named after a certain real-world innovator.',
                'founder of neh': 'Everything in the "Benevolent Divya" reward tier + Limited Edition Signed Artbook documenting the Process + A character in the MAYA universe named after you (adapted to fit the grammar of Neh eg. We already have a character named "Waaz Nayak" named after a certain real-world innovator.'
            };
            
            const nameKey = (pledgeName || '').toLowerCase().trim();
            return descriptions[nameKey] || pledgeName || 'Premium pledge tier with exclusive rewards';
        }

        // Display pledge tiers (excluding hero)
        function displayPledgeTiers() {
            const pledgeNames = ['humble vaanar', 'industrious manushya', 'resplendent garuda', 'benevolent divya', 'founders of neh'];
            
            // Filter to show only pledge tiers, excluding the hero
            const pledgeTiers = products.filter(p => {
                const name = p.name.toLowerCase();
                // Include if it's a pledge tier
                if (pledgeNames.some(pledge => name.includes(pledge))) {
                    // Exclude the hero pledge (Benevolent Divya)
                    return !name.includes('benevolent divya');
                }
                return false;
            }).sort((a, b) => a.price - b.price); // Sort by price

            const grid = document.getElementById('pledge-tiers-grid');
            
            if (pledgeTiers.length === 0) {
                grid.innerHTML = `<div style="text-align: center; padding: 40px; grid-column: 1 / -1;"><p style="color: #ffffff;">No other pledge tiers available.</p></div>`;
                return;
            }

            grid.innerHTML = '';
            
            pledgeTiers.forEach((pledge, index) => {
                const imagePath = getUpgradePledgeImage(pledge.image);
                const accordion = document.createElement('div');
                accordion.style.cssText = 'background: #1e1e1e; border-radius: 16px; overflow: hidden;';
                
                // Price display with backer badge for pledges
                const isBackerPrice = pledge.is_backer_price && pledge.original_price;
                let pledgePriceHTML = '';
                if (isBackerPrice) {
                    pledgePriceHTML = `
                        <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                            <span style="font-family: 'Inter', sans-serif; font-size: 22px; font-weight: 700; color: #059669; margin: 0;">$${pledge.price.toFixed(2)}</span>
                            <span style="background: #059669; color: white; padding: 3px 6px; border-radius: 4px; font-family: 'Inter', sans-serif; font-weight: 600; font-size: 10px; text-transform: uppercase;">BACKER</span>
                            <span style="font-family: 'Inter', sans-serif; font-size: 16px; font-weight: 500; color: #999; text-decoration: line-through; margin-left: 4px;">$${pledge.original_price.toFixed(2)}</span>
                        </div>
                    `;
                } else {
                    pledgePriceHTML = `<div style="font-family: 'Inter', sans-serif; font-size: 22px; font-weight: 700; color: #dc2626; margin: 0;">$${pledge.price.toFixed(2)}</div>`;
                }
                
                accordion.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; cursor: pointer; border-bottom: 1px solid #2c2c2c;" onclick="togglePledge(${index})">
                        <div style="flex: 1;">
                            <h3 style="font-family: 'Inter', sans-serif; font-size: 20px; font-weight: 700; color: #ffffff; margin: 0 0 4px 0;">${pledge.name}</h3>
                            ${pledgePriceHTML}
                        </div>
                        <button style="background: none; border: none; cursor: pointer; padding: 0; font-size: 20px; color: #ffffff; transform-origin: center; transition: transform 0.3s;" id="pledge-arrow-${index}">
                            â–¼
                        </button>
                    </div>
                    <div id="pledge-content-${index}" class="pledge-dropdown-content" style="display: none; padding: 24px; background: #0f0f0f;">
                        <div style="display: flex; gap: 24px; align-items: flex-start; flex-wrap: wrap;">
                            <div style="flex: 0 0 auto; background: #d9d9d9; border-radius: 12px; padding: 8px; height: 280px; width: 280px; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                                <img src="${imagePath}" alt="${pledge.name}" style="width: 120%; height: 120%; object-fit: contain; object-position: center;" loading="lazy" onerror="this.parentElement.innerHTML='<div style=\\'font-size: 64px;\\'>ðŸ“¦</div>'">
                            </div>
                            <div style="flex: 1; min-width: 250px;">
                                <p style="font-family: 'Inter', sans-serif; font-size: 15px; color: #a0a0a0; margin: 0 0 20px 0; line-height: 1.6;">${getPledgeDescription(pledge.name)}</p>
                                <button onclick="addPledgeToCart('${pledge.id}')" id="add-pledge-btn-${pledge.id}" style="background: #dc2626; color: white; border: none; padding: 14px 24px; border-radius: 10px; font-family: 'Inter', sans-serif; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; width: auto; min-width: 200px;">
                                    Add to Cart
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                grid.appendChild(accordion);
            });
        }

        // Add pledge to cart
        function addPledgeToCart(pledgeId) {
            const pledge = products.find(p => p.id === pledgeId);
            if (!pledge) return;

            // Check if there's already a pledge in cart (different from the one being added)
            const pledgeNames = ['humble vaanar', 'industrious manushya', 'resplendent garuda', 'benevolent divya', 'founders of neh'];
            const existingPledge = cart.find(item => {
                // Don't check the same pledge being added
                if (item.id === pledgeId) return false;
                
                // Check cart item flags first
                if (item.isPledgeUpgrade || item.isOriginalPledge || item.isDroppedBackerPledge) {
                    return true;
                }
                
                // Check cart item name directly (most reliable)
                if (item.name) {
                    const nameLower = item.name.toLowerCase();
                    if (pledgeNames.some(pledge => nameLower.includes(pledge))) {
                        return true;
                    }
                }
                
                // Check by product lookup (if products array is loaded)
                const itemProduct = products.find(p => p.id === item.id);
                if (itemProduct) {
                    if (itemProduct.type === 'pledge' || 
                        pledgeNames.some(pledge => itemProduct.name.toLowerCase().includes(pledge))) {
                        return true;
                    }
                }
                
                return false;
            });
            
            if (existingPledge) {
                alert('You can only have one pledge in your cart. Please remove the existing pledge before adding a new one.');
                return;
            }

            // Check if pledge is already in cart
            const cartItem = cart.find(item => item.id === pledgeId);
            if (cartItem) {
                // Can't increase quantity - already at max of 1
                alert('You can only have one pledge in your cart.');
                return;
            } else {
                // Add new pledge to cart
                cart.push({
                    id: pledge.id,
                    name: pledge.name,
                    price: pledge.price,
                    weight: pledge.weight || 0,
                    quantity: 1
                });
            }

            // Update button to show it's been added
            const btn = document.getElementById(`add-pledge-btn-${pledgeId}`);
            if (btn) {
                btn.style.background = '#059669';
                btn.textContent = 'âœ“ Added';
                
                // Add animation
                btn.classList.add('button-added');
                setTimeout(() => {
                    btn.classList.remove('button-added');
                }, 600);
            }

            // Update cart display and save to sessionStorage
            updateCart();
        }

        // Hero section add to cart
        function addHeroBookToCart() {
            console.log('addHeroBookToCart called');
            console.log('  - heroBook:', heroBook);
            console.log('  - products:', products?.length || 0);
            
            if (!heroBook) {
                console.error('âœ— Hero book not available');
                console.error('  - Attempting to reload products...');
                loadProducts().then(() => {
                    if (heroBook) {
                        console.log('  âœ“ Products reloaded, hero book now available');
                        addHeroBookToCart(); // Retry
                    } else {
                        alert('Book not available. Please refresh the page.\n\nIf this persists, the product may not be in the database.');
                    }
                });
                return;
            }

            // Check if book already in cart - don't add again
            const cartItem = cart.find(item => item.id === heroBook.id);
            if (cartItem) {
                // Already in cart, do nothing
                return;
            }

            // Add to cart
            cart.push({
                id: heroBook.id,
                name: heroBook.name,
                price: heroBook.price,
                weight: heroBook.weight,
                quantity: 1
            });

            // Trigger animation on the hero button
            const btn = document.getElementById('hero-add-btn');
            if (btn) {
                btn.classList.add('button-added');
                setTimeout(() => {
                    btn.classList.remove('button-added');
                }, 600);
            }

            updateCart();
        }

        // Update hero button state based on cart
        function updateHeroButton() {
            if (!heroBook) return;

            const btn = document.getElementById('hero-add-btn');
            const cartItem = cart.find(item => item.id === heroBook.id);

            if (cartItem) {
                // Book is in cart - show added state
                btn.textContent = 'âœ“ Added';
                btn.style.background = '#059669';
                btn.style.borderColor = '#059669';
                btn.style.cursor = 'default';
                btn.disabled = true;
            } else {
                // Book not in cart - show add button
                btn.textContent = 'Add to Cart';
                btn.style.background = '#dc2626';
                btn.style.borderColor = '#2c2c2c';
                btn.style.cursor = 'pointer';
                btn.disabled = false;
                btn.onclick = addHeroBookToCart;
            }
        }

        function displayProducts() {
            const grid = document.getElementById('products-grid');
            
            // Re-read cart from sessionStorage to ensure it's fresh (in case user removed items)
            cart = JSON.parse(sessionStorage.getItem('cart')) || [];
            
            // Filter out the main book (hero product) - only show add-ons
            // Filter to show only add-ons (not pledge tiers or hero)
            const pledgeNames = ['humble vaanar', 'industrious manushya', 'resplendent garuda', 'benevolent divya', 'founders of neh'];
            let addOnsOnly = products.filter(p => 
                !pledgeNames.some(pledge => p.name.toLowerCase().includes(pledge))
            );
            
            // Remove duplicates by name (keep first occurrence)
            const seen = new Set();
            addOnsOnly = addOnsOnly.filter(p => {
                const key = p.name.toLowerCase().trim();
                if (seen.has(key)) {
                    return false;
                }
                seen.add(key);
                return true;
            });
            
            if (addOnsOnly.length === 0) {
                grid.innerHTML = `
                    <div style="text-align: center; padding: 40px; grid-column: 1 / -1;">
                        <p style="color: #ffffff;">No add-ons available at this time.</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = '';
            
            addOnsOnly.forEach(product => {
                const card = document.createElement('div');
                card.id = `product-card-${product.id}`;
                card.style.cssText = 'display: flex; flex-direction: column; background: #1e1e1e; border-radius: 16px; min-height: 550px; position: relative; transition: all 0.3s ease;';
                
                const isInCart = cart.find(item => item.id === product.id);
                const cartItem = isInCart;
                const quantity = cartItem ? cartItem.quantity : 0;
                
                // Check if product is free
                const isFree = product.price === 0;
                const isBackerPrice = product.is_backer_price && product.original_price;
                const priceDisplay = isFree ? 'FREE' : `$${product.price.toFixed(0)}`;
                const priceColor = isFree ? '#4b944e' : '#ffffff';
                
                // Price display with backer badge
                let priceHTML = '';
                if (isBackerPrice) {
                    priceHTML = `
                        <div style="display: flex; flex-direction: column; gap: 4px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-family: 'Inter', sans-serif; font-weight: 700; font-size: 32px; line-height: 1; color: #059669; margin: 0;">${priceDisplay}</span>
                                <span style="background: #059669; color: white; padding: 4px 8px; border-radius: 4px; font-family: 'Inter', sans-serif; font-weight: 600; font-size: 11px; text-transform: uppercase;">BACKER</span>
                            </div>
                            <span style="font-family: 'Inter', sans-serif; font-weight: 500; font-size: 14px; color: #999; text-decoration: line-through;">$${product.original_price.toFixed(0)}</span>
                        </div>
                    `;
                } else {
                    priceHTML = `<p style="font-family: 'Inter', sans-serif; font-weight: 700; font-size: 32px; line-height: 1; color: ${priceColor}; margin: 0;">${priceDisplay}</p>`;
                }
                
                card.innerHTML = `
                    <!-- Product Image -->
                    <div style="background: #0a0a0a; border-radius: 12px; margin: 24px; height: 280px; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                        ${product.image ? `<img src="/images/addons/${product.image}" alt="${product.name}" loading="lazy" style="max-width: 100%; max-height: 100%; object-fit: contain;">` : '<div style="display: flex; align-items: center; justify-content: center; font-size: 64px;">ðŸ“¦</div>'}
                    </div>
                    
                    <!-- Product Description -->
                    <div style="padding: 0 24px; flex: 1;">
                        <p style="font-family: 'Inter', sans-serif; font-weight: 500; font-size: 18px; line-height: 1.4; color: #ffffff; margin: 0 0 20px 0;">${product.name}</p>
                    </div>
                    
                    <!-- Price and Quantity Controls -->
                    <div style="padding: 0 24px; margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            ${priceHTML}
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <button onclick="decreaseCartQuantity('${product.id}')" style="background: #828282; color: white; border: none; border-radius: 6px; padding: 0; font-family: 'Inter', sans-serif; font-weight: 600; font-size: 20px; cursor: pointer; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">âˆ’</button>
                                <div style="background: #828282; color: white; border-radius: 6px; font-family: 'Inter', sans-serif; font-weight: 600; font-size: 18px; min-width: 50px; height: 36px; display: flex; align-items: center; justify-content: center;" id="qty-${product.id}">${quantity}</div>
                                <button onclick="increaseCartQuantity('${product.id}')" style="background: #828282; color: white; border: none; border-radius: 6px; padding: 0; font-family: 'Inter', sans-serif; font-weight: 600; font-size: 20px; cursor: pointer; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">+</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Add to Cart Button -->
                    <button id="add-btn-${product.id}" onclick="${isInCart ? '' : "addProductToCart('" + product.id + "')"}" style="background: ${isInCart ? '#059669' : '#dc2626'}; border: 1px solid ${isInCart ? '#059679' : '#dc2626'}; color: white; border-radius: 10px; padding: 14px; margin: 0 24px 24px 24px; font-family: 'Inter', sans-serif; font-weight: 600; font-size: 16px; cursor: ${isInCart ? 'default' : 'pointer'}; white-space: nowrap; transition: all 0.3s ease;" ${isInCart ? 'disabled' : ''}>
                        ${isInCart ? 'âœ“ Added' : 'Add to Cart'}
                    </button>
                `;
                grid.appendChild(card);
            });

        }

        function addProductToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            // Check if this is a pledge
            const pledgeNames = ['humble vaanar', 'industrious manushya', 'resplendent garuda', 'benevolent divya', 'founders of neh'];
            const isPledge = product.type === 'pledge' || 
                             pledgeNames.some(pledge => product.name.toLowerCase().includes(pledge));

            // If trying to add a pledge, check if one already exists
            if (isPledge) {
                const existingPledge = cart.find(item => {
                    // Check cart item flags first
                    if (item.isPledgeUpgrade || item.isOriginalPledge || item.isDroppedBackerPledge) {
                        return true;
                    }
                    
                    // Check cart item name directly (most reliable)
                    if (item.name) {
                        const nameLower = item.name.toLowerCase();
                        if (pledgeNames.some(pledge => nameLower.includes(pledge))) {
                            return true;
                        }
                    }
                    
                    // Check by product lookup (if products array is loaded)
                    const itemProduct = products.find(p => p.id === item.id);
                    if (itemProduct) {
                        if (itemProduct.type === 'pledge' || 
                            pledgeNames.some(pledge => itemProduct.name.toLowerCase().includes(pledge))) {
                            return true;
                        }
                    }
                    
                    return false;
                });
                
                if (existingPledge) {
                    alert('You can only have one pledge in your cart. Please remove the existing pledge before adding a new one.');
                    return;
                }
            }

            // Check if this is an add-on (not a pledge tier)
            // ALL users must have a pledge in cart before adding add-ons
            if (isAddon(product)) {
                if (!hasPledgeInCart()) {
                    alert('Please select a pledge tier first before adding add-ons to your order.');
                    return;
                }
            }

            // Check if already in cart
            const cartItem = cart.find(item => item.id === productId);
            if (!cartItem) {
                // Add to cart with quantity 1
                cart.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    weight: product.weight,
                    quantity: 1
                });
            }

            // Trigger animation on the button
            const btn = document.getElementById(`add-btn-${productId}`);
            if (btn) {
                btn.classList.add('button-added');
                setTimeout(() => {
                    btn.classList.remove('button-added');
                }, 600);
            }

            updateCart();
        }

        // Cart modal specific quantity functions
        function increaseCartQuantity(productId) {
            let cartItem = cart.find(item => item.id === productId);
            const product = products.find(p => p.id === productId);
            
            if (cartItem) {
                // Check if this is a pledge - limit quantity to 1
                const pledgeNames = ['humble vaanar', 'industrious manushya', 'resplendent garuda', 'benevolent divya', 'founders of neh'];
                
                // Check cart item flags first
                let isPledge = cartItem.isPledgeUpgrade || cartItem.isOriginalPledge || cartItem.isDroppedBackerPledge;
                
                // Check by product lookup
                if (!isPledge && product) {
                    isPledge = product.type === 'pledge' || 
                               pledgeNames.some(pledge => product.name.toLowerCase().includes(pledge));
                }
                
                // Fallback: check cart item name directly
                if (!isPledge && cartItem.name) {
                    const nameLower = cartItem.name.toLowerCase();
                    isPledge = pledgeNames.some(pledge => nameLower.includes(pledge));
                }
                
                if (isPledge && cartItem.quantity >= 1) {
                    alert('You can only have one pledge in your cart.');
                    return;
                }
                
                cartItem.quantity++;
            } else {
                // Add to cart if not already there
                if (product) {
                    // Check if this is a pledge
                    const pledgeNames = ['humble vaanar', 'industrious manushya', 'resplendent garuda', 'benevolent divya', 'founders of neh'];
                    const isPledge = product.type === 'pledge' || 
                                     pledgeNames.some(pledge => product.name.toLowerCase().includes(pledge));
                    
                    // If trying to add a pledge, check if one already exists
                    if (isPledge) {
                        const existingPledge = cart.find(item => {
                            // Check cart item flags first
                            if (item.isPledgeUpgrade || item.isOriginalPledge || item.isDroppedBackerPledge) {
                                return true;
                            }
                            
                            // Check cart item name directly (most reliable)
                            if (item.name) {
                                const nameLower = item.name.toLowerCase();
                                if (pledgeNames.some(pledge => nameLower.includes(pledge))) {
                                    return true;
                                }
                            }
                            
                            // Check by product lookup (if products array is loaded)
                            const itemProduct = products.find(p => p.id === item.id);
                            if (itemProduct) {
                                if (itemProduct.type === 'pledge' || 
                                    pledgeNames.some(pledge => itemProduct.name.toLowerCase().includes(pledge))) {
                                    return true;
                                }
                            }
                            
                            return false;
                        });
                        
                        if (existingPledge) {
                            alert('You can only have one pledge in your cart. Please remove the existing pledge before adding a new one.');
                            return;
                        }
                    }
                    
                    // ALL users must have a pledge in cart before adding add-ons
                    if (isAddon(product)) {
                        if (!hasPledgeInCart()) {
                            alert('Please select a pledge tier first before adding add-ons to your order.');
                            return;
                        }
                    }
                    cart.push({
                        id: product.id,
                        name: product.name,
                        price: product.price,
                        weight: product.weight,
                        quantity: 1
                    });
                }
            }
            updateCart();
        }

        // Helper to check if an item is a pledge
        function isPledgeItem(productId, cartItem) {
            const product = products.find(p => p.id === productId);
            const pledgeNames = ['humble vaanar', 'industrious manushya', 'resplendent garuda', 'benevolent divya', 'founders of neh'];
            
            // Check product type/name
            const isPledgeByProduct = product && (
                product.type === 'pledge' || 
                pledgeNames.some(pledge => product.name.toLowerCase().includes(pledge))
            );
            
            // Check cart item flags
            const isPledgeByFlags = cartItem && (
                cartItem.isPledgeUpgrade || 
                cartItem.isOriginalPledge || 
                cartItem.isDroppedBackerPledge
            );
            
            // Check cart item name directly (in case product not found)
            const isPledgeByCartName = cartItem && cartItem.name && 
                pledgeNames.some(pledge => cartItem.name.toLowerCase().includes(pledge));
            
            return isPledgeByProduct || isPledgeByFlags || isPledgeByCartName;
        }
        
        // Helper to remove pledge and all addons
        function removePledgeAndAddons(pledgeProductId) {
            const pledgeNames = ['humble vaanar', 'industrious manushya', 'resplendent garuda', 'benevolent divya', 'founders of neh'];
            
            // Check if there are any addons in cart before removing
            const hasAddons = cart.some(item => {
                if (item.id === pledgeProductId) return false; // Don't count the pledge being removed
                return !isPledgeItem(item.id, item); // Addons are non-pledge items
            });
            
            cart = cart.filter(item => {
                // Remove the pledge being deleted
                if (item.id === pledgeProductId) return false;
                // Keep other pledges
                if (isPledgeItem(item.id, item)) return true;
                // Remove all addons
                return false;
            });
            
            // Only show alert if there were actually addons removed
            if (hasAddons) {
                alert('Pledge removed. Add-ons have also been removed as they require a pledge.');
            }
        }

        function decreaseCartQuantity(productId) {
            const cartItem = cart.find(item => item.id === productId);
            if (!cartItem) return;

            if (cartItem.quantity > 1) {
                cartItem.quantity--;
            } else {
                // About to remove item - check if it's a pledge
                if (isPledgeItem(productId, cartItem)) {
                    removePledgeAndAddons(productId);
                } else {
                    cart = cart.filter(item => item.id !== productId);
                }
            }
            updateCart();
        }

        function removeFromCart(productId) {
            const cartItem = cart.find(item => item.id === productId);
            
            if (isPledgeItem(productId, cartItem)) {
                removePledgeAndAddons(productId);
            } else {
                cart = cart.filter(item => item.id !== productId);
            }
            updateCart();
        }

        function updateCart() {
            sessionStorage.setItem('cart', JSON.stringify(cart));

            const cartBadge = document.getElementById('cart-count-badge');
            const floatingCheckout = document.getElementById('floating-checkout');
            const floatingTotal = document.getElementById('floating-total');
            
            // Update cart count badge
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            if (totalItems > 0) {
                cartBadge.textContent = totalItems;
                cartBadge.style.display = 'inline';
            } else {
                cartBadge.style.display = 'none';
            }
            
            // Calculate total
            let total = 0;
            cart.forEach(item => {
                total += item.price * item.quantity;
            });
            
            if (cart.length === 0) {
                floatingCheckout.style.display = 'none';
            } else {
                floatingTotal.textContent = '$' + total.toFixed(2);
                floatingCheckout.style.display = 'block';
            }

            // Update product card buttons and quantity displays
            products.forEach(product => {
                const cartItem = cart.find(item => item.id === product.id);
                const qtyDisplay = document.getElementById(`qty-${product.id}`);
                if (qtyDisplay) {
                    qtyDisplay.textContent = cartItem ? cartItem.quantity : 0;
                }

                const btn = document.getElementById(`add-btn-${product.id}`);
                if (btn) {
                    if (cartItem) {
                        btn.textContent = 'âœ“ Added';
                        btn.style.background = '#059669';
                        btn.style.borderColor = '#059669';
                        btn.style.cursor = 'default';
                        btn.disabled = true;
                        btn.onclick = null;
                    } else {
                        btn.textContent = 'Add to Cart';
                        btn.style.background = '#dc2626';
                        btn.style.borderColor = '#2c2c2c';
                        btn.style.cursor = 'pointer';
                        btn.disabled = false;
                        btn.onclick = () => addProductToCart(product.id);
                    }
                }
            });

            // Update hero button state
            updateHeroButton();
        }

        function scrollToCart() {
            window.location.href = '/addons';
        }

        function proceedToCheckout() {
            window.location.href = '/addons';
        }

        function toggleProductDetails() {
            const content = document.getElementById('product-details-content');
            const arrow = document.getElementById('details-arrow');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.style.transform = 'rotate(180deg)';
            } else {
                content.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        function togglePledge(index) {
            const content = document.getElementById(`pledge-content-${index}`);
            const arrow = document.getElementById(`pledge-arrow-${index}`);
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.style.transform = 'rotate(180deg)';
            } else {
                content.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        // Initialize: check if user is backer and load products
        checkIfBacker();
        loadProducts();
        
        // Re-sync cart when page is shown (handles browser back/forward cache)
        window.addEventListener('pageshow', function(event) {
            // If page is loaded from cache, refresh the cart state
            if (event.persisted) {
                console.log('Page loaded from cache, refreshing cart state...');
                cart = JSON.parse(sessionStorage.getItem('cart')) || [];
                updateCart();
                // Re-render products to update "Added" buttons
                displayProducts();
            }
        });

        // Smart navbar scroll behavior
        let lastScrollTop = 0;
        let navbarHeight = 50;
        const navbar = document.getElementById('navbar');
        
        window.addEventListener('scroll', function() {
            let scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            
            if (scrollTop > lastScrollTop && scrollTop > navbarHeight) {
                // Scrolling down - hide navbar
                navbar.style.transform = 'translateY(-100%)';
            } else {
                // Scrolling up - show navbar
                navbar.style.transform = 'translateY(0)';
            }
            
            lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;
        }, false);
    </script>
</body>
</html>
