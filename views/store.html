<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAYA Store - Pre-Order Now</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.4); display:flex; align-items:center; justify-content:center; z-index:1000; }
        .modal { background:#1e1e1e; border-radius:8px; width:90%; max-width:700px; box-shadow:0 10px 30px rgba(0,0,0,0.2); }
        .modal-header { display:flex; align-items:center; justify-content:space-between; padding:16px 20px; border-bottom:2px solid var(--border-color); }
        .modal-body { padding:16px 20px; max-height:60vh; overflow:auto; }
        .modal-footer { padding:12px 20px; border-top:2px solid var(--border-color); }
        .modal-close { background:none; border:none; font-size:22px; cursor:pointer; color: #ffffff; }
        .modal-close:hover { color: var(--primary-red); }

        /* Cart button hover effects */
        .quantity-selector button:hover {
            background: #1a1a1a !important;
        }
        
        .quantity-selector button:active {
            background: #e5e5e5 !important;
        }
        
        button[onclick^="removeFromCart"]:hover {
            background: #dc2626 !important;
        }

        /* Button transition effects */
        .btn {
            transition: all 0.3s ease;
        }

        /* Product card hover effects */
        #products-grid > div {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        #products-grid > div:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        /* Button hover effects */
        button:not(.modal-close):not([onclick*="toggle"]):hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        button:not(.modal-close):not([onclick*="toggle"]):active {
            transform: translateY(0);
        }

        /* Add to cart success animation */
        @keyframes buttonSuccess {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes pulseGreen {
            0% { box-shadow: 0 0 0 0 rgba(5, 150, 105, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(5, 150, 105, 0); }
            100% { box-shadow: 0 0 0 0 rgba(5, 150, 105, 0); }
        }

        .button-added {
            animation: buttonSuccess 0.4s ease, pulseGreen 0.6s ease;
        }

        /* Green checkout button hover */
        .btn-checkout-green,
        .btn-checkout-green.btn-primary,
        button.btn-checkout-green {
            background: #059669 !important;
            border-color: #059669 !important;
            background-color: #059669 !important;
        }

        .btn-checkout-green:hover,
        .btn-checkout-green.btn-primary:hover,
        button.btn-checkout-green:hover {
            background: #047857 !important;
            border-color: #047857 !important;
            background-color: #047857 !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
        }
        
        @media (max-width: 1400px) {
            .container {
                padding: 40px 40px !important;
            }
        }

        @media (max-width: 1100px) {
            .container {
                padding: 30px 30px !important;
            }

            /* Hero Section */
            .container > div:first-of-type {
                flex-direction: column !important;
                gap: 40px !important;
            }

            .container > div:first-of-type > div:first-child {
                flex: 1 !important;
                width: 100% !important;
                min-height: 500px !important;
            }

            /* Stats Section */
            .container > div:nth-of-type(2) {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 20px !important;
            }

            .container > div:nth-of-type(2) > div:first-child {
                grid-column: 1 / -1 !important;
            }

            .addons-grid {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)) !important;
            }
        }

        @media (max-width: 768px) {
            /* Mobile Navbar - Smaller and Optimized */
            #navbar {
                padding: 8px 20px !important;
            }

            #navbar > div:first-child {
                height: 24px !important;
            }

            #navbar img {
                height: 24px !important;
            }

            #navbar .nav-right {
                gap: 15px !important;
            }

            #navbar a, #navbar button {
                font-size: 20px !important;
                padding: 3px !important;
            }

            .container {
                padding: 20px !important;
            }

            /* Hero Section Mobile - Smaller Image */
            .container > div:first-of-type {
                margin-bottom: 40px !important;
            }

            .container > div:first-of-type > div:first-child {
                min-height: 300px !important;
                max-height: 350px !important;
                padding: 20px !important;
            }

            .container > div:first-of-type > div:last-child h1 {
                font-size: 28px !important;
            }

            .container > div:first-of-type > div:last-child p {
                font-size: 14px !important;
            }

            .container > div:first-of-type > div:last-child > div:first-child {
                font-size: 36px !important;
            }

            .container > div:first-of-type > div:last-child button {
                width: 100% !important;
                font-size: 18px !important;
            }

            /* Stats Section Mobile */
            .container > div:nth-of-type(2) {
                grid-template-columns: 1fr !important;
                gap: 15px !important;
                margin-bottom: 40px !important;
            }

            .container > div:nth-of-type(2) > div {
                padding: 20px !important;
            }

            .container > div:nth-of-type(2) > div:first-child p {
                font-size: 18px !important;
            }

            /* Add-ons Grid Mobile */
            .addons-grid {
                grid-template-columns: 1fr !important;
                gap: 24px !important;
            }
        }
    </style>
</head>
<body style="background: #0a0a0a !important; color: #ffffff !important;">
    <!-- Header with Logo -->
    <div id="navbar" style="background: #1a1a1a; padding: 10px 60px; display: flex; align-items: center; justify-content: space-between; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; transition: transform 0.3s ease;">
        <div style="height: 30px; width: auto;">
            <img src="/images/maya-logo.png" alt="MAYA" style="height: 100%; width: auto; object-fit: contain;">
        </div>
        <div style="display: flex; align-items: center; gap: 20px;">
            <a href="/login" style="background: none; border: none; cursor: pointer; font-size: 19px; position: relative; padding: 5px; text-decoration: none; color: inherit;" title="Login">
                üë§
            </a>
            <button onclick="scrollToCart()" style="background: none; border: none; cursor: pointer; font-size: 19px; position: relative; padding: 5px;">
                üõí <span id="cart-count-badge" style="background: var(--primary-red); color: white; border-radius: 50%; padding: 2px 6px; font-size: 11px; font-weight: bold; position: absolute; top: 0; right: 0; display: none;">0</span>
            </button>
            <button style="background: none; border: none; cursor: pointer; font-size: 19px; padding: 5px;">
                ‚ò∞
            </button>
        </div>
    </div>
    
    <!-- Spacer for fixed navbar -->
    <div style="height: 50px;"></div>

    <div class="container" style="max-width: 1400px; margin: 0 auto; padding: 60px 80px;">
        <!-- Hero Section -->
        <div style="display: flex; gap: 80px; margin-bottom: 80px; align-items: center; max-width: 1200px; margin-left: auto; margin-right: auto; margin-bottom: 80px;">
            <!-- Left: Pledge Image -->
            <div style="flex: 0 0 550px; background: #1e1e1e; border-radius: 16px; overflow: hidden; display: flex; align-items: center; justify-content: center; min-height: 600px;">
                <img src="/images/pledges/benevolent-divya.png" alt="The Benevolent Divya" style="width: 100%; height: 100%; object-fit: cover;">
            </div>

            <!-- Right: Pledge Details -->
            <div style="flex: 1; display: flex; flex-direction: column; justify-content: center;">
                <h1 style="font-family: 'Inter', sans-serif; font-weight: 800; font-size: 42px; line-height: 1.2; margin: 0 0 24px 0; color: #ffffff;">
                    The Benevolent Divya
                </h1>
                <p style="font-family: 'Inter', sans-serif; font-weight: 400; font-size: 18px; line-height: 1.6; margin: 0 0 30px 0; color: #ffffff;">
                    Deluxe pledge tier with rare collectibles. An epic sci-fiction fantasy with intricate worldbuilding. Six species, one planet, zero privacy. Enter the age of narrative warfare.
                </p>

                <!-- Price and Button -->
                <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 30px;">
                    <!-- Price -->
                    <div style="font-family: 'Inter', sans-serif; font-weight: 700; color: #ffffff; font-size: 36px; line-height: 1;">
                        $<span id="hero-book-price">190</span>
                    </div>

                    <!-- Add to Cart Button -->
                    <button id="hero-add-btn" onclick="addHeroBookToCart()" style="background: #dc2626; border: 1px solid #dc2626; color: #ffffff; padding: 12px 28px; border-radius: 10px; font-family: 'Inter', sans-serif; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                        Add to Cart
                    </button>
                </div>

                <!-- What You Get List -->
                <div style="background: #1e1e1e; border-radius: 8px; padding: 20px;">
                    <p style="font-family: 'Inter', sans-serif; font-weight: 700; font-size: 14px; color: #dc2626; margin: 0 0 12px 0; text-transform: uppercase; letter-spacing: 0.5px;">What You Get:</p>
                    <ul style="list-style: none; padding: 0; margin: 0; font-size: 13px; line-height: 1.8; color: #ffffff;">
                        <li>‚Ä¢ MAYA: Seed Takes Root (eBook + Hardcover)</li>
                        <li>‚Ä¢ MAYA: Whispers in the Soil (Live Access + Hardcover)</li>
                        <li>‚Ä¢ MAYA: It Becomes the Forest (Live Access + Hardcover)</li>
                        <li>‚Ä¢ Built Environments of MAYA Hardcover</li>
                        <li>‚Ä¢ MAYA Lorebook</li>
                        <li>‚Ä¢ Flitt Locust Pendant</li>
                        <li>‚Ä¢ Audiobook narrated by Hugo Weaving</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Kickstarter Stats Section -->
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 30px; margin-bottom: 80px; max-width: 1200px; margin-left: auto; margin-right: auto;">
            <!-- Message -->
            <div style="display: flex; align-items: center; background: #1e1e1e; padding: 30px; border-radius: 16px;">
                <p style="font-family: 'Roboto', sans-serif; font-weight: 700; font-size: 22px; line-height: 1.4; margin: 0; color: #ffffff;">
                    This project was successfully funded on Kickstarter.
                </p>
            </div>

            <!-- Raised Amount -->
            <div style="background: #0f0f0f; padding: 30px; border-radius: 16px;">
                <p style="font-family: 'Inter', sans-serif; font-weight: 600; font-size: 14px; line-height: 1.4; margin: 0 0 12px 0; color: #ffffff; text-transform: uppercase; letter-spacing: 0.5px;">Raised on Kickstarter</p>
                <p style="font-family: 'Inter', sans-serif; font-weight: 700; font-size: 28px; line-height: 1.2; margin: 0 0 8px 0; color: #ffffff;">US$ 423,621</p>
                <p style="font-family: 'Inter', sans-serif; font-weight: 400; font-size: 14px; line-height: 1.4; margin: 0; color: #ffffff;">pledged of US$ 10,000 goal</p>
            </div>

            <!-- Backers -->
            <div style="background: #0f0f0f; padding: 30px; border-radius: 16px;">
                <p style="font-family: 'Inter', sans-serif; font-weight: 600; font-size: 14px; line-height: 1.4; margin: 0 0 12px 0; color: #ffffff; text-transform: uppercase; letter-spacing: 0.5px;">Backers</p>
                <p style="font-family: 'Inter', sans-serif; font-weight: 700; font-size: 28px; line-height: 1.2; margin: 0 0 8px 0; color: #ffffff;">4,157</p>
                <p style="font-family: 'Inter', sans-serif; font-weight: 400; font-size: 14px; line-height: 1.4; margin: 0; color: #ffffff;">Backers love this project</p>
            </div>

            <!-- Funded Date -->
            <div style="background: #0f0f0f; padding: 30px; border-radius: 16px;">
                <p style="font-family: 'Inter', sans-serif; font-weight: 600; font-size: 14px; line-height: 1.4; margin: 0 0 12px 0; color: #ffffff; text-transform: uppercase; letter-spacing: 0.5px;">Funded On</p>
                <p style="font-family: 'Inter', sans-serif; font-weight: 700; font-size: 28px; line-height: 1.2; margin: 0; color: #ffffff;">XX.XX.2025</p>
            </div>
        </div>

        <!-- Product Details (Collapsible) -->
        <div style="background: #0f0f0f; border-radius: 16px; padding: 30px; margin-bottom: 60px; max-width: 1200px; margin-left: auto; margin-right: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <button onclick="toggleProductDetails()" style="background: none; border: none; cursor: pointer; padding: 0; font-family: 'Inter', sans-serif; font-weight: 700; font-size: 22px; line-height: 1.4; color: #ffffff;">
                    Product Details
                </button>
                <button onclick="toggleProductDetails()" style="background: none; border: none; cursor: pointer; padding: 0; font-size: 24px; transform-origin: center; transition: transform 0.3s;" id="details-arrow">
                    ‚ñº
                </button>
            </div>
            <div id="product-details-content" style="display: none; padding: 24px 0 0 0;">
                <ul style="font-family: 'Inter', sans-serif; font-weight: 400; font-size: 16px; line-height: 1.8; margin: 0; padding-left: 20px; color: #ffffff; list-style-type: disc;">
                    <li>342 pages</li>
                    <li>Magical anaglyph art reveal on cover</li>
                    <li>Free flitt locust bookmark</li>
                    <li>A detailed appendix of the world</li>
                    <li>2 full-spread colored illustrations</li>
                    <li>Munken 80GSM paper</li>
                    <li>Premium size of 9 √ó 6 inches</li>
                </ul>
            </div>
        </div>

        <!-- Other Pledge Tiers Section -->
        <div style="margin-bottom: 80px;">
            <div style="background: #1a1a1a; border-radius: 16px; padding: 30px; margin-bottom: 50px; max-width: 1200px; margin-left: auto; margin-right: auto; text-align: center;">
                <h2 style="font-family: 'Inter', sans-serif; font-weight: 700; font-size: 28px; line-height: 1.4; margin: 0 0 8px 0; color: #ffffff;">
                    Other Pledge Tiers
                </h2>
                <p style="font-family: 'Inter', sans-serif; font-weight: 400; font-size: 16px; line-height: 1.5; margin: 0; color: #ffffff;">
                    Choose from our complete collection of pledge tiers
                </p>
            </div>

            <!-- Pledge Tiers Grid -->
            <div id="pledge-tiers-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 40px; margin-bottom: 60px; max-width: 1200px; margin-left: auto; margin-right: auto;">
                <!-- Pledge tiers will be loaded here -->
            </div>
        </div>

        <!-- Add-ons Section Header -->
        <div style="background: #1a1a1a; border-radius: 16px; padding: 30px; margin-bottom: 50px; max-width: 1200px; margin-left: auto; margin-right: auto; text-align: center;">
            <h2 style="font-family: 'Inter', sans-serif; font-weight: 700; font-size: 28px; line-height: 1.4; margin: 0 0 8px 0; color: #ffffff;">
                Enhance Your Pledge
            </h2>
            <p style="font-family: 'Inter', sans-serif; font-weight: 400; font-size: 16px; line-height: 1.5; margin: 0; color: #ffffff;">
                Add exclusive items to your order
            </p>
        </div>

        <!-- Products Grid -->
        <div class="addons-grid" id="products-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 40px; margin-bottom: 60px; max-width: 1200px; margin-left: auto; margin-right: auto;">
            <!-- Products will be loaded here -->
            <div style="text-align: center; padding: 40px; grid-column: 1 / -1;">
                <div class="spinner"></div>
                <p style="color: var(--text-muted); margin-top: 20px;">Loading products...</p>
            </div>
        </div>

        <!-- Floating Checkout Button (shown when cart has items) -->
        <div id="floating-checkout" style="position: fixed; bottom: 30px; right: 30px; display: none; z-index: 999;">
            <button class="btn btn-large" onclick="window.location.href='/addons'" style="background: #059669; border-color: #059669; color: white; box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);" onmouseover="this.style.background='#047857'; this.style.borderColor='#047857'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(5, 150, 105, 0.4)';" onmouseout="this.style.background='#059669'; this.style.borderColor='#059669'; this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(5, 150, 105, 0.3)';">
                Proceed to Checkout ‚Üí <span id="floating-total"></span>
            </button>
        </div>

        <!-- Checkout Modal (Multi-step: Cart ‚Üí Shipping ‚Üí Payment) -->
        <div id="cart-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;" onclick="closeCartModal(event)">
            <div class="modal" style="max-width: 600px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;" onclick="event.stopPropagation()">
                <!-- Step Indicator -->
                <div style="background: #1e1e1e; padding: 20px; border-bottom: 2px solid #3a3a3a;">
                    <div style="display: flex; justify-content: space-between; align-items: center; max-width: 400px; margin: 0 auto;">
                        <div class="checkout-step" id="step-cart" style="flex: 1; text-align: center;">
                            <div style="width: 36px; height: 36px; border-radius: 50%; background: var(--primary-red); color: white; display: flex; align-items: center; justify-content: center; margin: 0 auto 8px; font-weight: 600;">1</div>
                            <div style="font-size: 12px; font-weight: 500;">Cart</div>
                        </div>
                        <div style="flex: 0.3; height: 2px; background: var(--border-color); margin: 0 10px 20px;"></div>
                        <div class="checkout-step" id="step-shipping" style="flex: 1; text-align: center;">
                            <div style="width: 36px; height: 36px; border-radius: 50%; background: var(--border-color); color: var(--text-muted); display: flex; align-items: center; justify-content: center; margin: 0 auto 8px; font-weight: 600;">2</div>
                            <div style="font-size: 12px; font-weight: 500; color: var(--text-muted);">Shipping</div>
                        </div>
                        <div style="flex: 0.3; height: 2px; background: var(--border-color); margin: 0 10px 20px;"></div>
                        <div class="checkout-step" id="step-payment" style="flex: 1; text-align: center;">
                            <div style="width: 36px; height: 36px; border-radius: 50%; background: var(--border-color); color: var(--text-muted); display: flex; align-items: center; justify-content: center; margin: 0 auto 8px; font-weight: 600;">3</div>
                            <div style="font-size: 12px; font-weight: 500; color: var(--text-muted);">Payment</div>
                        </div>
                    </div>
                </div>

                <!-- Modal Header -->
                <div class="modal-header">
                    <h3 id="modal-title">Your Cart</h3>
                    <button class="modal-close" onclick="closeCartModal()">√ó</button>
                </div>

                <!-- Modal Body -->
                <div class="modal-body" style="overflow-y: auto; flex: 1;">
                    <!-- Step 1: Cart View -->
                    <div id="cart-view">
                        <div id="cart-items">
                            <p style="color: var(--text-muted); text-align: center; padding: 20px;">
                                Your cart is empty.
                            </p>
                        </div>
                    </div>

                    <!-- Step 2: Shipping Form -->
                    <div id="shipping-view" style="display: none;">
                        <form id="shipping-form-modal">
                            <div class="form-group">
                                <label class="form-label">Full Name *</label>
                                <input type="text" class="form-input" id="modal-name" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email *</label>
                                <input type="email" class="form-input" id="modal-email" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Address Line 1 *</label>
                                <input type="text" class="form-input" id="modal-address1" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Address Line 2</label>
                                <input type="text" class="form-input" id="modal-address2">
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="form-group">
                                    <label class="form-label">City *</label>
                                    <input type="text" class="form-input" id="modal-city" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">State/Province *</label>
                                    <input type="text" class="form-input" id="modal-state" required>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="form-group">
                                    <label class="form-label">Postal Code *</label>
                                    <input type="text" class="form-input" id="modal-postal" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Country *</label>
                                    <select class="form-select" id="modal-country" required onchange="calculateModalShipping()">
                                        <option value="">Select Country</option>
                                        <option value="US">United States</option>
                                        <option value="CA">Canada</option>
                                        <option value="GB">United Kingdom</option>
                                        <option value="AU">Australia</option>
                                        <option value="IN">India</option>
                                        <option value="OTHER">Other</option>
                                    </select>
                                </div>
                            </div>
                            <div id="shipping-cost-display" style="display: none; margin-top: 20px; padding: 15px; background: var(--neutral-gray-light); border-radius: 6px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span>Subtotal:</span>
                                    <span><strong>$<span id="modal-subtotal">0.00</span></strong></span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span>Shipping:</span>
                                    <span><strong>$<span id="modal-shipping-cost">0.00</span></strong></span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding-top: 10px; border-top: 2px solid var(--border-color); font-size: 18px;">
                                    <span><strong>Total:</strong></span>
                                    <span style="color: var(--primary-red);"><strong>$<span id="modal-grand-total">0.00</span></strong></span>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Step 3: Payment Form -->
                    <div id="payment-view" style="display: none;">
                        <div id="payment-error" class="alert alert-error hidden" style="margin-bottom: 15px;"></div>
                        
                        <form id="payment-form-modal">
                            <div class="form-group">
                                <label class="form-label">Card Details *</label>
                                <div id="card-element-modal" style="padding: 12px; border: 2px solid #3a3a3a; border-radius: 6px; background: #0a0a0a;">
                                    <div style="text-align: center; padding: 20px; color: var(--text-muted);">
                                        <div class="spinner" style="margin: 0 auto 10px;"></div>
                                        Loading payment form...
                                    </div>
                                </div>
                            </div>

                            <div style="background: var(--neutral-gray-light); padding: 15px; border-radius: 6px; margin-top: 20px;">
                                <h4 style="margin: 0 0 15px 0; font-size: 14px; font-weight: 600;">Order Summary</h4>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px;">
                                    <span>Subtotal:</span>
                                    <span>$<span id="payment-subtotal">0.00</span></span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px;">
                                    <span>Shipping:</span>
                                    <span>$<span id="payment-shipping">0.00</span></span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding-top: 10px; border-top: 2px solid var(--border-color); font-size: 18px; font-weight: 600;">
                                    <span>Total:</span>
                                    <span style="color: var(--primary-red);">$<span id="payment-total">0.00</span></span>
                                </div>
                            </div>

                            <div class="alert alert-info" style="margin-top: 15px; font-size: 12px;">
                                üîí Your payment is secure and encrypted via Stripe
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="modal-footer" style="border-top: 2px solid var(--border-color); padding: 20px;">
                    <!-- Cart Step Footer -->
                    <div id="cart-footer">
                        <div class="cart-total" id="cart-total-section" style="display: none; margin-bottom: 15px;">
                            <span><strong>Subtotal:</strong></span>
                            <span><strong>$<span id="cart-total">0.00</span></strong></span>
                        </div>
                        <button class="btn btn-primary btn-block" onclick="goToShippingStep()" id="modal-next-btn" style="display: none;">
                            Next: Shipping Information ‚Üí
                        </button>
                    </div>

                    <!-- Shipping Step Footer -->
                    <div id="shipping-footer" style="display: none;">
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-secondary" onclick="goToCartStep()" style="flex: 1;">
                                ‚Üê Back to Cart
                            </button>
                            <button class="btn btn-primary" onclick="goToPaymentStep()" id="proceed-payment-btn" style="flex: 2;" disabled>
                                Proceed to Payment ‚Üí
                            </button>
                        </div>
                    </div>

                    <!-- Payment Step Footer -->
                    <div id="payment-footer" style="display: none;">
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-secondary" onclick="goToShippingStep()" style="flex: 1;">
                                ‚Üê Back to Shipping
                            </button>
                            <button type="button" class="btn btn-primary" onclick="submitPayment()" id="pay-btn" style="flex: 2;">
                                Save Card for $<span id="pay-amount">0.00</span> (Charged at Shipping)
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let cart = JSON.parse(sessionStorage.getItem('cart')) || [];
        let products = [];
        let heroBook = null; // Will hold the main book product
        let stripe = null;
        let elements = null;
        let cardElement = null;
        let paymentIntentClientSecret = null;

        // Load products
        async function loadProducts() {
            try {
                const response = await fetch('/api/addons');
                products = await response.json();
                
                // Find the hero pledge (The Benevolent Divya)
                heroBook = products.find(p => 
                    p.name.toLowerCase().includes('benevolent divya')
                );
                
                // If hero book found, update price in hero section
                if (heroBook) {
                    document.getElementById('hero-book-price').textContent = heroBook.price.toFixed(0);
                }
                
                // Load and display pledge tiers
                displayPledgeTiers();
                
                displayProducts();
                updateCart();
            } catch (error) {
                console.error('Error loading products:', error);
                document.getElementById('products-grid').innerHTML = `
                    <div style="text-align: center; padding: 40px; grid-column: 1 / -1;">
                        <p style="color: var(--error-red);">Failed to load products. Please refresh the page.</p>
                    </div>
                `;
            }
        }

        // Display pledge tiers (excluding hero)
        function displayPledgeTiers() {
            const pledgeNames = ['humble vaanar', 'industrious manushya', 'resplendent garuda', 'benevolent divya', 'founders of neh'];
            
            // Filter to show only pledge tiers, excluding the hero
            const pledgeTiers = products.filter(p => {
                const name = p.name.toLowerCase();
                // Include if it's a pledge tier
                if (pledgeNames.some(pledge => name.includes(pledge))) {
                    // Exclude the hero pledge (Benevolent Divya)
                    return !name.includes('benevolent divya');
                }
                return false;
            }).sort((a, b) => a.price - b.price); // Sort by price

            const grid = document.getElementById('pledge-tiers-grid');
            
            if (pledgeTiers.length === 0) {
                grid.innerHTML = `<div style="text-align: center; padding: 40px; grid-column: 1 / -1;"><p style="color: #ffffff;">No other pledge tiers available.</p></div>`;
                return;
            }

            grid.innerHTML = '';
            
            pledgeTiers.forEach(pledge => {
                const imagePath = `/images/pledges/${pledge.image}`;
                const card = document.createElement('div');
                card.style.cssText = 'background: #1e1e1e; border-radius: 16px; overflow: hidden; display: flex; flex-direction: column; transition: transform 0.3s ease, box-shadow 0.3s ease;';
                
                card.innerHTML = `
                    <div style="width: 100%; aspect-ratio: 1; background: #2c2c2c; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                        <img src="${imagePath}" alt="${pledge.name}" style="width: 100%; height: 100%; object-fit: contain;" loading="lazy" onerror="this.parentElement.innerHTML='<div style=\\'font-size: 64px;\\'>üì¶</div>'">
                    </div>
                    <div style="padding: 24px; flex: 1; display: flex; flex-direction: column;">
                        <h3 style="font-family: 'Inter', sans-serif; font-size: 22px; font-weight: 700; color: #ffffff; margin: 0 0 8px 0;">${pledge.name}</h3>
                        <p style="font-family: 'Inter', sans-serif; font-size: 15px; color: #a0a0a0; margin: 0 0 16px 0; flex: 1;">${pledge.description || 'Premium pledge tier with exclusive rewards'}</p>
                        <div style="font-family: 'Inter', sans-serif; font-size: 28px; font-weight: 700; color: #ffffff; margin-bottom: 16px;">$${pledge.price.toFixed(2)}</div>
                        <button onclick="addPledgeToCart(${pledge.id})" id="add-pledge-btn-${pledge.id}" style="background: #dc2626; color: white; border: none; padding: 14px; border-radius: 10px; font-family: 'Inter', sans-serif; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; width: 100%;">
                            Add to Cart
                        </button>
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }

        // Add pledge to cart
        function addPledgeToCart(pledgeId) {
            const pledge = products.find(p => p.id === pledgeId);
            if (!pledge) return;

            // Remove any existing pledges from cart
            const pledgeNames = ['humble vaanar', 'industrious manushya', 'resplendent garuda', 'benevolent divya', 'founders of neh'];
            cart = cart.filter(item => {
                const product = products.find(p => p.id === item.id);
                if (!product) return true;
                const name = product.name.toLowerCase();
                return !pledgeNames.some(pName => name.includes(pName));
            });

            // Add new pledge
            const cartItem = cart.find(item => item.id === pledgeId);
            if (!cartItem) {
                cart.push({
                    id: pledge.id,
                    name: pledge.name,
                    price: pledge.price,
                    weight: pledge.weight || 0,
                    quantity: 1
                });
            }

            // Update button
            const btn = document.getElementById(`add-pledge-btn-${pledgeId}`);
            if (btn) {
                btn.style.background = '#059669';
                btn.textContent = '‚úì Added';
                btn.disabled = true;
                btn.style.cursor = 'default';

                // Reset other pledge buttons
                const allPledges = products.filter(p => {
                    const name = p.name.toLowerCase();
                    return pledgeNames.some(pName => name.includes(pName));
                });
                allPledges.forEach(p => {
                    if (p.id !== pledgeId) {
                        const otherBtn = document.getElementById(`add-pledge-btn-${p.id}`);
                        if (otherBtn) {
                            otherBtn.style.background = '#dc2626';
                            otherBtn.textContent = 'Add to Cart';
                            otherBtn.disabled = false;
                            otherBtn.style.cursor = 'pointer';
                        }
                    }
                });
            }

            saveCart();
            updateCart();
        }

        // Hero section add to cart
        function addHeroBookToCart() {
            if (!heroBook) {
                alert('Book not available. Please refresh the page.');
                return;
            }

            // Check if book already in cart - don't add again
            const cartItem = cart.find(item => item.id === heroBook.id);
            if (cartItem) {
                // Already in cart, do nothing
                return;
            }

            // Add to cart
            cart.push({
                id: heroBook.id,
                name: heroBook.name,
                price: heroBook.price,
                weight: heroBook.weight,
                quantity: 1
            });

            // Trigger animation on the hero button
            const btn = document.getElementById('hero-add-btn');
            if (btn) {
                btn.classList.add('button-added');
                setTimeout(() => {
                    btn.classList.remove('button-added');
                }, 600);
            }

            updateCart();
        }

        // Update hero button state based on cart
        function updateHeroButton() {
            if (!heroBook) return;

            const btn = document.getElementById('hero-add-btn');
            const cartItem = cart.find(item => item.id === heroBook.id);

            if (cartItem) {
                // Book is in cart - show added state
                btn.textContent = '‚úì Added';
                btn.style.background = '#059669';
                btn.style.borderColor = '#059669';
                btn.style.cursor = 'default';
                btn.disabled = true;
            } else {
                // Book not in cart - show add button
                btn.textContent = 'Add to Cart';
                btn.style.background = '#dc2626';
                btn.style.borderColor = '#2c2c2c';
                btn.style.cursor = 'pointer';
                btn.disabled = false;
                btn.onclick = addHeroBookToCart;
            }
        }

        function displayProducts() {
            const grid = document.getElementById('products-grid');
            
            // Filter out the main book (hero product) - only show add-ons
            // Filter to show only add-ons (not pledge tiers or hero)
            const pledgeNames = ['humble vaanar', 'industrious manushya', 'resplendent garuda', 'benevolent divya', 'founders of neh'];
            const addOnsOnly = products.filter(p => 
                !pledgeNames.some(pledge => p.name.toLowerCase().includes(pledge))
            );
            
            if (addOnsOnly.length === 0) {
                grid.innerHTML = `
                    <div style="text-align: center; padding: 40px; grid-column: 1 / -1;">
                        <p style="color: #ffffff;">No add-ons available at this time.</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = '';
            
            addOnsOnly.forEach(product => {
                const card = document.createElement('div');
                card.id = `product-card-${product.id}`;
                card.style.cssText = 'display: flex; flex-direction: column; background: #1e1e1e; border-radius: 16px; min-height: 550px; position: relative; transition: all 0.3s ease;';
                
                const isInCart = cart.find(item => item.id === product.id);
                const cartItem = isInCart;
                const quantity = cartItem ? cartItem.quantity : 0;
                
                // Check if product is free
                const isFree = product.price === 0;
                const priceDisplay = isFree ? 'FREE' : `$${product.price.toFixed(0)}`;
                const priceColor = isFree ? '#4b944e' : '#ffffff';
                
                card.innerHTML = `
                    <!-- Product Image -->
                    <div style="background: #0a0a0a; border-radius: 12px; margin: 24px; height: 280px; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                        ${product.image ? `<img src="/images/addons/${product.image}" alt="${product.name}" loading="lazy" style="max-width: 100%; max-height: 100%; object-fit: contain;">` : '<div style="display: flex; align-items: center; justify-content: center; font-size: 64px;">üì¶</div>'}
                    </div>
                    
                    <!-- Product Description -->
                    <div style="padding: 0 24px; flex: 1;">
                        <p style="font-family: 'Inter', sans-serif; font-weight: 500; font-size: 18px; line-height: 1.4; color: #ffffff; margin: 0 0 20px 0;">${product.name}</p>
                    </div>
                    
                    <!-- Price and Quantity Controls -->
                    <div style="padding: 0 24px; margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <p style="font-family: 'Inter', sans-serif; font-weight: 700; font-size: 32px; line-height: 1; color: ${priceColor}; margin: 0;">${priceDisplay}</p>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <button onclick="decreaseCartQuantity(${product.id})" style="background: #828282; color: white; border: none; border-radius: 6px; padding: 0; font-family: 'Inter', sans-serif; font-weight: 600; font-size: 20px; cursor: pointer; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">‚àí</button>
                                <div style="background: #828282; color: white; border-radius: 6px; font-family: 'Inter', sans-serif; font-weight: 600; font-size: 18px; min-width: 50px; height: 36px; display: flex; align-items: center; justify-content: center;" id="qty-${product.id}">${quantity}</div>
                                <button onclick="increaseCartQuantity(${product.id})" style="background: #828282; color: white; border: none; border-radius: 6px; padding: 0; font-family: 'Inter', sans-serif; font-weight: 600; font-size: 20px; cursor: pointer; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">+</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Add to Cart Button -->
                    <button id="add-btn-${product.id}" onclick="${isInCart ? '' : 'addProductToCart(' + product.id + ')'}" style="background: ${isInCart ? '#059669' : '#dc2626'}; border: 1px solid ${isInCart ? '#059669' : '#dc2626'}; color: white; border-radius: 10px; padding: 14px; margin: 0 24px 24px 24px; font-family: 'Inter', sans-serif; font-weight: 600; font-size: 16px; cursor: ${isInCart ? 'default' : 'pointer'}; white-space: nowrap; transition: all 0.3s ease;" ${isInCart ? 'disabled' : ''}>
                        ${isInCart ? '‚úì Added' : 'Add to Cart'}
                    </button>
                `;
                grid.appendChild(card);
            });

        }

        function addProductToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            // Check if this is an add-on (not a pledge tier)
            const pledgeNames = ['humble vaanar', 'industrious manushya', 'resplendent garuda', 'benevolent divya', 'founders of neh'];
            const isAddon = !pledgeNames.some(pledge => product.name.toLowerCase().includes(pledge));
            
            // If it's an add-on, check if there's a pledge in the cart
            if (isAddon) {
                const hasPledge = cart.some(item => {
                    const cartProduct = products.find(p => p.id === item.id);
                    return cartProduct && pledgeNames.some(pledge => cartProduct.name.toLowerCase().includes(pledge));
                });
                
                if (!hasPledge) {
                    alert('Please select a pledge tier first before adding add-ons to your order.');
                    return;
                }
            }

            // Check if already in cart
            const cartItem = cart.find(item => item.id === productId);
            if (!cartItem) {
                // Add to cart with quantity 1
                cart.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    weight: product.weight,
                    quantity: 1
                });
            }

            // Trigger animation on the button
            const btn = document.getElementById(`add-btn-${productId}`);
            if (btn) {
                btn.classList.add('button-added');
                setTimeout(() => {
                    btn.classList.remove('button-added');
                }, 600);
            }

            updateCart();
        }

        // Cart modal specific quantity functions
        function increaseCartQuantity(productId) {
            let cartItem = cart.find(item => item.id === productId);
            if (cartItem) {
                cartItem.quantity++;
            } else {
                // Add to cart if not already there
                const product = products.find(p => p.id === productId);
                if (product) {
                    cart.push({
                        id: product.id,
                        name: product.name,
                        price: product.price,
                        weight: product.weight,
                        quantity: 1
                    });
                }
            }
            updateCart();
        }

        function decreaseCartQuantity(productId) {
            const cartItem = cart.find(item => item.id === productId);
            if (!cartItem) return;

            if (cartItem.quantity > 1) {
                cartItem.quantity--;
            } else {
                cart = cart.filter(item => item.id !== productId);
            }
            updateCart();
        }

        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            updateCart();
        }

        function updateCart() {
            sessionStorage.setItem('cart', JSON.stringify(cart));

            const cartItemsDiv = document.getElementById('cart-items');
            const totalSection = document.getElementById('cart-total-section');
            const cartBadge = document.getElementById('cart-count-badge');
            const floatingCheckout = document.getElementById('floating-checkout');
            const floatingTotal = document.getElementById('floating-total');
            const modalNextBtn = document.getElementById('modal-next-btn');
            
            // Update cart count badge
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            if (totalItems > 0) {
                cartBadge.textContent = totalItems;
                cartBadge.style.display = 'inline';
            } else {
                cartBadge.style.display = 'none';
            }
            
            // Calculate total
            let total = 0;
            cart.forEach(item => {
                total += item.price * item.quantity;
            });
            
            if (cart.length === 0) {
                cartItemsDiv.innerHTML = `
                    <p style="color: var(--text-muted); text-align: center; padding: 20px;">
                        Your cart is empty.
                    </p>
                `;
                totalSection.style.display = 'none';
                floatingCheckout.style.display = 'none';
                modalNextBtn.style.display = 'none';
            } else {
                let html = '';

                cart.forEach(item => {
                    const itemTotal = item.price * item.quantity;
                    html += `
                        <div class="cart-item" style="display: flex; justify-content: space-between; align-items: flex-start; padding: 15px; border-bottom: 1px solid var(--border-color);">
                            <div style="flex: 1;">
                                <strong>${item.name}</strong><br>
                                <small style="color: var(--text-muted);">$${item.price.toFixed(2)} each</small>
                                <div style="display: flex; gap: 8px; align-items: center; margin-top: 10px;">
                                    <div class="quantity-selector" style="display: inline-flex; align-items: center; border: 1px solid var(--border-color); border-radius: 4px; overflow: hidden;">
                                        <button onclick="decreaseCartQuantity(${item.id})" style="padding: 5px 10px; background: #1e1e1e; color: #ffffff; border: 1px solid #3a3a3a; cursor: pointer; font-size: 14px;">-</button>
                                        <span style="padding: 5px 12px; font-size: 14px; font-weight: 600; min-width: 30px; text-align: center; border-left: 1px solid var(--border-color); border-right: 1px solid var(--border-color);">${item.quantity}</span>
                                        <button onclick="increaseCartQuantity(${item.id})" style="padding: 5px 10px; background: #1e1e1e; color: #ffffff; border: 1px solid #3a3a3a; cursor: pointer; font-size: 14px;">+</button>
                                    </div>
                                    <button onclick="removeFromCart(${item.id})" style="padding: 5px 12px; background: var(--error-red); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600;">Remove</button>
                                </div>
                            </div>
                            <div style="text-align: right; font-weight: 600; font-size: 16px;">
                                $${itemTotal.toFixed(2)}
                            </div>
                        </div>
                    `;
                });

                cartItemsDiv.innerHTML = html;
                document.getElementById('cart-total').textContent = total.toFixed(2);
                floatingTotal.textContent = '$' + total.toFixed(2);
                totalSection.style.display = 'flex';
                floatingCheckout.style.display = 'block';
                document.getElementById('modal-next-btn').style.display = 'block';
            }

            // Update product card buttons and quantity displays
            products.forEach(product => {
                const cartItem = cart.find(item => item.id === product.id);
                const qtyDisplay = document.getElementById(`qty-${product.id}`);
                if (qtyDisplay) {
                    qtyDisplay.textContent = cartItem ? cartItem.quantity : 0;
                }

                const btn = document.getElementById(`add-btn-${product.id}`);
                if (btn) {
                    if (cartItem) {
                        btn.textContent = '‚úì Added';
                        btn.style.background = '#059669';
                        btn.style.borderColor = '#059669';
                        btn.style.cursor = 'default';
                        btn.disabled = true;
                        btn.onclick = null;
                    } else {
                        btn.textContent = 'Add to Cart';
                        btn.style.background = '#dc2626';
                        btn.style.borderColor = '#2c2c2c';
                        btn.style.cursor = 'pointer';
                        btn.disabled = false;
                        btn.onclick = () => addProductToCart(product.id);
                    }
                }
            });

            // Update hero button state
            updateHeroButton();
        }

        function scrollToCart() {
            window.location.href = '/addons';
        }

        function closeCartModal(event) {
            if (!event || event.target === event.currentTarget) {
                document.getElementById('cart-modal').style.display = 'none';
                // Reset to cart step when closing
                goToCartStep();
            }
        }

        function proceedToCheckout() {
            window.location.href = '/addons';
        }

        function openCartModal() {
            // Reset to cart step
            goToCartStep();
            document.getElementById('cart-modal').style.display = 'flex';
        }

        function goToShippingStep() {
            // Hide other views
            document.getElementById('cart-view').style.display = 'none';
            document.getElementById('cart-footer').style.display = 'none';
            document.getElementById('payment-view').style.display = 'none';
            document.getElementById('payment-footer').style.display = 'none';

            // Show shipping view
            document.getElementById('shipping-view').style.display = 'block';
            document.getElementById('shipping-footer').style.display = 'block';
            document.getElementById('modal-title').textContent = 'Shipping Information';

            // Update step indicators
            updateStepIndicator('shipping');

            // Populate subtotal
            let subtotal = 0;
            cart.forEach(item => {
                subtotal += item.price * item.quantity;
            });
            document.getElementById('modal-subtotal').textContent = subtotal.toFixed(2);
        }

        function goToCartStep() {
            // Show cart view
            document.getElementById('cart-view').style.display = 'block';
            document.getElementById('cart-footer').style.display = 'block';

            // Hide other views
            document.getElementById('shipping-view').style.display = 'none';
            document.getElementById('shipping-footer').style.display = 'none';
            document.getElementById('payment-view').style.display = 'none';
            document.getElementById('payment-footer').style.display = 'none';
            document.getElementById('modal-title').textContent = 'Your Cart';

            // Update step indicators
            updateStepIndicator('cart');
        }

        function updateStepIndicator(currentStep) {
            const steps = {
                cart: { num: 1, id: 'step-cart' },
                shipping: { num: 2, id: 'step-shipping' },
                payment: { num: 3, id: 'step-payment' }
            };

            Object.keys(steps).forEach(stepKey => {
                const step = steps[stepKey];
                const stepEl = document.getElementById(step.id);
                const circle = stepEl.querySelector('div:first-child');
                const label = stepEl.querySelector('div:last-child');

                if (steps[stepKey].num <= steps[currentStep].num) {
                    // Active or completed
                    circle.style.background = 'var(--primary-red)';
                    circle.style.color = 'white';
                    label.style.color = 'var(--text-dark)';
                } else {
                    // Inactive
                    circle.style.background = 'var(--border-color)';
                    circle.style.color = 'var(--text-muted)';
                    label.style.color = 'var(--text-muted)';
                }
            });
        }

        async function calculateModalShipping() {
            const country = document.getElementById('modal-country').value;
            if (!country) return;

            try {
                const response = await fetch('/api/guest/calculate-shipping', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ country, cartItems: cart })
                });

                const data = await response.json();
                
                if (data.shippingCost !== undefined) {
                    const shippingCost = data.shippingCost;
                    document.getElementById('modal-shipping-cost').textContent = shippingCost.toFixed(2);
                    
                    // Calculate grand total
                    let subtotal = 0;
                    cart.forEach(item => {
                        subtotal += item.price * item.quantity;
                    });
                    const grandTotal = subtotal + shippingCost;
                    document.getElementById('modal-grand-total').textContent = grandTotal.toFixed(2);

                    // Show shipping cost display
                    document.getElementById('shipping-cost-display').style.display = 'block';

                    // Enable proceed button
                    validateShippingForm();
                }
            } catch (error) {
                console.error('Error calculating shipping:', error);
                alert('Error calculating shipping. Please try again.');
            }
        }

        function validateShippingForm() {
            const form = document.getElementById('shipping-form-modal');
            const proceedBtn = document.getElementById('proceed-payment-btn');
            const country = document.getElementById('modal-country').value;
            const shippingCostDisplay = document.getElementById('shipping-cost-display').style.display;
            
            const isValid = form.checkValidity() && country && shippingCostDisplay !== 'none';
            proceedBtn.disabled = !isValid;
        }

        // Add input listeners for form validation
        document.addEventListener('DOMContentLoaded', function() {
            const formInputs = ['modal-name', 'modal-email', 'modal-address1', 'modal-city', 'modal-state', 'modal-postal', 'modal-country'];
            formInputs.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', validateShippingForm);
                    el.addEventListener('change', validateShippingForm);
                }
            });
        });

        async function goToPaymentStep() {
            // Hide shipping view
            document.getElementById('shipping-view').style.display = 'none';
            document.getElementById('shipping-footer').style.display = 'none';

            // Show payment view
            document.getElementById('payment-view').style.display = 'block';
            document.getElementById('payment-footer').style.display = 'block';
            document.getElementById('modal-title').textContent = 'Payment Information';

            // Update step indicators
            updateStepIndicator('payment');

            // Calculate totals
            let subtotal = 0;
            cart.forEach(item => {
                subtotal += item.price * item.quantity;
            });
            const shippingCost = parseFloat(document.getElementById('modal-shipping-cost').textContent);
            const total = subtotal + shippingCost;

            // Update payment summary
            document.getElementById('payment-subtotal').textContent = subtotal.toFixed(2);
            document.getElementById('payment-shipping').textContent = shippingCost.toFixed(2);
            document.getElementById('payment-total').textContent = total.toFixed(2);
            document.getElementById('pay-amount').textContent = total.toFixed(2);

            // Initialize Stripe if not already done
            if (!stripe) {
                await initializeStripe();
            }

            // Create payment intent
            await createPaymentIntent(total);
        }

        async function initializeStripe() {
            try {
                const response = await fetch('/api/stripe-key');
                const data = await response.json();
                
                if (!data.publishableKey || data.publishableKey.includes('YOUR_KEY_HERE')) {
                    throw new Error('Stripe not configured');
                }
                
                stripe = Stripe(data.publishableKey);
                elements = stripe.elements();
                cardElement = elements.create('card', {
                    style: {
                        base: {
                            fontSize: '16px',
                            color: '#1a1a1a',
                            '::placeholder': {
                                color: '#999'
                            }
                        }
                    }
                });
                cardElement.mount('#card-element-modal');
            } catch (error) {
                console.error('Error initializing Stripe:', error);
                document.getElementById('card-element-modal').innerHTML = `
                    <div style="padding: 15px; text-align: center; color: #ef4444; background: #fee2e2; border: 1px solid #ef4444; border-radius: 6px;">
                        <strong>Payment Not Available</strong><br>
                        <small>Stripe is not configured. Please contact support.</small>
                    </div>
                `;
                document.getElementById('pay-btn').disabled = true;
            }
        }

        async function createPaymentIntent(amount) {
            try {
                const shippingData = {
                    name: document.getElementById('modal-name').value,
                    email: document.getElementById('modal-email').value,
                    address1: document.getElementById('modal-address1').value,
                    address2: document.getElementById('modal-address2').value,
                    city: document.getElementById('modal-city').value,
                    state: document.getElementById('modal-state').value,
                    postal: document.getElementById('modal-postal').value,
                    country: document.getElementById('modal-country').value
                };

                const shippingCost = parseFloat(document.getElementById('modal-shipping-cost').textContent);

                const response = await fetch('/api/guest/create-payment-intent', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        amount: Math.max(amount, 0.50), // Stripe minimum
                        cartItems: cart,
                        shippingAddress: shippingData,
                        shippingCost: shippingCost,
                        customerEmail: shippingData.email
                    })
                });

                const data = await response.json();
                paymentIntentClientSecret = data.clientSecret;
            } catch (error) {
                console.error('Error creating payment intent:', error);
                alert('Error preparing payment. Please try again.');
            }
        }

        async function submitPayment() {
            const payBtn = document.getElementById('pay-btn');
            const originalText = payBtn.innerHTML;
            
            payBtn.disabled = true;
            payBtn.innerHTML = 'Saving Card Details...';

            try {
                // Use confirmCardSetup instead of confirmCardPayment to save card without charging
                const { error, setupIntent } = await stripe.confirmCardSetup(paymentIntentClientSecret, {
                    payment_method: {
                        card: cardElement,
                        billing_details: {
                            name: document.getElementById('modal-name').value,
                            email: document.getElementById('modal-email').value
                        }
                    }
                });

                if (error) {
                    throw new Error(error.message);
                }

                if (setupIntent.status === 'succeeded') {
                    // Save the payment method ID to the order
                    const saved = await savePaymentMethod(setupIntent.payment_method);
                    
                    if (!saved) {
                        throw new Error('Failed to save payment method');
                    }
                    
                    // Clear cart
                    cart = [];
                    sessionStorage.removeItem('cart');

                    // Close modal and redirect to thank you page
                    document.getElementById('cart-modal').style.display = 'none';
                    window.location.href = '/guest/thankyou';
                }
            } catch (error) {
                console.error('Card save error:', error);
                const errorDiv = document.getElementById('payment-error');
                errorDiv.textContent = error.message || 'Failed to save card. Please try again.';
                errorDiv.classList.remove('hidden');
                
                payBtn.disabled = false;
                payBtn.innerHTML = originalText;
            }
        }

        async function savePaymentMethod(paymentMethodId) {
            try {
                const shippingData = {
                    name: document.getElementById('modal-name').value,
                    email: document.getElementById('modal-email').value
                };

                const response = await fetch('/api/guest/save-payment-method', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        paymentMethodId: paymentMethodId,
                        customerEmail: shippingData.email
                    })
                });

                const data = await response.json();
                return response.ok && data.success;
            } catch (error) {
                console.error('Error saving payment method:', error);
                return false;
            }
        }

        function toggleProductDetails() {
            const content = document.getElementById('product-details-content');
            const arrow = document.getElementById('details-arrow');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.style.transform = 'rotate(180deg)';
            } else {
                content.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        loadProducts();

        // Smart navbar scroll behavior
        let lastScrollTop = 0;
        let navbarHeight = 50;
        const navbar = document.getElementById('navbar');
        
        window.addEventListener('scroll', function() {
            let scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            
            if (scrollTop > lastScrollTop && scrollTop > navbarHeight) {
                // Scrolling down - hide navbar
                navbar.style.transform = 'translateY(-100%)';
            } else {
                // Scrolling up - show navbar
                navbar.style.transform = 'translateY(0)';
            }
            
            lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;
        }, false);
    </script>
</body>
</html>
