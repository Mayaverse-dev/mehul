<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Order Confirmed - MAYA</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Roboto:wght@700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
        }

        .container {
            max-width: 645px;
            width: 100%;
        }

        .thank-you-card {
            background: #1e1e1e;
            border-radius: 16px;
            padding: 50px 45px;
            text-align: center;
        }

        .checkmark {
            width: 57px;
            height: 57px;
            margin: 0 auto 30px;
            background: #dc2626;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: white;
        }

        .title {
            font-size: 24px;
            font-weight: 600;
            color: #d4d4d4;
            margin-bottom: 20px;
        }

        .subtitle {
            font-size: 15px;
            font-weight: 500;
            color: #aaaaaa;
            margin-bottom: 8px;
        }

        .subtitle-light {
            font-size: 15px;
            font-weight: 500;
            color: #aaaaaa;
            margin-bottom: 40px;
        }

        .info-box {
            background: #2a2a2a;
            border-radius: 14px;
            padding: 35px 40px;
            text-align: left;
            margin-bottom: 40px;
        }

        .info-title {
            font-size: 20px;
            font-weight: 700;
            color: #d4d4d4;
            margin-bottom: 20px;
        }

        .info-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .info-list li {
            font-size: 20px;
            font-weight: 400;
            color: #d4d4d4;
            line-height: 1.5;
            margin-bottom: 12px;
            padding-left: 20px;
            position: relative;
        }

        .info-list li:before {
            content: "•";
            position: absolute;
            left: 0;
            color: #d4d4d4;
        }

        .info-list li:last-child {
            margin-bottom: 0;
        }

        .continue-btn {
            background: #d4d4d4;
            color: #000000;
            border: none;
            border-radius: 11px;
            padding: 16px 60px;
            font-size: 24px;
            font-weight: 700;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: all 0.2s;
            margin-bottom: 40px;
        }

        .continue-btn:hover {
            background: #e5e5e5;
            transform: translateY(-2px);
        }

        .secure-box {
            background: #2a2a2a;
            border-radius: 14px;
            padding: 28px 30px;
            margin-top: 30px;
            text-align: left;
        }

        .secure-title {
            font-size: 20px;
            font-weight: 700;
            color: #d4d4d4;
            margin-bottom: 10px;
        }

        .secure-subtitle {
            font-size: 14px;
            color: #aaaaaa;
            margin-bottom: 14px;
        }

        .secure-input {
            width: 100%;
            padding: 14px;
            border-radius: 10px;
            border: 2px solid #3a3a3a;
            background: #0a0a0a;
            color: #ffffff;
            margin-bottom: 12px;
        }

        .secure-btn {
            width: 100%;
            background: #dc2626;
            color: #ffffff;
            border: none;
            border-radius: 10px;
            padding: 14px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }

        .secure-hint {
            font-size: 13px;
            color: #9ca3af;
            margin-top: 6px;
        }

        .secure-error {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 13px;
            margin-bottom: 12px;
            display: none;
        }

        .support-text {
            font-size: 15px;
            font-weight: 600;
            color: #717171;
            line-height: 1.4;
            margin-bottom: 0;
        }

        .support-text a {
            color: #717171;
            text-decoration: none;
        }

        .support-text a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .thank-you-card {
                padding: 40px 30px;
            }

            .title {
                font-size: 22px;
            }

            .info-box {
                padding: 25px 20px;
            }

            .info-title,
            .info-list li {
                font-size: 18px;
            }

            .continue-btn {
                font-size: 20px;
                padding: 14px 50px;
            }
        }
    </style>
</head>
<body style="background: #0a0a0a !important; color: #ffffff !important;">
    <div class="container">
        <div class="thank-you-card">
            <div class="checkmark">✓</div>
            
            <h1 class="title">Pre-Order Confirmed!</h1>
            
            <p class="subtitle">Your card has been saved securely.</p>
            <p class="subtitle-light">You will be charged when your items ship.</p>

            <!-- Order Summary Section -->
            <div id="order-summary" class="info-box" style="display:none; margin-bottom: 30px;">
                <h2 class="info-title">Order Summary</h2>
                <div id="summary-content" style="font-size: 15px; color: #d4d4d4;">
                    <!-- Populated by JS -->
                </div>
            </div>

            <div class="info-box">
                <h2 class="info-title">What's Next?</h2>
                <ul class="info-list">
                    <li>You'll receive a confirmation email shortly</li>
                    <li>Your order will be prepared once all items are available</li>
                    <li>You'll receive an email notification when we charge your card</li>
                    <li>Shipping updates will be sent via email</li>
                </ul>
            </div>

            <div id="secure-box" class="secure-box" style="display:none;">
                <div id="secure-error" class="secure-error"></div>
                <h3 class="secure-title">Create a PIN for easy login</h3>
                <p class="secure-subtitle">Save your details for next time. We'll send a quick code to verify.</p>

                <div id="secure-email-step">
                    <input type="email" id="secure-email" class="secure-input" placeholder="your@email.com" autocomplete="email">
                    <button id="secure-email-btn" class="secure-btn">Send Code</button>
                </div>

                <div id="secure-otp-step" style="display:none;">
                    <p class="secure-subtitle">Enter the 4-digit code we sent you.</p>
                    <input type="text" id="secure-otp" class="secure-input" placeholder="1234" maxlength="4" inputmode="numeric" pattern="[0-9]*">
                    <button id="secure-otp-btn" class="secure-btn">Verify Code</button>
                    <p class="secure-hint"><button id="secure-resend-btn" class="secure-btn" style="margin-top:10px; background:#0a0a0a; border:2px solid #3a3a3a;">Resend Code</button></p>
                </div>

                <div id="secure-pin-step" style="display:none;">
                    <p class="secure-subtitle">Set a 6-digit PIN for quick login.</p>
                    <input type="password" id="secure-pin" class="secure-input" placeholder="••••••" maxlength="6" inputmode="numeric" pattern="[0-9]*">
                    <button id="secure-pin-btn" class="secure-btn">Save PIN</button>
                </div>
            </div>

            <a href="#" id="continue-btn" class="continue-btn">Continue Shopping</a>

            <p class="support-text">
                Questions? Contact us for support regarding your order on<br>
                <a href="mailto:hello@entermaya.com">hello@entermaya.com</a>
            </p>
        </div>
    </div>

    <script>
        // Clear cart after successful order
        sessionStorage.removeItem('cart');

        // Check if user is logged in and redirect accordingly
        async function setupContinueButton() {
            const continueBtn = document.getElementById('continue-btn');
            
            try {
                const response = await fetch('/api/user/data');
                if (response.ok) {
                    // User is logged in - go to dashboard
                    continueBtn.href = '/dashboard';
                    document.getElementById('secure-box').style.display = 'none';
                } else {
                    // Guest - go to store homepage
                    continueBtn.href = '/';
                    document.getElementById('secure-box').style.display = 'block';
                }
            } catch (error) {
                // Default to store homepage
                continueBtn.href = '/';
                document.getElementById('secure-box').style.display = 'block';
            }
        }

        setupContinueButton();

        // Load Order Summary
        async function loadOrderSummary() {
            try {
                const res = await fetch('/api/order/summary');
                if (!res.ok) return; // No summary available (maybe expired session or direct access)
                
                const data = await res.json();
                const summaryDiv = document.getElementById('order-summary');
                const contentDiv = document.getElementById('summary-content');
                
                // Format items
                let itemsHtml = '<div style="margin-bottom: 15px;">';
                data.items.forEach(item => {
                    itemsHtml += `<div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span>${item.quantity}x ${item.name}</span>
                        <span>$${(item.price * item.quantity).toFixed(2)}</span>
                    </div>`;
                });
                itemsHtml += '</div>';

                // Format address
                const addr = data.shippingAddress;
                const addressHtml = `<div style="margin-bottom: 15px; padding: 10px; background: #1e1e1e; border-radius: 8px;">
                    <div style="font-weight:600; margin-bottom:5px; color:#fff;">Shipping Address</div>
                    ${addr.fullName}<br>
                    ${addr.addressLine1}${addr.addressLine2 ? ', ' + addr.addressLine2 : ''}<br>
                    ${addr.city}, ${addr.state} ${addr.postalCode}<br>
                    ${addr.country}
                </div>`;

                // Format totals
                const totalsHtml = `<div style="border-top: 1px solid #444; padding-top: 10px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span>Subtotal</span>
                        <span>$${data.addonsSubtotal.toFixed(2)}</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span>Shipping</span>
                        <span>$${data.shippingCost.toFixed(2)}</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; font-weight:700; font-size: 18px; color:#fff; margin-top:10px;">
                        <span>Total</span>
                        <span>$${data.total.toFixed(2)}</span>
                    </div>
                </div>`;

                contentDiv.innerHTML = itemsHtml + addressHtml + totalsHtml;
                summaryDiv.style.display = 'block';
            } catch (err) {
                console.error('Error loading summary:', err);
            }
        }
        loadOrderSummary();

        // Guest -> Create PIN flow
        (function setupSecureBox() {
            const box = document.getElementById('secure-box');
            const errorEl = document.getElementById('secure-error');
            const emailInput = document.getElementById('secure-email');
            const emailBtn = document.getElementById('secure-email-btn');
            const otpInput = document.getElementById('secure-otp');
            const otpBtn = document.getElementById('secure-otp-btn');
            const resendBtn = document.getElementById('secure-resend-btn');
            const pinInput = document.getElementById('secure-pin');
            const pinBtn = document.getElementById('secure-pin-btn');
            const emailStep = document.getElementById('secure-email-step');
            const otpStep = document.getElementById('secure-otp-step');
            const pinStep = document.getElementById('secure-pin-step');

            let currentEmail = '';

            function showError(msg) {
                errorEl.textContent = msg || 'Something went wrong';
                errorEl.style.display = 'block';
            }
            function clearError() {
                errorEl.style.display = 'none';
            }
            function showStage(stage) {
                emailStep.style.display = stage === 'email' ? 'block' : 'none';
                otpStep.style.display = stage === 'otp' ? 'block' : 'none';
                pinStep.style.display = stage === 'pin' ? 'block' : 'none';
            }

            async function initiate(email) {
                clearError();
                try {
                    const res = await fetch('/api/auth/initiate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email })
                    });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.error || 'Failed to send code');
                    if (data.status === 'otp_sent') {
                        showStage('otp');
                    } else {
                        // Even if PIN required, allow user to pick PIN flow from here by forcing OTP
                        showStage('otp');
                    }
                } catch (err) {
                    showError(err.message);
                }
            }

            emailBtn.addEventListener('click', async () => {
                clearError();
                const email = (emailInput.value || '').trim().toLowerCase();
                if (!email) {
                    showError('Email is required');
                    return;
                }
                currentEmail = email;
                await initiate(email);
            });

            otpBtn.addEventListener('click', async () => {
                clearError();
                const code = (otpInput.value || '').trim();
                if (!/^[0-9]{4}$/.test(code)) {
                    showError('Code must be 4 digits');
                    return;
                }
                try {
                    const res = await fetch('/api/auth/verify-otp', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: currentEmail, otp: code })
                    });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.error || 'Invalid code');
                    if (data.requiresPin) {
                        showStage('pin');
                    } else {
                        window.location.href = data.redirect || '/dashboard';
                    }
                } catch (err) {
                    showError(err.message);
                }
            });

            resendBtn.addEventListener('click', async () => {
                if (!currentEmail) {
                    showError('Enter your email first');
                    return;
                }
                await initiate(currentEmail);
            });

            pinBtn.addEventListener('click', async () => {
                clearError();
                const pin = (pinInput.value || '').trim();
                if (!/^[0-9]{6}$/.test(pin)) {
                    showError('PIN must be 6 digits');
                    return;
                }
                try {
                    const res = await fetch('/api/auth/set-pin', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ pin })
                    });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.error || 'Failed to save PIN');
                    window.location.href = data.redirect || '/dashboard';
                } catch (err) {
                    showError(err.message);
                }
            });

            // Start hidden; display controlled in setupContinueButton
            showStage('email');
        })();
    </script>
</body>
</html>
