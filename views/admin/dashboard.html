<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin Dashboard - MAYA Pledge Manager</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div>
                <h1>üîê Admin Dashboard</h1>
                <p>MAYA Pledge Manager Administration</p>
            </div>
            <div class="user-info">
                <a href="/admin/logout" style="color: white;">Logout</a>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="stat-backers">-</div>
                <div class="stat-label">Total Backers</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-completed">-</div>
                <div class="stat-label">Completed Orders</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-pending">-</div>
                <div class="stat-label">Pending Orders</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-revenue">$0</div>
                <div class="stat-label">Total Revenue</div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div style="margin-bottom: 20px; border-bottom: 2px solid var(--border-color);">
            <button class="tab-btn active" onclick="showTab('users')">Users</button>
            <button class="tab-btn" onclick="showTab('orders')">Orders</button>
        </div>

        <!-- Users Tab -->
        <div id="users-tab" class="tab-content">
            <div class="card">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3 class="card-title">All Backers</h3>
                        <p class="card-subtitle">Manage Kickstarter backers</p>
                    </div>
                    <button class="btn btn-secondary" onclick="exportUsers()">
                        üì• Export CSV
                    </button>
                </div>

                <div class="table-responsive admin-table-container">
                    <table class="table admin-table">
                        <thead>
                            <tr>
                                <th>Backer #</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Reward Tier</th>
                                <th>Pledge Amount</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 40px;">
                                    <div class="spinner"></div>
                                    <p style="color: var(--text-muted); margin-top: 20px;">Loading users...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Orders Tab -->
        <div id="orders-tab" class="tab-content" style="display: none;">
            <div class="card">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3 class="card-title">All Orders</h3>
                        <p class="card-subtitle">Manage pledge manager orders</p>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" onclick="exportOrders()">
                            üì• Export CSV
                        </button>
                        <button class="btn btn-primary" onclick="bulkChargeOrders()" style="background: var(--success-green);">
                            üí≥ Bulk Charge All
                        </button>
                    </div>
                </div>

                <div class="table-responsive admin-table-container">
                    <table class="table admin-table">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Backer</th>
                                <th>Email</th>
                                <th>Total</th>
                                <th>Payment Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table-body">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px;">
                                    <div class="spinner"></div>
                                    <p style="color: var(--text-muted); margin-top: 20px;">Loading orders...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <style>
        .tab-btn {
            padding: 12px 24px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: var(--text-muted);
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            color: var(--primary-red);
        }

        .tab-btn.active {
            color: var(--primary-red);
            border-bottom-color: var(--primary-red);
        }

        .tab-content {
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>

    <script>
        // Load statistics
        async function loadStats() {
            try {
                const response = await fetch('/api/admin/stats');
                const stats = await response.json();

                document.getElementById('stat-backers').textContent = stats.totalBackers || 0;
                document.getElementById('stat-completed').textContent = stats.completedOrders || 0;
                document.getElementById('stat-pending').textContent = stats.pendingOrders || 0;
                document.getElementById('stat-revenue').textContent = '$' + (stats.totalRevenue || 0).toFixed(2);
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load users
        async function loadUsers() {
            try {
                const response = await fetch('/api/admin/users');
                const users = await response.json();

                const tbody = document.getElementById('users-table-body');
                
                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--text-muted);">No users found</td></tr>';
                    return;
                }

                tbody.innerHTML = users.map(user => `
                    <tr>
                        <td>${user.backer_number || '-'}</td>
                        <td>${user.backer_name || '-'}</td>
                        <td>${user.email}</td>
                        <td>${user.reward_title || '-'}</td>
                        <td>$${(user.pledge_amount || 0).toFixed(2)}</td>
                        <td>
                            ${user.has_completed 
                                ? '<span class="badge badge-success">Completed</span>' 
                                : '<span class="badge badge-pending">Pending</span>'}
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // Load orders
        async function loadOrders() {
            try {
                const response = await fetch('/api/admin/orders');
                const orders = await response.json();

                const tbody = document.getElementById('orders-table-body');
                
                if (orders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-muted);">No orders yet</td></tr>';
                    return;
                }

                tbody.innerHTML = orders.map(order => {
                    // Determine payment status badge
                    let statusBadge;
                    if (order.payment_status === 'charged' || order.paid === 1) {
                        statusBadge = '<span class="badge badge-success">üí≥ Charged</span>';
                    } else if (order.payment_status === 'card_saved') {
                        statusBadge = '<span class="badge" style="background: #3b82f6; color: white;">üíæ Card Saved</span>';
                    } else if (order.payment_status === 'charge_failed') {
                        statusBadge = '<span class="badge badge-error">‚ùå Failed</span>';
                    } else {
                        statusBadge = '<span class="badge badge-pending">‚è≥ Pending</span>';
                    }
                    
                    // Show "Charge" button if card is saved but not yet charged
                    const actionButtons = `
                        <button class="btn btn-small" onclick="openOrderModal(${order.id})" style="margin-right: 5px;">View</button>
                        ${order.payment_status === 'card_saved' && !order.paid 
                            ? `<button class="btn btn-small" style="background: var(--success-green); color: white;" onclick="chargeCustomer(${order.id}, ${(order.total || 0).toFixed(2)})">üí≥ Charge</button>` 
                            : ''}
                    `;
                    
                    return `
                        <tr>
                            <td>#${order.id}</td>
                            <td>${order.backer_name || '-'} (#${order.backer_number || '-'})</td>
                            <td>${order.email}</td>
                            <td>$${(order.total || 0).toFixed(2)}</td>
                            <td>${statusBadge}</td>
                            <td>${new Date(order.created_at).toLocaleDateString()}</td>
                            <td>${actionButtons}</td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading orders:', error);
            }
        }

        // Tab switching
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });

            // Remove active class from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + '-tab').style.display = 'block';
            event.target.classList.add('active');

            // Load data if needed
            if (tabName === 'orders') {
                loadOrders();
            }
        }

        // Export functions
        function exportUsers() {
            window.location.href = '/api/admin/export/users';
        }

        function exportOrders() {
            window.location.href = '/api/admin/export/orders';
        }

        // Charge a customer's saved card
        async function chargeCustomer(orderId, amount) {
            if (!confirm(`Are you sure you want to charge $${amount} to this customer's saved card?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/charge-order/${orderId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    alert(`‚úÖ Success! Charged $${amount}\n\nPayment Intent: ${data.paymentIntentId}`);
                    // Reload orders to show updated status
                    loadOrders();
                } else {
                    alert(`‚ùå Failed to charge card:\n${data.error}`);
                }
            } catch (error) {
                console.error('Error charging customer:', error);
                alert('‚ùå Error processing charge. Please try again.');
            }
        }

        // Bulk charge all orders with saved cards
        async function bulkChargeOrders() {
            const confirmation = confirm(
                '‚ö†Ô∏è BULK CHARGE ALL ORDERS\n\n' +
                'This will charge ALL customers who have saved cards.\n\n' +
                'Are you sure you want to proceed?'
            );

            if (!confirmation) return;

            // Show loading state
            const bulkBtn = event.target;
            const originalText = bulkBtn.innerHTML;
            bulkBtn.disabled = true;
            bulkBtn.innerHTML = '‚è≥ Processing...';

            try {
                const response = await fetch('/api/admin/bulk-charge-orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    // Create detailed results message
                    let message = `‚úÖ BULK CHARGE COMPLETE\n\n`;
                    message += `Total Orders: ${data.total}\n`;
                    message += `‚úÖ Successfully Charged: ${data.charged}\n`;
                    message += `‚ùå Failed: ${data.failed}\n\n`;

                    if (data.details.charged.length > 0) {
                        message += `Successful Charges:\n`;
                        data.details.charged.forEach(item => {
                            message += `  ‚Ä¢ Order #${item.orderId} - ${item.email} - $${item.amount.toFixed(2)}\n`;
                        });
                        message += `\n`;
                    }

                    if (data.details.failed.length > 0) {
                        message += `Failed Charges:\n`;
                        data.details.failed.forEach(item => {
                            message += `  ‚Ä¢ Order #${item.orderId} - ${item.email} - $${item.amount.toFixed(2)}\n`;
                            message += `    Error: ${item.error}\n`;
                        });
                    }

                    alert(message);
                    
                    // Reload orders to show updated statuses
                    loadOrders();
                } else {
                    alert(`‚ùå Bulk charge failed:\n${data.error}`);
                }
            } catch (error) {
                console.error('Error during bulk charge:', error);
                alert('‚ùå Error processing bulk charge. Please try again.');
            } finally {
                // Restore button
                bulkBtn.disabled = false;
                bulkBtn.innerHTML = originalText;
            }
        }

        // Modal logic for editing comped items
        let compedState = [];

        function openOrderModal(orderId) {
            const overlay = document.getElementById('order-modal-overlay');
            const body = document.getElementById('comped-items-body');
            const orderSummary = document.getElementById('order-summary-section');
            document.getElementById('order-id-field').value = orderId;
            compedState = [];
            body.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;"><div class="spinner"></div></td></tr>';
            orderSummary.innerHTML = '<div style="text-align:center; padding:20px;"><div class="spinner"></div></div>';
            overlay.style.display = 'flex';
            fetch(`/api/admin/orders/${orderId}`)
                .then(res => res.json())
                .then(order => {
                    // Render order summary
                    renderOrderSummary(order);
                    // Load comped items
                    compedState = Array.isArray(order.comped_items) ? order.comped_items.map(i=>({ name:i.name||'', quantity:i.quantity||1, note:i.note||'' })) : [];
                    renderCompedRows();
                })
                .catch(() => {
                    body.innerHTML = '<tr><td colspan="4" style="color:var(--error-red); text-align:center;">Failed to load order</td></tr>';
                    orderSummary.innerHTML = '<div style="color:var(--error-red); padding:20px;">Failed to load order</div>';
                });
        }

        function renderOrderSummary(order) {
            const section = document.getElementById('order-summary-section');
            const addons = Array.isArray(order.new_addons) ? order.new_addons : [];
            const address = order.shipping_address || {};
            
            let addonsHtml = '';
            if (addons.length === 0) {
                addonsHtml = '<p style="color:var(--text-muted); font-style:italic;">No add-ons purchased</p>';
            } else {
                addonsHtml = '<ul style="list-style:none; padding:0; margin:0;">';
                addons.forEach(item => {
                    addonsHtml += `<li style="padding:8px 0; border-bottom:1px solid var(--border-color);">
                        <strong>${item.name}</strong> √ó ${item.quantity} 
                        <span style="float:right; color:var(--primary-red);">$${(item.price * item.quantity).toFixed(2)}</span>
                    </li>`;
                });
                addonsHtml += '</ul>';
            }
            
            section.innerHTML = `
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">
                    <div>
                        <h4 style="margin:0 0 12px 0; color:var(--primary-red);">Add-ons Purchased</h4>
                        ${addonsHtml}
                    </div>
                    <div>
                        <h4 style="margin:0 0 12px 0; color:var(--primary-red);">Shipping Address</h4>
                        <div style="background:var(--neutral-beige-light); padding:12px; border-radius:6px; font-size:14px;">
                            ${address.fullName || 'N/A'}<br>
                            ${address.addressLine1 || ''}<br>
                            ${address.addressLine2 ? address.addressLine2 + '<br>' : ''}
                            ${address.city || ''}, ${address.state || ''} ${address.postalCode || ''}<br>
                            ${address.country || ''}<br>
                            <strong>Phone:</strong> ${address.phone || 'N/A'}
                        </div>
                    </div>
                </div>
                <div style="background:var(--neutral-beige-light); padding:16px; border-radius:6px; margin-bottom:20px;">
                    <div style="display:flex; justify-content:space-between; padding:8px 0;">
                        <span>Add-ons Subtotal:</span>
                        <strong>$${(order.addons_subtotal || 0).toFixed(2)}</strong>
                    </div>
                    <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:2px solid var(--border-color);">
                        <span>Shipping Cost:</span>
                        <strong>$${(order.shipping_cost || 0).toFixed(2)}</strong>
                    </div>
                    <div style="display:flex; justify-content:space-between; padding:12px 0; font-size:18px;">
                        <span><strong>Total Paid:</strong></span>
                        <strong style="color:var(--primary-red);">$${(order.total || 0).toFixed(2)}</strong>
                    </div>
                    <div style="margin-top:8px; font-size:12px; color:var(--text-muted);">
                        Order Date: ${new Date(order.created_at).toLocaleString()}<br>
                        Status: ${order.paid ? '<span style="color:green;">‚úì Paid</span>' : '<span style="color:orange;">Pending</span>'}
                        ${order.stripe_payment_intent_id ? `<br>Stripe ID: ${order.stripe_payment_intent_id}` : ''}
                    </div>
                </div>
            `;
        }

        function closeOrderModal() {
            document.getElementById('order-modal-overlay').style.display = 'none';
        }

        function renderCompedRows() {
            const body = document.getElementById('comped-items-body');
            if (compedState.length === 0) {
                body.innerHTML = '';
                return;
            }
            body.innerHTML = compedState.map((it, idx) => `
                <tr>
                    <td><input class=\"form-input\" value=\"${it.name}\" data-idx=\"${idx}\" data-field=\"name\" /></td>
                    <td style=\"width:120px\"><input class=\"form-input\" type=\"number\" min=\"1\" value=\"${it.quantity}\" data-idx=\"${idx}\" data-field=\"quantity\" /></td>
                    <td><input class=\"form-input\" value=\"${it.note || ''}\" data-idx=\"${idx}\" data-field=\"note\" /></td>
                    <td style=\"width:100px\"><button class=\"btn btn-secondary btn-small\" onclick=\"removeCompedRow(${idx})\">Remove</button></td>
                </tr>
            `).join('');
            attachInputSync();
        }

        function attachInputSync() {
            document.querySelectorAll('#comped-items-body input').forEach(inp => {
                inp.addEventListener('input', () => {
                    const idx = parseInt(inp.getAttribute('data-idx'), 10);
                    const field = inp.getAttribute('data-field');
                    compedState[idx] = compedState[idx] || { name:'', quantity:1, note:'' };
                    compedState[idx][field] = field === 'quantity' ? Math.max(1, parseInt(inp.value || '1', 10)) : inp.value;
                });
            });
        }

        function addCompedRow() {
            compedState.push({ name:'', quantity:1, note:'' });
            renderCompedRows();
        }

        function removeCompedRow(i) {
            compedState.splice(i, 1);
            renderCompedRows();
        }

        async function saveCompedItems() {
            const orderId = document.getElementById('order-id-field').value;
            // ensure state sync
            compedState = Array.from(document.querySelectorAll('#comped-items-body tr')).map(tr => {
                const inputs = tr.querySelectorAll('input');
                return { name: inputs[0].value.trim(), quantity: parseInt(inputs[1].value || '1', 10), note: inputs[2].value.trim() };
            });
            const res = await fetch(`/api/admin/orders/${orderId}/comped-items`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ compedItems: compedState })
            });
            if (res.ok) {
                closeOrderModal();
                loadOrders();
            } else {
                alert('Failed to save changes');
            }
        }

        // Initialize
        loadStats();
        loadUsers();
    </script>

    <!-- Edit Order Modal -->
    <div id="order-modal-overlay" class="modal-overlay" style="display:none;">
        <div class="modal" style="max-width:900px; max-height:90vh; overflow:hidden; display:flex; flex-direction:column;">
            <div class="modal-header">
                <h3>Order Details & Management</h3>
                <button class="modal-close" onclick="closeOrderModal()">√ó</button>
            </div>
            <div class="modal-body" style="overflow-y:auto; flex:1;">
                <input type="hidden" id="order-id-field" />
                
                <!-- Order Summary Section -->
                <div id="order-summary-section" style="margin-bottom:30px;">
                    <!-- Will be populated by JS -->
                </div>

                <!-- Comped Items Section -->
                <div style="border-top:2px solid var(--border-color); padding-top:20px;">
                    <h4 style="margin:0 0 12px 0; color:var(--primary-red);">Add Free Items (Comped)</h4>
                    <div class="alert alert-info" style="margin-bottom:12px; font-size:14px;">
                        üí° Items added here are free gifts and do not affect totals or shipping costs.
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Item Name</th>
                                <th style="width:120px;">Quantity</th>
                                <th>Note</th>
                                <th style="width:100px;"></th>
                            </tr>
                        </thead>
                        <tbody id="comped-items-body"></tbody>
                    </table>
                    <button class="btn btn-secondary" onclick="addCompedRow()">+ Add Comped Item</button>
                </div>
            </div>
            <div class="modal-footer" style="display:flex; gap:8px; justify-content:flex-end;">
                <button class="btn btn-primary" onclick="saveCompedItems()">Save Changes</button>
                <button class="btn btn-secondary" onclick="closeOrderModal()">Close</button>
            </div>
        </div>
    </div>

    <style>
        .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.4); display:flex; align-items:center; justify-content:center; z-index:1000; }
        .modal { background:white; border-radius:8px; width:90%; max-width:700px; box-shadow:0 10px 30px rgba(0,0,0,0.2); }
        .modal-header { display:flex; align-items:center; justify-content:space-between; padding:16px 20px; border-bottom:2px solid var(--border-color); }
        .modal-body { padding:16px 20px; max-height:60vh; overflow:auto; }
        .modal-footer { padding:12px 20px; border-top:2px solid var(--border-color); }
        .modal-close { background:none; border:none; font-size:22px; cursor:pointer; }
        .btn-small { padding:6px 10px; font-size:12px; }
    </style>
</body>
</html>

